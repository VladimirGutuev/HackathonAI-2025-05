#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã RAG
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def test_rag_system():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã RAG"""
    print("üî¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã RAG...")
    
    try:
        from historical_rag import HistoricalRAG
        print("‚úÖ –ú–æ–¥—É–ª—å historical_rag —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã RAG
        rag = HistoricalRAG()
        print("‚úÖ –°–∏—Å—Ç–µ–º–∞ RAG –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–Ω–µ–≤–Ω–∏–∫–∞
        test_diary = """
        15 —è–Ω–≤–∞—Ä—è 1943 –≥–æ–¥–∞. –°–µ–≥–æ–¥–Ω—è –Ω–∞—à–∞ –¥–∏–≤–∏–∑–∏—è –ø–æ–ª—É—á–∏–ª–∞ –ø—Ä–∏–∫–∞–∑ –Ω–∞—Å—Ç—É–ø–∞—Ç—å –Ω–∞ –°—Ç–∞–ª–∏–Ω–≥—Ä–∞–¥. 
        –ù–µ–º–µ—Ü–∫–∏–µ –≤–æ–π—Å–∫–∞ —É–∫—Ä–µ–ø–∏–ª–∏—Å—å –≤ –≥–æ—Ä–æ–¥–µ, –Ω–æ –º—ã –≥–æ—Ç–æ–≤—ã –∫ –±–æ—é. 
        –¢–æ–≤–∞—Ä–∏—â –ò–≤–∞–Ω–æ–≤ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª –æ –±–æ—è—Ö –ø–æ–¥ –ú–æ—Å–∫–≤–æ–π –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É.
        """
        
        print(f"üìù –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç: {test_diary[:100]}...")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        print("\nüîç –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
        context = rag.get_historical_context_dict(test_diary)
        
        print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:")
        print(f"   - –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {context.get('found_items', 0)}")
        print(f"   - –¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {context.get('context_type', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        
        if context.get('context_items'):
            print(f"   - –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç: {context['context_items'][0].get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}")
        
        if context.get('summary'):
            print(f"   - –†–µ–∑—é–º–µ: {context['summary'][:100]}...")
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        print("\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:")
        stats = rag.get_database_stats()
        for key, value in stats.items():
            print(f"   - {key}: {value}")
        
        print("\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        return True
        
    except ImportError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
        print("üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install scikit-learn numpy scipy")
        return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        return False

def test_war_diary_analyzer():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–º –¥–Ω–µ–≤–Ω–∏–∫–æ–≤"""
    print("\nüî¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–º...")
    
    try:
        from war_diary_analyzer import WarDiaryAnalyzer
        print("‚úÖ –ú–æ–¥—É–ª—å war_diary_analyzer –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
        
        analyzer = WarDiaryAnalyzer()
        print("‚úÖ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å RAG
        if hasattr(analyzer, 'rag') and analyzer.rag:
            print("‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä")
        else:
            print("‚ö†Ô∏è RAG —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        test_diary = "–°–µ–≥–æ–¥–Ω—è –º—ã –æ–±–æ—Ä–æ–Ω—è–ª–∏ –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥ –æ—Ç –Ω–µ–º–µ—Ü–∫–∏—Ö –≤–æ–π—Å–∫. –ë–ª–æ–∫–∞–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤."
        
        print(f"üìù –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º...")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–∞
        if hasattr(analyzer, 'analyze_emotions_with_context'):
            print("‚úÖ –ú–µ—Ç–æ–¥ analyze_emotions_with_context –¥–æ—Å—Ç—É–ø–µ–Ω")
            # –ú–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ —ç—Ç–æ –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è –∏–∑-–∑–∞ API –≤—ã–∑–æ–≤–æ–≤
            print("üí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å")
        else:
            print("‚ùå –ú–µ—Ç–æ–¥ analyze_emotions_with_context –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: {e}")
        return False

if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã RAG\n")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º RAG —Å–∏—Å—Ç–µ–º—É
    rag_success = test_rag_system()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
    analyzer_success = test_war_diary_analyzer()
    
    print(f"\nüìã –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print(f"   - RAG —Å–∏—Å—Ç–µ–º–∞: {'‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç' if rag_success else '‚ùå –û—à–∏–±–∫–∞'}")
    print(f"   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: {'‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç' if analyzer_success else '‚ùå –û—à–∏–±–∫–∞'}")
    
    if rag_success and analyzer_success:
        print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã! –°–∏—Å—Ç–µ–º–∞ RAG –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.")
    else:
        print("\n‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ.") 