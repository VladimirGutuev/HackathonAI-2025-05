{% extends "base.html" %}

{% block title %}Администрирование - Анализатор военных дневников{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-gear"></i> Администрирование системы
            </h1>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-music-note"></i> Муз. треки</h5>
                    <h2>{{ track_count }}</h2>
                    <p class="card-text">Всего треков</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-image"></i> Изображения</h5>
                    <h2>{{ image_count }}</h2>
                    <p class="card-text">Всего изображений</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-file-text"></i> Лит. произв.</h5>
                    <h2>{{ literary_works_count }}</h2>
                    <p class="card-text">Сохранено произведений</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-database"></i> RAG система</h5>
                    <p class="mt-3"><a href="{{ url_for('rag_stats') }}" class="btn btn-sm btn-light">Статистика RAG</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление треками -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-music-note-list"></i> Управление музыкальными треками
                    </h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-warning me-2" onclick="cleanupTracks('incomplete')">
                            <i class="bi bi-trash"></i> Удалить незавершенные
                        </button>
                        <button class="btn btn-secondary me-2" onclick="cleanupTracks('old')">
                            <i class="bi bi-calendar-x"></i> Удалить старые (>7 дней)
                        </button>
                        <button class="btn btn-danger" onclick="cleanupTracks('all')" 
                                data-bs-toggle="modal" data-bs-target="#confirmModal">
                            <i class="bi bi-trash3"></i> Удалить все треки
                        </button>
                    </div>
                    
                    <div id="cleanup-result" class="alert" style="display: none;"></div>
                    
                    <!-- Список треков -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Статус</th>
                                    <th>Стиль</th>
                                    <th>Создан</th>
                                    <th>Аудио</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for track in tracks %}
                                <tr>
                                    <td>
                                        <code>{{ track.task_id[:8] }}...</code>
                                    </td>
                                    <td>{{ track.title[:50] }}{% if track.title|length > 50 %}...{% endif %}</td>
                                    <td>
                                        {% if track.status == 'complete' %}
                                            <span class="badge bg-success">{{ track.status }}</span>
                                        {% elif track.status == 'processing' %}
                                            <span class="badge bg-warning">{{ track.status }}</span>
                                        {% elif track.status == 'error' %}
                                            <span class="badge bg-danger">{{ track.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ track.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ track.style }}</td>
                                    <td>
                                        {% if track.created_at %}
                                            {{ track.created_at[:19] }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if track.has_audio %}
                                            <i class="bi bi-check-circle text-success"></i>
                                        {% else %}
                                            <i class="bi bi-x-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="deleteTrack('{{ track.task_id }}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление Изображениями -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-card-image"></i> Управление изображениями ({{ image_count }})
                    </h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-danger" onclick="deleteAllImages()" 
                                data-bs-toggle="modal" data-bs-target="#confirmDeleteImagesModal">
                            <i class="bi bi-trash3"></i> Удалить все изображения
                        </button>
                    </div>
                    
                    <div id="cleanup-images-result" class="alert" style="display: none;"></div>
                    
                    <!-- Список изображений -->
                    {% if images %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Изображение</th>
                                    <th>Имя файла</th>
                                    <th>Размер файла</th>
                                    <th>Дата создания</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for image in images %}
                                <tr>
                                    <td>
                                        <img src="{{ image.url }}" alt="{{ image.filename }}" style="max-width: 100px; max-height: 100px;">
                                    </td>
                                    <td>{{ image.filename }}</td>
                                    <td>{{ image.size_kb }} KB</td>
                                    <td>{{ image.created_at }}</td>
                                    <td>
                                        <form method="POST" action="{{ url_for('delete_image_admin', filename=image.filename) }}" 
                                              style="display: inline;" onsubmit="return confirm('Удалить это изображение?');">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>Нет изображений для отображения в <code>static/generated_images/</code>.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Управление Литературными Произведениями -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-book"></i> Управление литературными произведениями ({{ literary_works_count }})
                    </h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-danger" onclick="deleteAllLiteraryWorks()" 
                                data-bs-toggle="modal" data-bs-target="#confirmDeleteWorksModal">
                            <i class="bi bi-trash3"></i> Удалить все произведения
                        </button>
                    </div>
                    
                    <div id="cleanup-works-result" class="alert" style="display: none;"></div>
                    
                    <!-- Список произведений -->
                    {% if literary_works %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Имя файла</th>
                                    <th>Сниппет</th>
                                    <th>Дата создания</th>
                                    <th>User ID</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for work in literary_works %}
                                <tr>
                                    <td><code>{{ work.txt_filename }}</code></td>
                                    <td>
                                        <small class="text-muted">{{ work.snippet }}...</small>
                                    </td>
                                    <td>{{ work.created_at_human }}</td>
                                    <td>
                                        {% if work.user_id %}
                                            {{ work.user_id }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('view_literary_work', filename=work.txt_filename) }}" class="btn btn-sm btn-info">
                                            <i class="bi bi-eye"></i> Просмотреть
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_literary_work_admin', file_id=work.file_id) }}" style="display:inline;" onsubmit="return confirm('Вы уверены, что хотите удалить это произведение?');">
                                            <button type="submit" class="btn btn-sm btn-danger ms-1">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>Нет сохраненных литературных произведений в <code>instance/generated_literary_works/</code>.</p>
                    <p>Произведения сохраняются автоматически при их генерации через основной интерфейс.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Тестирование изображений -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-image"></i> Тестирование генерации изображений
                    </h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="test-text" class="form-label">Тестовый текст:</label>
                        <textarea class="form-control" id="test-text" rows="3" 
                                  placeholder="Введите текст для тестирования генерации изображения">Солдат идет по полю после битвы, вокруг разрушенные здания</textarea>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-primary me-2" onclick="testImageGeneration()">
                            <i class="bi bi-image"></i> Тестировать генерацию
                        </button>
                        <button class="btn btn-secondary" onclick="testSafeImageGeneration()">
                            <i class="bi bi-shield-check"></i> Тестировать безопасную генерацию
                        </button>
                    </div>
                    
                    <div id="image-test-result" style="display: none;">
                        <div id="image-test-loading" class="text-center mb-3" style="display: none;">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Генерация изображения...</p>
                        </div>
                        <div id="image-test-error" class="alert alert-danger" style="display: none;"></div>
                        <div id="image-test-success" class="text-center" style="display: none;">
                            <img id="test-image" class="img-fluid rounded shadow" style="max-width: 500px;" />
                            <p class="mt-2 text-success">Изображение успешно сгенерировано!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние изображения -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-images"></i> Последние сгенерированные изображения
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row" id="recent-images">
                        <!-- Изображения будут загружены через JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Управление пользователями и генерациями -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-people-fill"></i> Управление пользователями и их генерациями
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Поиск пользователя -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="user-search" placeholder="Введите имя пользователя">
                                <button class="btn btn-primary" onclick="searchUser()">Найти</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info" onclick="showAllUsersStats()">
                                <i class="bi bi-bar-chart"></i> Статистика всех пользователей
                            </button>
                        </div>
                    </div>
                    
                    <!-- Результаты поиска -->
                    <div id="user-search-results" style="display: none;">
                        <hr>
                        <div id="user-info"></div>
                        <div id="user-generations" class="mt-4"></div>
                        <div id="user-storage-info" class="mt-3"></div>
                    </div>
                    
                    <!-- Общая статистика -->
                    <div id="all-users-stats" style="display: none;">
                        <hr>
                        <h5><i class="bi bi-graph-up"></i> Общая статистика системы</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 id="total-users">0</h3>
                                        <p class="mb-0">Пользователей</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 id="total-generations">0</h3>
                                        <p class="mb-0">Генераций</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 id="total-storage">0 MB</h3>
                                        <p class="mb-0">Используется памяти</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 id="avg-storage">0 MB</h3>
                                        <p class="mb-0">В среднем на пользователя</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Таблица пользователей с их статистикой -->
                        <div class="mt-4">
                            <h6>Топ пользователей по использованию:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped" id="users-stats-table">
                                    <thead>
                                        <tr>
                                            <th>Пользователь</th>
                                            <th>Генераций</th>
                                            <th>Текстов</th>
                                            <th>Изображений</th>
                                            <th>Музыки</th>
                                            <th>Память</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Активные пользователи -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-circle-fill text-light" style="font-size: 0.8em;"></i> Активные пользователи
                    </h4>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="text-muted mb-0">Пользователи, активные за последние 30 минут</p>
                        <button class="btn btn-outline-success btn-sm" onclick="refreshActiveUsers()">
                            <i class="bi bi-arrow-clockwise"></i> Обновить
                        </button>
                    </div>
                    
                    <div id="active-users-content">
                        <div class="text-center">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-2">Загрузка активных пользователей...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Настройки автоудаления -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-clock-history"></i> Настройки автоматической очистки
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Автоудаление старых генераций</h5>
                            <p class="text-muted">Настройте, через сколько дней автоматически удалять генерации</p>
                            
                            <div class="mb-3">
                                <label class="form-label">Текстовые произведения:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="text-retention-days" value="30" min="1" max="365">
                                    <span class="input-group-text">дней</span>
                                    <button class="btn btn-success btn-sm" onclick="saveRetentionSettings('text')">
                                        <i class="bi bi-save"></i> Сохранить
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Изображения:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="image-retention-days" value="14" min="1" max="365">
                                    <span class="input-group-text">дней</span>
                                    <button class="btn btn-success btn-sm" onclick="saveRetentionSettings('image')">
                                        <i class="bi bi-save"></i> Сохранить
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Музыкальные треки:</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="music-retention-days" value="7" min="1" max="365">
                                    <span class="input-group-text">дней</span>
                                    <button class="btn btn-success btn-sm" onclick="saveRetentionSettings('music')">
                                        <i class="bi bi-save"></i> Сохранить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Статус автоочистки</h5>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Автоочистка запускается ежедневно в 3:00 ночи
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-check">
                                    <input type="checkbox" class="form-check-input" id="auto-cleanup-enabled" checked>
                                    <span class="form-check-label">Автоочистка включена</span>
                                </label>
                            </div>
                            
                            <button class="btn btn-warning" onclick="runManualCleanup()">
                                <i class="bi bi-play-circle"></i> Запустить очистку сейчас
                            </button>
                            
                            <div id="cleanup-status" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления треков -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите удалить все треки? Это действие нельзя отменить.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="confirmCleanupAll()">Удалить все</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления изображений -->
<div class="modal fade" id="confirmDeleteImagesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите удалить ВСЕ изображения? Это действие нельзя отменить.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAllImages()">Удалить все изображения</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления произведений -->
<div class="modal fade" id="confirmDeleteWorksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Вы уверены, что хотите удалить ВСЕ литературные произведения? Это действие нельзя отменить.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAllWorks()">Удалить все произведения</button>
            </div>
        </div>
    </div>
</div>

<script>
// Функция очистки треков
function cleanupTracks(type) {
    const resultDiv = document.getElementById('cleanup-result');
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-info';
    resultDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Выполняется очистка...';
    
    fetch('/cleanup_music_tracks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
            // Перезагружаем страницу через 2 секунды
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${data.error}`;
        }
    })
    .catch(error => {
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${error.message}`;
    });
}

// Подтверждение удаления всех треков
function confirmCleanupAll() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
    modal.hide();
    cleanupTracks('all');
}

// Удаление отдельного трека
function deleteTrack(taskId) {
    if (!confirm('Удалить этот трек?')) return;
    
    fetch(`/delete_music_track/${taskId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Трек удален');
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error.message);
    });
}

// Тестирование генерации изображений
function testImageGeneration() {
    const text = document.getElementById('test-text').value;
    if (!text.trim()) {
        alert('Введите текст для тестирования');
        return;
    }
    
    const resultDiv = document.getElementById('image-test-result');
    const loadingDiv = document.getElementById('image-test-loading');
    const errorDiv = document.getElementById('image-test-error');
    const successDiv = document.getElementById('image-test-success');
    
    // Показываем результат и загрузку
    resultDiv.style.display = 'block';
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    fetch('/generate_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            emotion_analysis: null
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            const img = document.getElementById('test-image');
            img.src = data.image_url;
            successDiv.style.display = 'block';
        } else {
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Ошибка: ' + data.error;
        }
    })
    .catch(error => {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Ошибка: ' + error.message;
    });
}

// Тестирование безопасной генерации
function testSafeImageGeneration() {
    const text = document.getElementById('test-text').value;
    if (!text.trim()) {
        alert('Введите текст для тестирования');
        return;
    }
    
    const resultDiv = document.getElementById('image-test-result');
    const loadingDiv = document.getElementById('image-test-loading');
    const errorDiv = document.getElementById('image-test-error');
    const successDiv = document.getElementById('image-test-success');
    
    // Показываем результат и загрузку
    resultDiv.style.display = 'block';
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    fetch('/generate_safe_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            diary_text: text
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingDiv.style.display = 'none';
        
        if (data.success) {
            const img = document.getElementById('test-image');
            img.src = data.image_url;
            successDiv.style.display = 'block';
        } else {
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Ошибка: ' + data.error;
        }
    })
    .catch(error => {
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Ошибка: ' + error.message;
    });
}

// Загрузка последних изображений
function loadRecentImages() {
    // Здесь можно добавить загрузку последних изображений
    // Пока оставим заглушку
    const container = document.getElementById('recent-images');
    container.innerHTML = '<div class="col-12"><p class="text-muted">Функция в разработке</p></div>';
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadRecentImages();
});

// Функции для изображений
function deleteAllImages() {
    // Не делаем ничего, ждем подтверждения из модального окна
}

function confirmDeleteAllImages() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteImagesModal'));
    modal.hide();
    
    const resultDiv = document.getElementById('cleanup-images-result');
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-info';
    resultDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Удаление всех изображений...';
    
    fetch('/delete_all_images', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${data.error}`;
        }
    })
    .catch(error => {
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${error.message}`;
    });
}

// Функции для произведений
function deleteAllLiteraryWorks() {
    // Не делаем ничего, ждем подтверждения из модального окна
}

function confirmDeleteAllWorks() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteWorksModal'));
    modal.hide();
    
    const resultDiv = document.getElementById('cleanup-works-result');
    resultDiv.style.display = 'block';
    resultDiv.className = 'alert alert-info';
    resultDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Удаление всех произведений...';
    
    fetch('/delete_all_literary_works', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message}`;
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${data.error}`;
        }
    })
    .catch(error => {
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Ошибка: ${error.message}`;
    });
}

// Функция поиска пользователя
function searchUser() {
    const username = document.getElementById('user-search').value.trim();
    if (!username) {
        alert('Введите имя пользователя');
        return;
    }
    
    const resultsDiv = document.getElementById('user-search-results');
    const userInfoDiv = document.getElementById('user-info');
    const generationsDiv = document.getElementById('user-generations');
    const storageDiv = document.getElementById('user-storage-info');
    
    resultsDiv.style.display = 'block';
    userInfoDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div>';
    
    fetch(`/admin/api/user/${username}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                const generations = data.generations;
                const storage = data.storage;
                
                // Информация о пользователе
                userInfoDiv.innerHTML = `
                    <h5><i class="bi bi-person-circle"></i> ${user.username}</h5>
                    <p class="mb-1">ID: ${user.id}</p>
                    <p class="mb-1">Зарегистрирован: ${new Date(user.created_at).toLocaleDateString()}</p>
                    <p class="mb-1">Статус: ${user.is_admin ? '<span class="badge bg-danger">Администратор</span>' : '<span class="badge bg-primary">Пользователь</span>'}</p>
                `;
                
                // Генерации пользователя
                generationsDiv.innerHTML = `
                    <h6>Генерации пользователя (${generations.total}):</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>${generations.text}</h5>
                                    <p class="mb-0">Текстов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>${generations.image}</h5>
                                    <p class="mb-0">Изображений</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>${generations.music}</h5>
                                    <p class="mb-0">Музыки</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-warning btn-sm" onclick="clearUserGenerations(${user.id}, 'all')">
                            <i class="bi bi-trash"></i> Очистить все генерации
                        </button>
                        <a href="/admin/user/${user.id}/generations" class="btn btn-info btn-sm ms-2">
                            <i class="bi bi-list-ul"></i> Подробный список
                        </a>
                    </div>
                `;
                
                // Информация о памяти
                storageDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-hdd"></i> Использование памяти: <strong>${storage.total_mb} MB</strong>
                        <ul class="mb-0 mt-2">
                            <li>Тексты: ${storage.text_mb} MB</li>
                            <li>Изображения: ${storage.image_mb} MB</li>
                            <li>Музыка: ${storage.music_mb} MB</li>
                        </ul>
                    </div>
                `;
            } else {
                userInfoDiv.innerHTML = `<div class="alert alert-warning">Пользователь "${username}" не найден</div>`;
                generationsDiv.innerHTML = '';
                storageDiv.innerHTML = '';
            }
        })
        .catch(error => {
            userInfoDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
        });
}

// Показать статистику всех пользователей
function showAllUsersStats() {
    const statsDiv = document.getElementById('all-users-stats');
    statsDiv.style.display = 'block';
    
    fetch('/admin/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем общую статистику
                document.getElementById('total-users').textContent = data.stats.total_users;
                document.getElementById('total-generations').textContent = data.stats.total_generations;
                document.getElementById('total-storage').textContent = data.stats.total_storage_mb + ' MB';
                document.getElementById('avg-storage').textContent = data.stats.avg_storage_mb + ' MB';
                
                // Заполняем таблицу пользователей
                const tbody = document.querySelector('#users-stats-table tbody');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.total_generations}</td>
                        <td>${user.text_count}</td>
                        <td>${user.image_count}</td>
                        <td>${user.music_count}</td>
                        <td>${user.storage_mb} MB</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('user-search').value='${user.username}'; searchUser();">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                });
            }
        })
        .catch(error => {
            alert('Ошибка загрузки статистики: ' + error.message);
        });
}

// Сохранение настроек удержания
function saveRetentionSettings(type) {
    const days = document.getElementById(`${type}-retention-days`).value;
    
    fetch('/admin/api/retention-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            days: parseInt(days)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Настройки сохранены');
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error.message);
    });
}

// Ручной запуск очистки
function runManualCleanup() {
    if (!confirm('Запустить очистку старых файлов согласно текущим настройкам?')) {
        return;
    }
    
    const statusDiv = document.getElementById('cleanup-status');
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Выполняется очистка...</div>';
    
    fetch('/admin/api/manual-cleanup', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Очистка завершена
                    <ul class="mb-0 mt-2">
                        <li>Удалено текстов: ${data.deleted.text}</li>
                        <li>Удалено изображений: ${data.deleted.image}</li>
                        <li>Удалено треков: ${data.deleted.music}</li>
                        <li>Освобождено памяти: ${data.freed_mb} MB</li>
                    </ul>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
    });
}

// Очистка генераций пользователя
function clearUserGenerations(userId, type) {
    if (!confirm(`Удалить ${type === 'all' ? 'все' : type} генерации пользователя?`)) {
        return;
    }
    
    fetch(`/admin/api/user/${userId}/clear-generations`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Удалено генераций: ${data.deleted_count}`);
            // Обновляем информацию о пользователе
            const username = document.getElementById('user-search').value;
            if (username) {
                searchUser();
            }
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error.message);
    });
}

// Функции для работы с активными пользователями
function refreshActiveUsers() {
    const contentDiv = document.getElementById('active-users-content');
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Обновление...</p>
        </div>
    `;
    
    fetch('/admin/api/active-users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayActiveUsers(data);
            } else {
                contentDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${data.error}</div>`;
            }
        })
        .catch(error => {
            contentDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
        });
}

function displayActiveUsers(data) {
    const contentDiv = document.getElementById('active-users-content');
    
    if (data.total_active === 0) {
        contentDiv.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-people" style="font-size: 3rem;"></i>
                <p class="mt-2">Нет активных пользователей</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-success">${data.total_active}</h5>
                        <p class="mb-0">Всего активных</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-primary">${data.active_users.length}</h5>
                        <p class="mb-0">Зарегистрированных</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-secondary">${data.anonymous_count}</h5>
                        <p class="mb-0">Анонимных</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (data.active_users.length > 0) {
        html += `
            <h6><i class="bi bi-person-check"></i> Зарегистрированные пользователи:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Пользователь</th>
                            <th>Последняя активность</th>
                            <th>Текущие страницы</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.active_users.forEach(user => {
            const lastActivity = new Date(user.last_activity);
            const timeAgo = Math.round((new Date() - lastActivity) / 1000 / 60);
            const pages = user.pages.slice(0, 3).join(', ') + (user.pages.length > 3 ? '...' : '');
            
            html += `
                <tr>
                    <td>
                        <i class="bi bi-circle-fill text-success" style="font-size: 0.6em;"></i>
                        ${user.username}
                    </td>
                    <td>
                        <small>${timeAgo} мин. назад</small>
                    </td>
                    <td>
                        <small class="text-muted">${pages || 'Неизвестно'}</small>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('user-search').value='${user.username}'; searchUser();">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    contentDiv.innerHTML = html;
}

// Автообновление активных пользователей каждые 30 секунд
setInterval(refreshActiveUsers, 30000);

// Загружаем активных пользователей при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    refreshActiveUsers();
});
</script>
{% endblock %} 