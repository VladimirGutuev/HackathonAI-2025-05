<style>
/* КРИТИЧЕСКИ ВАЖНЫЕ СТИЛИ ДЛЯ ОТОБРАЖЕНИЯ АУДИОПЛЕЕРА */
audio {
    display: block !important;
    width: 100% !important;
    min-height: 50px !important;
    max-height: 50px !important;
    visibility: visible !important;
    opacity: 1 !important;
    background-color: #f0f0f0 !important;
    border: 3px solid #ff6600 !important;
    margin: 15px 0 !important;
    position: relative !important;
    z-index: 9999 !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
}

.audio-player-container {
    display: block !important;
    position: relative !important;
    background-color: #fff8e1 !important;
    border: 2px solid #ff8c00 !important;
    padding: 15px !important;
    margin: 15px 0 !important;
    z-index: 9998 !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.music-section {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    margin: 20px 0 !important;
    padding: 15px !important;
    background-color: #ffffe0 !important;
    border: 1px solid #ffd700 !important;
}

#generated-music-container {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Обеспечение видимости контейнеров с музыкой */
#music-results {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Стили для резервного плеера */
.backup-player {
    background-color: #fff0f0 !important;
    border: 3px solid #ff0000 !important;
    border-radius: 8px !important;
    padding: 15px !important;
    margin: 20px 0 !important;
    display: block !important;
}

.backup-player h4 {
    color: #ff0000 !important;
    margin-bottom: 15px !important;
    font-weight: bold !important;
}

.backup-player audio {
    border-color: #ff0000 !important;
}

/* Стили для кнопки скачивания */
.download-audio-btn {
    display: inline-block !important;
    background-color: #28a745 !important;
    color: white !important;
    font-weight: bold !important;
    padding: 10px 20px !important;
    border-radius: 5px !important;
    text-decoration: none !important;
    margin-top: 10px !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
    transition: all 0.3s ease !important;
}

.download-audio-btn:hover {
    background-color: #218838 !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
    transform: translateY(-2px) !important;
}

/* Стили для улучшения видимости плеера */
.music-section {
    display: block !important; /* Гарантированно отображать секцию */
    margin-top: 20px;
    margin-bottom: 20px;
}

.audio-player-container {
    border: 2px solid #f0ad4e;
    border-radius: 8px;
    background-color: #fffaf0;
    padding: 15px !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

audio {
    width: 100%;
    max-width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-radius: 6px;
    display: block !important;
}

#generated-music-container {
    display: block !important;
}
</style>

{% extends "base.html" %}

{% block title %}Анализатор военных дневников{% endblock %}

{% block content %}
<div class="row">
    <!-- Анализатор дневников -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h2>Анализ военного дневника</h2>
            </div>
            <div class="card-body">
                <form id="diary-form">
                    <div class="mb-3">
                        <label for="diary_text" class="form-label">Введите текст дневника:</label>
                        <textarea class="form-control" id="diary_text" name="diary_text" rows="10" required></textarea>
                    </div>
                    
                    <!-- Добавляем выбор типов генерации -->
                    <div class="mb-3">
                        <label class="form-label">Что вы хотите сгенерировать?</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_text" value="text" checked>
                                <label class="form-check-label" for="generation_text">
                                    <i class="bi bi-file-text"></i> Художественный текст
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_image" value="image">
                                <label class="form-check-label" for="generation_image">
                                    <i class="bi bi-image"></i> Иллюстрация
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_music" value="music">
                                <label class="form-check-label" for="generation_music">
                                    <i class="bi bi-music-note-beamed"></i> Музыка
                                </label>
                            </div>
                            <div class="ms-3">
                                <button type="button" id="select-all-btn" class="btn btn-sm btn-outline-secondary">Выбрать всё</button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Анализировать текст</button>
                </form>

                <div id="results" class="mt-4" style="display: none;">
                    <h3 class="mb-4">Результаты анализа</h3>
                    
                    <!-- Эмоциональный анализ с улучшенным дизайном -->
                    <div class="card mb-4 border-0 shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="m-0"><i class="bi bi-graph-up"></i> Эмоциональный анализ</h4>
                        </div>
                        <div class="card-body" id="emotion-results">
                            <div class="emotion-analysis-container">
                                <!-- Здесь будет содержимое эмоционального анализа -->
                            </div>
                        </div>
                    </div>
                    
                                        <!-- Содержимое генерации будет отображаться далее -->
                    
                    <!-- Контейнеры для результатов генерации -->
                    <div id="generated-content" style="display: none;">
                        <div class="card mb-4 border-0 shadow literary-section" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h4 class="m-0"><i class="bi bi-file-text"></i> Художественное произведение</h4>
                            </div>
                            <div class="card-body" id="literary-results"></div>
                        </div>
                        
                        <div class="card mb-4 border-0 shadow image-section" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h4 class="m-0"><i class="bi bi-image"></i> Иллюстрация</h4>
                            </div>
                            <div class="card-body" id="image-results">
                                <div id="generated-image-container" class="text-center mb-3" style="display: none;">
                                    <img id="generated-image" class="img-fluid rounded shadow" alt="Сгенерированная иллюстрация" />
                                </div>
                                <div id="image-loading" style="display: none;">
                                    <p class="text-muted">Генерация изображения...</p>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div id="image-error" class="alert alert-danger" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <div class="card mb-4 border-0 shadow music-section">                            <div class="card-header bg-warning text-dark">                                <h4 class="m-0"><i class="bi bi-music-note-beamed"></i> Музыкальное сопровождение</h4>                            </div>                            <div class="card-body" id="music-results">                                <div id="generated-music-container" class="text-center mb-3">
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="music-iframe" src="" title="Сгенерированная музыка" allowfullscreen></iframe>
                                    </div>
                                    <div class="mb-3">
                                        <h5>Описание музыки:</h5>
                                        <p id="music-description" class="text-muted font-italic"></p>
                                    </div>
                                </div>
                                <div id="music-loading" style="display: none;">
                                    <p class="text-muted">Генерация музыки...</p>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div id="music-error" class="alert alert-danger" style="display: none;">
                                    <span id="music-error-text"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                    <button id="share-results" class="btn btn-primary mt-3" style="display: none;">
                        <i class="bi bi-share-fill"></i> Поделиться на форуме
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Форум -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="mb-0">Форум</h3>
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('new_topic') }}" class="btn btn-primary btn-sm">Новая тема</a>
                    {% endif %}
                </div>
                <div class="btn-group btn-group-sm w-100">
                    <a href="{{ url_for('index', sort='date') }}" 
                       class="btn btn-outline-secondary {% if current_sort == 'date' %}active{% endif %}">
                        По дате
                    </a>
                    <a href="{{ url_for('index', sort='likes') }}" 
                       class="btn btn-outline-secondary {% if current_sort == 'likes' %}active{% endif %}">
                        По рейтингу
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if topics %}
                    <div class="list-group">
                    {% for topic in topics %}
                        <a href="{{ url_for('view_topic', topic_id=topic.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ topic.title }}</h5>
                                <small>{{ topic.created_at.strftime('%d.%m.%Y') }}</small>
                            </div>
                            <small>Автор: {{ topic.author.username }}</small>
                        </a>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Пока нет тем на форуме.</p>
                {% endif %}

                {% if not current_user.is_authenticated %}
                    <div class="alert alert-info mt-3">
                        <a href="{{ url_for('login') }}">Войдите</a> или 
                        <a href="{{ url_for('register') }}">зарегистрируйтесь</a> 
                        чтобы создать тему
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lastAnalysisResults = null;

// Функция обработки отправки формы
document.addEventListener('DOMContentLoaded', function() {
    const diaryForm = document.getElementById('diary-form');
    
    if (diaryForm) {
        diaryForm.addEventListener('submit', async function(e) {
            // Явно предотвращаем стандартное поведение формы
            e.preventDefault();
            
            // Проверяем, что выбран хотя бы один тип генерации
            const selectedTypes = Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value);
            if (selectedTypes.length === 0) {
                alert('Выберите хотя бы один тип генерации');
                return;
            }
            
            // Защита от повторной отправки
            if (this.classList.contains('processing')) {
                console.log('Форма уже обрабатывается');
                return;
            }
            
            this.classList.add('processing');
            
            // Находим кнопку отправки
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = 'Анализируем...';
            }
            
            // Создаем элемент для отображения статуса
            let statusElement = null;
            try {
                statusElement = document.createElement('div');
                statusElement.className = 'alert alert-info mt-3';
                statusElement.innerHTML = 'Запрос отправлен. Ожидайте ответа (это может занять до 30-60 секунд)...';
                this.appendChild(statusElement);
            } catch (err) {
                console.warn('Не удалось создать элемент статуса:', err);
            }
            
            try {
                console.log('Отправка запроса на /analyze...');
                
                // Устанавливаем таймаут для fetch с использованием AbortController
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты таймаут
                
                const formData = new FormData(this);
                
                // Передаем данные через URLSearchParams
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId); // Отменяем таймаут, если ответ получен
                
                console.log('Получен ответ:', response.status, response.statusText);
                
                // Обновляем статус если элемент существует
                if (statusElement && statusElement.parentNode) {
                    statusElement.className = 'alert alert-success mt-3';
                    statusElement.textContent = 'Ответ получен, обрабатываем результаты...';
                }
                
                // Проверяем, что ответ можно преобразовать в JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Ошибка: Сервер вернул не JSON:', contentType);
                    throw new Error('Сервер вернул не JSON ответ');
                }
                
                const text = await response.text();
                console.log('Текст ответа:', text.substring(0, 100) + '...'); // Логируем только начало
                
                let data;
                try {
                    data = JSON.parse(text);
                    console.log('Данные получены успешно');
                } catch (jsonError) {
                    console.error('Ошибка парсинга JSON:', jsonError);
                    throw new Error('Невозможно распарсить JSON');
                }
                
                if (response.ok) {
                    // Удаляем статусный элемент, если он существует и является дочерним
                    try {
                        if (statusElement && statusElement.parentNode === this) {
                            this.removeChild(statusElement);
                        }
                    } catch (e) {
                        console.warn('Не удалось удалить статусный элемент:', e);
                    }
                    
                    // Сохраняем результаты для возможной публикации
                    const diaryText = document.getElementById('diary_text');
                    lastAnalysisResults = {
                        diary_text: diaryText ? diaryText.value : '',
                        emotion_analysis: data.emotion_analysis || {},
                        generated_literary_work: data.generated_literary_work || '',
                        generation_types: Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value)
                    };
                    
                    // Безопасно обращаемся к элементам DOM
                    const resultsElement = document.getElementById('results');
                    if (resultsElement) {
                        resultsElement.style.display = 'block';
                    }
                    
                    const shareElement = document.getElementById('share-results');
                    if (shareElement) {
                        shareElement.style.display = 'block';
                    }
                    
                    // Обновляем отображение секций результатов на основе выбранных типов генерации
                    updateGenerationUI();
                    
                    // Показываем секцию сгенерированного контента
                    const generatedContentElement = document.getElementById('generated-content');
                    if (generatedContentElement) {
                        generatedContentElement.style.display = 'block';
                    }
                    
                    // Отображаем результаты эмоционального анализа
                    const emotionResults = document.getElementById('emotion-results');
                    if (emotionResults) {
                        const emotions = data.emotion_analysis || {};
                        let emotionHtml = '<div class="emotion-analysis">';
                        
                        if (emotions.primary_emotions && Array.isArray(emotions.primary_emotions)) {
                            emotionHtml += '<p><strong>Основные эмоции:</strong></p><ul>';
                            emotions.primary_emotions.forEach(emotion => {
                                if (emotion && emotion.emotion) {
                                    emotionHtml += `<li>${emotion.emotion}: ${emotion.intensity || '?'}/10</li>`;
                                }
                            });
                            emotionHtml += '</ul>';
                        }
                        
                        if (emotions.emotional_tone) {
                            emotionHtml += `<p><strong>Общий тон:</strong> ${emotions.emotional_tone}</p>`;
                        }
                        
                        if (emotions.hidden_motives && Array.isArray(emotions.hidden_motives)) {
                            emotionHtml += `<p><strong>Скрытые мотивы:</strong> ${emotions.hidden_motives.join(', ')}</p>`;
                        }
                        
                        if (emotions.attitude) {
                            emotionHtml += `<p><strong>Отношение:</strong> ${emotions.attitude}</p>`;
                        }
                        
                        emotionHtml += '</div>';
                        emotionResults.innerHTML = emotionHtml;
                    }
                    
                    // Активируем все выбранные контейнеры контента независимо от того, 
                    // получены ли данные для них - показываем либо контент, либо индикаторы загрузки
                    
                    // Показываем все выбранные секции с анимацией
                    selectedTypes.forEach((contentType, index) => {
                        const delay = index * 200; // Последовательная анимация с задержкой
                        
                        if (contentType === 'text') {
                            const literarySection = document.querySelector('.literary-section');
                            if (literarySection) {
                                literarySection.style.display = 'block';
                                setTimeout(() => literarySection.classList.add('fadeIn'), delay);
                                
                                // Заполняем контент, если он есть
                                if (data.generated_literary_work) {
                                    const literaryResults = document.getElementById('literary-results');
                                    if (literaryResults) {
                                        literaryResults.innerHTML = data.generated_literary_work;
                                    }
                                }
                            }
                        }
                        
                        if (contentType === 'image') {
                            const imageSection = document.querySelector('.image-section');
                            if (imageSection) {
                                imageSection.style.display = 'block';
                                setTimeout(() => imageSection.classList.add('fadeIn'), delay);
                                
                                // Если изображение готово, показываем его
                                if (data.generated_image && data.generated_image.success) {
                                    console.log("Отображение изображения из результатов API...");
                                    
                                    // Сохраняем внешний URL для возможного использования при ошибке локального URL
                                    if (data.generated_image.external_url) {
                                        window.lastGeneratedImageExternalUrl = data.generated_image.external_url;
                                    }
                                    
                                    displayGeneratedImage(data.generated_image.image_url);
                                } else {
                                    // Если произошла ошибка, показываем сообщение
                                    const loadingElement = document.getElementById('image-loading');
                                    if (loadingElement) {
                                        loadingElement.style.display = 'block'; // Явно показываем блок
                                        console.log('DEBUG: generated_image', data.generated_image);
                                        if (data.generated_image && data.generated_image.error) {
                                            // Проверяем, является ли ошибка связанной с запрещенным контентом
                                            if (data.generated_image.type === 'content_policy_violation' && data.generated_image.can_regenerate_safe) {
                                                // Показываем красивое предупреждение
                                                loadingElement.innerHTML = `
                                                    <div class="alert alert-warning shadow-lg fade show p-4 mb-3" style="border-left: 6px solid #ffc107; animation: fadeIn 0.5s;">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                                            <div>
                                                                <h5 class="mb-1 fw-bold">Нарушение политики контента</h5>
                                                                <div class="text-muted small">Некоторые описания в тексте дневника не могут быть визуализированы согласно политике OpenAI.</div>
                                                            </div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>${data.generated_image.error}</strong>
                                                        </div>
                                                        <div class="mb-3">
                                                            <ul class="mb-2 ps-4">
                                                                <li>Выберите другой отрывок дневника без описаний насилия</li>
                                                                <li>Или попробуйте создать <b>символическую иллюстрацию</b> (качество и точность могут отличаться)</li>
                                                            </ul>
                                                            <div class="alert alert-info py-2 px-3 small mb-2">
                                                                <i class="bi bi-info-circle"></i> Символическая иллюстрация будет создана без сцен насилия, но с сохранением атмосферы и эпохи.
                                                            </div>
                                                        </div>
                                                        <button id="generate-safe-image" class="btn btn-lg btn-outline-warning w-100 fw-bold">
                                                            <i class="bi bi-shield-check"></i> Создать символическую иллюстрацию
                                                        </button>
                                                    </div>`;
                                                loadingElement.classList.remove('progress');
                                                
                                                // Добавляем обработчик для кнопки перегенерации
                                                document.getElementById('generate-safe-image').addEventListener('click', function() {
                                                    // Показываем индикатор загрузки
                                                    loadingElement.innerHTML = `
                                                        <div class="alert alert-warning mb-3">
                                                            <i class="fas fa-exclamation-triangle"></i> 
                                                            <strong>Внимание!</strong> Изображение будет сгенерировано на основе безопасного альтернативного промпта из-за нарушения политики содержания OpenAI. 
                                                            Качество и точность изображения могут отличаться от исходной задумки.
                                                        </div>
                                                        <p class="text-muted">Генерация символического изображения...</p>
                                                        <div class="progress">
                                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                                 role="progressbar" style="width: 100%"></div>
                                                        </div>`;
                                                    
                                                    // Отправляем запрос на генерацию безопасного изображения
                                                    fetch('/generate_safe_image', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/x-www-form-urlencoded',
                                                        },
                                                        body: new URLSearchParams({
                                                            diary_text: document.getElementById('diary_text').value
                                                        })
                                                    })
                                                    .then(response => {
                                                        // Проверяем, что ответ - JSON
                                                        const contentType = response.headers.get('content-type');
                                                        if (!contentType || !contentType.includes('application/json')) {
                                                            throw new Error('Сервер вернул не JSON ответ');
                                                        }
                                                        return response.text();
                                                    })
                                                    .then(responseText => {
                                                        // Безопасный парсинг JSON-ответа с проверкой
                                                        let data;
                                                        try {
                                                            data = JSON.parse(responseText);
                                                            console.log("Получен ответ для безопасного изображения:", data);
                                                        } catch (e) {
                                                            console.error("Ошибка парсинга JSON:", e, "Текст ответа:", responseText);
                                                            throw new Error("Ошибка парсинга JSON-ответа");
                                                        }
                                                        
                                                        if (data.success && data.image_url) {
                                                            // Сохраняем внешний URL, если он есть
                                                            if (data.external_url) {
                                                                window.lastGeneratedImageExternalUrl = data.external_url;
                                                            }
                                                            
                                                            // Показываем сгенерированное безопасное изображение
                                                            displayGeneratedImage(data.image_url);
                                                            
                                                            // Добавляем уведомление о символической альтернативе
                                                            const noticeElement = document.createElement('div');
                                                            noticeElement.className = 'alert alert-info mt-3';
                                                            noticeElement.innerHTML = `
                                                                <i class="fas fa-info-circle"></i>
                                                                Было создано символическое изображение вместо прямой иллюстрации содержимого дневника.
                                                            `;
                                                            document.getElementById('image-results').appendChild(noticeElement);
                                                        } else {
                                                            // Показываем ошибку
                                                            loadingElement.innerHTML = `
                                                                <div class="alert alert-danger">
                                                                    <i class="fas fa-exclamation-triangle"></i>
                                                                    Не удалось сгенерировать даже символическое изображение: ${data.error || 'Неизвестная ошибка'}
                                                                </div>`;
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('Ошибка при запросе безопасного изображения:', error);
                                                        loadingElement.innerHTML = `
                                                            <div class="alert alert-danger">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                                Ошибка при запросе: ${error.message || 'Неизвестная ошибка'}
                                                            </div>`;
                                                    });
                                                });
                                            } else {
                                                // Обычная ошибка
                                                loadingElement.innerHTML = `
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle"></i> 
                                                        Не удалось сгенерировать изображение: ${data.generated_image.error}
                                                    </div>`;
                                                loadingElement.classList.remove('progress');
                                            }
                                        } else {
                                            // Если нет конкретной ошибки, показываем общее сообщение
                                            loadingElement.innerHTML = `
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    Не удалось сгенерировать изображение. Попробуйте другой текст или повторите позже.
                                                </div>`;
                                            loadingElement.classList.remove('progress');
                                        }
                                    }
                                }
                            }
                        }
                        
                        if (contentType === 'music') {
                            const musicSection = document.querySelector('.music-section');
                            if (musicSection) {
                                musicSection.style.display = 'block';
                                setTimeout(() => musicSection.classList.add('fadeIn'), delay);
                                
                                // Если музыка готова или есть task_id для проверки статуса, обрабатываем
                                if (data.generated_music) {
                                    console.log("Данные о музыке получены:", data.generated_music);
                                    displayGeneratedMusic(data.generated_music);
                                }
                            }
                        }
                    });
                    
                    // Прокручиваем страницу к результатам
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                } else {
                    // В случае ошибки HTTP
                    throw new Error(`Ошибка HTTP: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                console.error('Ошибка при обработке запроса:', error);
                
                // Отображаем сообщение об ошибке
                if (statusElement) {
                    statusElement.className = 'alert alert-danger mt-3';
                    statusElement.innerHTML = `
                        <strong>Ошибка:</strong> ${error.message || 'Произошла ошибка при обработке вашего запроса'}
                        <br><small>Попробуйте еще раз или обновите страницу.</small>
                    `;
                }
            } finally {
                // Разблокируем форму в любом случае
                this.classList.remove('processing');
                
                // Восстанавливаем кнопку
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Анализировать';
                }
            }
        });
    }
});

document.getElementById('share-results')?.addEventListener('click', async function() {
    if (!lastAnalysisResults) {
        alert('Нет результатов для публикации');
        return;
    }
    
    try {
        const response = await fetch('/share_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(lastAnalysisResults)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.location.href = data.redirect_url;
        } else {
            alert(data.error || 'Произошла ошибка при публикации');
        }
    } catch (error) {
        alert('Произошла ошибка при отправке запроса');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Инициализация чекбоксов для выбора типов генерации
    const generationOptions = document.querySelectorAll('.generation-type');
    generationOptions.forEach(option => {
        option.addEventListener('change', updateGenerationUI);
    });
    
    // Инициализация кнопки "Выбрать всё"
    const selectAllBtn = document.getElementById('select-all-btn');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.generation-type');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            
            // Обновить интерфейс
            updateGenerationUI();
            
            // Обновить текст кнопки
            this.textContent = allChecked ? 'Выбрать всё' : 'Снять выбор';
        });
    }
    
    // Инициализируем интерфейс
    updateGenerationUI();
});

// Функция для отображения сгенерированного изображения
function displayGeneratedImage(imageUrl) {
    console.log("Отображение изображения:", imageUrl);
    const imageContainer = document.getElementById('generated-image-container');
    const imageElement = document.getElementById('generated-image');
    const loadingElement = document.getElementById('image-loading');
    const errorElement = document.getElementById('image-error');
    
    if (!imageContainer || !imageElement) {
        console.error("Не найдены элементы для отображения изображения");
        return;
    }
    
    // Проверяем, что URL не пустой
    if (!imageUrl || imageUrl === 'undefined') {
        console.error("Получен пустой URL изображения");
        if (errorElement) {
            errorElement.textContent = "Получен некорректный URL изображения";
            errorElement.style.display = 'block';
        }
        if (loadingElement) loadingElement.style.display = 'none';
        return;
    }
    
    // Нормализуем URL изображения
    let normalizedUrl = imageUrl;
    
    // Если URL слишком длинный, вероятно, он содержит ошибку
    if (normalizedUrl.length > 1000) {
        console.warn("Подозрительно длинный URL изображения:", normalizedUrl.length, "символов");
        // Проверяем наличие двойной кодировки
        if (normalizedUrl.includes('%25')) {
            normalizedUrl = decodeURIComponent(normalizedUrl);
            console.log("Декодирован URL с двойной кодировкой");
        }
    }
    
    // Сохраняем URL для возможного использования в будущем
    if (normalizedUrl && normalizedUrl.startsWith('http')) {
        window.lastGeneratedImageExternalUrl = normalizedUrl;
    }
    
    // Скрываем загрузку и ошибки
    if (loadingElement) loadingElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    
    // Показываем индикатор загрузки
    if (loadingElement) loadingElement.style.display = 'block';
    
    // Счетчик попыток загрузки
    let retryCount = 0;
    const maxRetries = 3;
    
    // Функция для попытки загрузки изображения
    function tryLoadImage(url) {
        console.log(`Попытка загрузки изображения ${retryCount+1}/${maxRetries+1}:`, url);
        
        // Устанавливаем обработчики событий для изображения
        imageElement.onerror = function() {
            console.error(`Ошибка загрузки изображения (попытка ${retryCount+1}/${maxRetries+1}):`, url);
            
            // Пробуем следующий метод загрузки
            retryCount++;
            
            if (retryCount <= maxRetries) {
                // Пробуем разные варианты URL
                if (retryCount === 1 && url.startsWith('/')) {
                    // Если URL начинается с /, пробуем без /
                    setTimeout(() => tryLoadImage(url.substring(1)), 500);
                } else if (retryCount === 2 && url.includes('//')) {
                    // Если URL содержит двойной слеш, пробуем исправить
                    const fixedUrl = url.replace(/([^:])\/\/+/g, '$1/');
                    setTimeout(() => tryLoadImage(fixedUrl), 500);
                } else if (window.lastGeneratedImageExternalUrl && window.lastGeneratedImageExternalUrl !== url) {
                    // Пробуем внешний URL
                    setTimeout(() => tryLoadImage(window.lastGeneratedImageExternalUrl), 500);
                } else {
                    // Показываем ошибку если все попытки исчерпаны
                    showImageLoadError("Не удалось загрузить изображение");
                }
            } else {
                // Все попытки исчерпаны
                showImageLoadError("Не удалось загрузить изображение после нескольких попыток");
            }
        };
        
        imageElement.onload = function() {
            console.log("Изображение успешно загружено:", url);
            
            // Скрываем индикатор загрузки и ошибки
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
            
            // Показываем контейнер с изображением
            imageContainer.style.display = 'block';
        };
        
        // Устанавливаем изображение
        // Добавляем параметр времени, чтобы обойти кэширование
        const cacheBuster = `?t=${new Date().getTime()}`;
        imageElement.src = url + cacheBuster;
    }
    
    // Функция для отображения ошибки загрузки
    function showImageLoadError(message) {
        if (loadingElement) loadingElement.style.display = 'none';
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        console.error(message);
    }
    
    // Начинаем загрузку изображения
    tryLoadImage(normalizedUrl);
}

// Функция для проверки статуса генерации музыки
function checkMusicGenerationStatus(taskId) {
    if (!taskId) {
        console.error("Отсутствует ID задачи для проверки статуса");
        return;
    }
    
    console.log(`Проверка статуса генерации музыки для задачи: ${taskId}`);
    
    // Счетчик попыток и максимальное количество повторений
    let attempts = 0;
    const maxAttempts = 60; // 60 повторений с интервалом 5 секунд = 5 минут
    
    // Устанавливаем индикатор загрузки
    const loadingElement = document.getElementById('music-loading');
    const errorElement = document.getElementById('music-error');
    const musicContainer = document.getElementById('generated-music-container');
    
    // Убедимся, что секция музыки видима
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        musicSection.style.display = 'block';
    }
    
    if (loadingElement) {
        loadingElement.style.display = 'block';
        loadingElement.innerHTML = `
            <p class="text-muted">Проверка статуса генерации музыки...</p>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 50%"></div>
            </div>
            <span class="badge bg-info">Идентификатор задачи: ${taskId}</span>
        `;
    }
    
    // Скрываем сообщение об ошибке
    if (errorElement) errorElement.style.display = 'none';
    
    // Функция для выполнения одной проверки статуса
    function checkStatus() {
        // Увеличиваем счетчик попыток
        attempts++;
        
        fetch(`/check_music_status?task_id=${taskId}&t=${new Date().getTime()}`) // Добавляем timestamp для избежания кэширования
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Получен статус для задачи ${taskId} (попытка ${attempts}/${maxAttempts}):`, data);
                
                // Проверяем успешность запроса
                if (!data.success) {
                    // Если у нас более 3 попыток, продолжаем сделать еще несколько попыток
                    if (attempts < 3) {
                        throw new Error(data.message || "Ошибка при проверке статуса");
                    } else {
                        console.log("Ошибка при проверке статуса, но продолжаем попытки:", data.message);
                    }
                }
                
                // Если музыка готова, отображаем ее
                if (data.status === 'complete' || data.is_music_ready === true || 
                    data.audio_url || data.stream_url || data.local_audio_url || 
                    data.proxy_url) {
                    console.log("Музыка готова! Отображаем плеер:", data);
                    
                    // Убедимся, что музыкальная секция видна
                    const musicSection = document.querySelector('.music-section');
                    if (musicSection && musicSection.style.display === 'none') {
                        musicSection.style.display = 'block';
                    }
                    
                    // Отображаем готовую музыку
                    displayGeneratedMusic(data);
                    
                    // Прекращаем дальнейшие проверки
                    return;
                }
                
                // Если статус "timeout" или ошибка, показываем сообщение об ошибке
                if (data.status === 'timeout' || data.status === 'error') {
                    console.log("Ошибка при генерации музыки:", data.message);
                    
                    if (errorElement) {
                        let errorMessage = data.message || "Превышено время ожидания или произошла ошибка";
                        
                        // Создаем блок с ошибкой и рекомендациями
                        errorElement.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Ошибка при проверке статуса</h5>
                                <p>${errorMessage}</p>
                                <div class="mt-3">
                                    <p><strong>Что делать дальше?</strong></p>
                                    <ul>
                                        <li>Проверьте ваше подключение к интернету</li>
                                        <li>Обновите страницу и попробуйте сгенерировать музыку снова</li>
                                        <li>Если проблема повторяется, возможно, у Suno API возникли технические проблемы</li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                                    Обновить страницу и попробовать снова
                                </button>
                            </div>
                        `;
                        errorElement.style.display = 'block';
                    }
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    // Прекращаем дальнейшие проверки
                    return;
                }
                
                // Если API статус показывает ошибку, но задача все еще в процессе, показываем специальное сообщение
                if (data.api_status === 'error') {
                    console.log("API вернул ошибку, но задача всё еще в обработке:", data);
                    
                    // Если это первые 5 попыток, продолжаем пробовать, возможно временная ошибка
                    if (attempts <= 5) {
                        console.log("Продолжаем попытки, несмотря на ошибку API...");
                    } else {
                        if (errorElement) {
                            let errorMessage = data.message || "API вернул ошибку при генерации музыки";
                            
                            // Создаем блок с ошибкой и рекомендациями
                            errorElement.innerHTML = `
                                <div class="alert alert-danger">
                                    <h5>Ошибка при генерации музыки</h5>
                                    <p>API вернул ошибку. Генерация музыки не может быть завершена.</p>
                                    <div class="mt-3">
                                        <p><strong>Что делать дальше?</strong></p>
                                        <ul>
                                            <li>Проверьте ваше подключение к интернету</li>
                                            <li>Обновите страницу и попробуйте снова</li>
                                            <li>Если проблема повторяется, обратитесь к разработчикам</li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                                        Обновить страницу
                                    </button>
                                </div>
                            `;
                            errorElement.style.display = 'block';
                        }
                        
                        if (loadingElement) loadingElement.style.display = 'none';
                        
                        // Прекращаем дальнейшие проверки
                        return;
                    }
                }
                
                // Если музыка все еще генерируется, обновляем прогресс и продолжаем проверки
                if (loadingElement) {
                    // Рассчитываем процент выполнения
                    let progressPercent = 0;
                    if (data.progress) {
                        progressPercent = data.progress;
                    } else if (data.elapsed_seconds) {
                        // Максимальное время ожидания - 15 минут (900 секунд)
                        progressPercent = Math.min(95, Math.round(data.elapsed_seconds / 900 * 100));
                    } else {
                        // Если нет данных о прогрессе, используем прогресс на основе попыток
                        progressPercent = Math.min(90, Math.round(attempts / maxAttempts * 100));
                    }
                    
                    loadingElement.innerHTML = `
                        <p class="text-muted">Генерация музыки продолжается...</p>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                                 style="width: ${progressPercent}%" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100">
                                 ${progressPercent}%
                            </div>
                        </div>
                        <span class="badge bg-info">Идентификатор задачи: ${taskId}</span>
                        ${data.api_status ? `<span class="badge bg-secondary ms-2">API статус: ${data.api_status}</span>` : ''}
                        <span class="badge bg-light text-dark ms-2">Попытка: ${attempts}/${maxAttempts}</span>
                    `;
                }
                
                // Если описание музыки доступно, отображаем его
                const musicDescription = document.getElementById('music-description');
                if (musicDescription && data.music_description) {
                    musicDescription.textContent = data.music_description;
                }
                
                // Если достигнуто максимальное количество попыток, показываем сообщение
                if (attempts >= maxAttempts) {
                    console.log("Достигнуто максимальное количество попыток проверки статуса");
                    
                    if (errorElement) {
                        errorElement.innerHTML = `
                            <div class="alert alert-warning">
                                <h5>Превышено время ожидания</h5>
                                <p>Проверка статуса генерации музыки заняла слишком много времени (${maxAttempts} попыток).</p>
                                <div class="mt-3">
                                    <p><strong>Что это означает?</strong></p>
                                    <ul>
                                        <li>Возможно, запрос всё ещё обрабатывается на серверах Suno</li>
                                        <li>Возможно, возникла проблема при передаче результата</li>
                                        <li>Возможно, запрос был отменен на стороне сервера</li>
                                    </ul>
                                    <p><strong>Что делать дальше?</strong></p>
                                    <ul>
                                        <li>Вы можете подождать ещё некоторое время и проверить позже</li>
                                        <li>Вы можете попробовать сгенерировать музыку снова</li>
                                        <li>Проверьте ваш API ключ и количество доступных кредитов</li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-primary mt-2" onclick="checkMusicGenerationStatus('${taskId}')">
                                    Проверить статус еще раз
                                </button>
                                <button class="btn btn-outline-secondary mt-2 ms-2" onclick="location.reload()">
                                    Обновить страницу
                                </button>
                            </div>
                        `;
                        errorElement.style.display = 'block';
                    }
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                } else {
                    // Продолжаем проверки с интервалом
                    setTimeout(checkStatus, 5000); // Проверяем каждые 5 секунд
                }
            })
            .catch(error => {
                console.error("Ошибка при проверке статуса:", error);
                
                if (errorElement) {
                    errorElement.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Ошибка при проверке статуса</h5>
                            <p>${error.message || 'Произошла ошибка при проверке статуса генерации музыки'}</p>
                            <button class="btn btn-outline-primary mt-2" onclick="checkMusicGenerationStatus('${taskId}')">
                                Попробовать снова
                            </button>
                        </div>
                    `;
                    errorElement.style.display = 'block';
                }
                
                if (loadingElement) loadingElement.style.display = 'none';
                
                // Пробуем еще раз через 10 секунд, если не превышено максимальное количество попыток
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 10000);
                }
            });
    }
    
    // Запускаем первую проверку
    checkStatus();
}

// Функция для отображения ошибки генерации музыки
function showMusicError(errorText, errorDetails = null, taskId = null) {
    const errorElement = document.getElementById('music-error');
    const errorTextElement = document.getElementById('music-error-text');
    
    if (errorElement) {
        // Создаем контейнер для отображения ошибки
        errorElement.innerHTML = '';
        errorElement.className = 'alert alert-danger';
        
        // Заголовок ошибки
        const errorHeader = document.createElement('h5');
        errorHeader.textContent = 'Ошибка при генерации музыки';
        errorElement.appendChild(errorHeader);
        
        // Текст ошибки
        const errorMsg = document.createElement('div');
        errorMsg.className = 'mb-2';
        errorMsg.textContent = errorText || 'Неизвестная ошибка';
        errorElement.appendChild(errorMsg);
        
        // Если есть детали ошибки, добавляем их
        if (errorDetails) {
            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'alert alert-secondary small p-2 mb-2';
            
            // Если это объект, выводим его содержимое
            if (typeof errorDetails === 'object' && errorDetails !== null) {
                try {
                    detailsContainer.textContent = JSON.stringify(errorDetails, null, 2);
                } catch (e) {
                    detailsContainer.textContent = "Не удалось отформатировать детали ошибки";
                }
            } else {
                detailsContainer.textContent = errorDetails;
            }
            
            errorElement.appendChild(detailsContainer);
        }
        
        // Если есть task_id, добавляем его
        if (taskId) {
            const taskInfo = document.createElement('div');
            taskInfo.className = 'small text-muted mb-2';
            taskInfo.textContent = `ID задачи: ${taskId}`;
            errorElement.appendChild(taskInfo);
        }
        
        // Добавляем рекомендации по решению
        const solutionsTitle = document.createElement('h6');
        solutionsTitle.className = 'mt-3 mb-2';
        solutionsTitle.textContent = 'Возможные решения:';
        errorElement.appendChild(solutionsTitle);
        
        const solutionsList = document.createElement('ul');
        solutionsList.className = 'small';
        
        // Добавляем типичные решения
        const solutions = [
            "Проверьте, что API ключ SUNO настроен правильно",
            "Попробуйте повторить запрос позже (возможно, сервер перегружен)",
            "Для ошибок 404: возможно, задача уже удалена или путь к API неверен",
            "Для ошибок аутентификации: проверьте срок действия API ключа",
            "Убедитесь, что у вас есть достаточно кредитов в аккаунте SUNO"
        ];
        
        // Если в ошибке есть 404, добавляем специальные рекомендации
        if (errorText && errorText.includes('404')) {
            solutions.unshift(
                "Это ошибка 'не найдено'. Возможно, задача уже обработана или удалена",
                "Проверьте логи сервера для получения дополнительной информации"
            );
        }
        
        // Если в ошибке есть упоминание status, добавляем рекомендацию
        if (errorText && errorText.includes('status')) {
            solutions.unshift(
                "Ошибка связана с проверкой статуса. Возможно, URL для проверки устарел"
            );
        }
        
        // Добавляем все решения в список
        solutions.forEach(solution => {
            const solutionItem = document.createElement('li');
            solutionItem.textContent = solution;
            solutionsList.appendChild(solutionItem);
        });
        
        errorElement.appendChild(solutionsList);
        
        // Кнопка для повторной проверки статуса
        if (taskId) {
            const recheckButton = document.createElement('button');
            recheckButton.className = 'btn btn-sm btn-outline-primary mt-3';
            recheckButton.textContent = 'Проверить статус еще раз';
            recheckButton.onclick = () => checkMusicGenerationStatus(taskId);
            errorElement.appendChild(recheckButton);
        }
        
        errorElement.style.display = 'block';
    }
}

// Функция для отображения сгенерированной музыки
function displayGeneratedMusic(musicData) {
    console.log("Запуск функции displayGeneratedMusic с данными:", musicData);
    
    // Сначала делаем секцию музыки видимой
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        musicSection.style.display = 'block';
        musicSection.style.visibility = 'visible';
        musicSection.style.opacity = '1';
    }
    
    const musicContainer = document.getElementById('generated-music-container');
    const loadingElement = document.getElementById('music-loading');
    const errorElement = document.getElementById('music-error');
    
    if (!musicContainer) {
        console.error("Не найден контейнер для отображения музыки");
        return;
    }
    
    // Скрываем индикаторы загрузки и ошибок
    if (loadingElement) loadingElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    
    // Проверка на валидность musicData
    if (!musicData) {
        console.error("Ошибка: musicData отсутствует или null");
        if (errorElement) {
            errorElement.textContent = "Ошибка при генерации музыки: Неверные данные";
            errorElement.style.display = 'block';
        }
        return;
    }
    
    console.log("Данные музыки:", musicData);
    
    // Получаем URL аудио в порядке приоритета
    const localAudioUrl = musicData.local_audio_url || '';
    const proxyUrl = musicData.proxy_url || '';
    const audioUrl = musicData.audio_url || '';
    const streamUrl = musicData.stream_url || '';
    
    // Используем первый доступный URL
    const finalAudioUrl = localAudioUrl || proxyUrl || audioUrl || streamUrl;
    console.log("Итоговый URL для аудио:", finalAudioUrl);
    
    if (finalAudioUrl) {
        // Очищаем контейнер
        musicContainer.innerHTML = '';
        
        // Создаем надежный контейнер для плеера
        const audioPlayerWrapper = document.createElement('div');
        audioPlayerWrapper.className = 'audio-player-wrapper';
        audioPlayerWrapper.style.cssText = 'display:block !important; margin:20px 0 !important; background:#fff8e1 !important; padding:15px !important; border:2px solid #ff8c00 !important; border-radius:8px !important;';
        
        // Заголовок
        const title = document.createElement('h4');
        title.style.cssText = 'color:#d35400 !important; margin-bottom:15px !important; font-weight:bold !important;';
        title.textContent = 'Музыкальное сопровождение';
        audioPlayerWrapper.appendChild(title);
        
        // Описание музыки, если есть
        if (musicData.music_description) {
            const description = document.createElement('p');
            description.style.cssText = 'margin-bottom:15px !important; font-style:italic !important;';
            description.textContent = musicData.music_description;
            audioPlayerWrapper.appendChild(description);
        }
        
        // Создаем первый аудиоплеер
        const audioPlayer = document.createElement('audio');
        audioPlayer.controls = true;
        audioPlayer.autoplay = false;
        audioPlayer.preload = 'auto';
        audioPlayer.className = 'primary-audio-player';
        audioPlayer.style.cssText = 'display:block !important; width:100% !important; min-height:50px !important; visibility:visible !important; opacity:1 !important; border:3px solid #ff6600 !important; background:#f0f0f0 !important; margin:10px 0 !important;';
        
        // Добавляем источник
        const source = document.createElement('source');
        source.src = finalAudioUrl;
        source.type = 'audio/mpeg';
        audioPlayer.appendChild(source);
        
        // Текст для браузеров, не поддерживающих аудио
        audioPlayer.appendChild(document.createTextNode('Ваш браузер не поддерживает HTML5 аудио.'));
        
        // Добавляем плеер в контейнер
        audioPlayerWrapper.appendChild(audioPlayer);
        
        // Добавляем кнопку для скачивания
        const downloadLink = document.createElement('a');
        downloadLink.href = finalAudioUrl;
        downloadLink.download = 'music_download.mp3';
        downloadLink.className = 'download-audio-btn';
        downloadLink.style.cssText = 'display:inline-block !important; background:#28a745 !important; color:white !important; padding:10px 20px !important; text-decoration:none !important; border-radius:5px !important; margin-top:15px !important; font-weight:bold !important;';
        downloadLink.innerHTML = '<i class="bi bi-download"></i> Скачать аудиофайл';
        audioPlayerWrapper.appendChild(downloadLink);
        
        // Добавляем обертку в контейнер
        musicContainer.appendChild(audioPlayerWrapper);
        
        // Принудительно отображаем контейнер
        musicContainer.style.display = 'block';
        musicContainer.style.visibility = 'visible';
        musicContainer.style.opacity = '1';
        
        console.log("Создан основной аудиоплеер для URL:", finalAudioUrl);
        
        // Создаем резервный плеер с задержкой
        setTimeout(() => {
            createBackupPlayer(finalAudioUrl);
        }, 1000);
        
    } else if (musicData.task_id) {
        // Если есть task_id, показываем индикатор загрузки и запускаем проверку статуса
        if (loadingElement) {
            loadingElement.style.display = 'block';
            loadingElement.innerHTML = `
                <p class="text-muted">Генерация музыки...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 50%"></div>
                </div>
                <span class="badge bg-info">Идентификатор задачи: ${musicData.task_id}</span>
            `;
        }
        
        // Запускаем проверку статуса
        checkMusicGenerationStatus(musicData.task_id);
    } else {
        // Нет данных для отображения музыки
        if (errorElement) {
            errorElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Нет данных для воспроизведения музыки</strong>
                    <p>Не удалось найти источник аудио. Пожалуйста, повторите попытку.</p>
                </div>
            `;
            errorElement.style.display = 'block';
        }
    }
}

// Функция для создания резервного плеера
function createBackupPlayer(audioUrl) {
    console.log("Создание резервного плеера для URL:", audioUrl);
    
    if (!audioUrl) {
        console.error("Ошибка: пустой URL для резервного плеера");
        return;
    }
    
    const parentContainer = document.getElementById('music-results');
    if (!parentContainer) {
        console.error("Не найден родительский контейнер #music-results");
        return;
    }
    
    // Создаем контейнер для резервного плеера
    const backupContainer = document.createElement('div');
    backupContainer.className = 'backup-player';
    backupContainer.style.cssText = 'background:#fff0f0 !important; border:3px solid #ff0000 !important; border-radius:8px !important; padding:15px !important; margin:20px 0 !important; display:block !important;';
    
    // Заголовок
    const title = document.createElement('h4');
    title.style.cssText = 'color:#ff0000 !important; margin-bottom:15px !important; font-weight:bold !important;';
    title.textContent = 'Резервный аудиоплеер';
    backupContainer.appendChild(title);
    
    // Информационное сообщение
    const info = document.createElement('p');
    info.style.cssText = 'margin-bottom:10px !important;';
    info.textContent = 'Если основной плеер не отображается, используйте этот резервный плеер:';
    backupContainer.appendChild(info);
    
    // Создаем аудиоплеер с яркими стилями
    const backupPlayer = document.createElement('audio');
    backupPlayer.controls = true;
    backupPlayer.preload = 'auto';
    backupPlayer.className = 'backup-audio-player';
    backupPlayer.style.cssText = 'display:block !important; width:100% !important; min-height:50px !important; visibility:visible !important; opacity:1 !important; border:3px solid #ff0000 !important; background:#ffe6e6 !important; margin:10px 0 !important;';
    
    // Добавляем источник
    const source = document.createElement('source');
    source.src = audioUrl;
    source.type = 'audio/mpeg';
    backupPlayer.appendChild(source);
    
    // Текст для браузеров, не поддерживающих аудио
    backupPlayer.appendChild(document.createTextNode('Ваш браузер не поддерживает HTML5 аудио.'));
    
    // Добавляем плеер в контейнер
    backupContainer.appendChild(backupPlayer);
    
    // Добавляем кнопки для действий с аудио
    const actionsDiv = document.createElement('div');
    actionsDiv.style.cssText = 'display:flex !important; justify-content:center !important; gap:10px !important; margin-top:15px !important;';
    
    // Кнопка скачивания
    const downloadLink = document.createElement('a');
    downloadLink.href = audioUrl;
    downloadLink.download = 'music_download.mp3';
    downloadLink.className = 'btn btn-success';
    downloadLink.style.cssText = 'font-weight:bold !important;';
    downloadLink.innerHTML = '<i class="bi bi-download"></i> Скачать аудио';
    actionsDiv.appendChild(downloadLink);
    
    // Кнопка открыть в новом окне
    const openLink = document.createElement('a');
    openLink.href = audioUrl;
    openLink.target = '_blank';
    openLink.className = 'btn btn-primary';
    openLink.style.cssText = 'font-weight:bold !important;';
    openLink.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> Открыть в новой вкладке';
    actionsDiv.appendChild(openLink);
    
    backupContainer.appendChild(actionsDiv);
    
    // HTML5 плеер (третий вариант)
    const rawHtmlPlayer = document.createElement('div');
    rawHtmlPlayer.className = 'raw-html-player';
    rawHtmlPlayer.style.cssText = 'margin-top:20px !important; border-top:1px dashed #ff0000 !important; padding-top:15px !important;';
    
    rawHtmlPlayer.innerHTML = `
        <p style="margin-bottom:10px !important;"><strong style="color:#ff0000 !important;">Вариант 3:</strong> HTML5 плеер без оформления</p>
        <audio controls preload="auto" style="display:block !important; width:100% !important; height:50px !important;">
            <source src="${audioUrl}" type="audio/mpeg">
            Ваш браузер не поддерживает HTML5 аудио.
        </audio>
    `;
    
    backupContainer.appendChild(rawHtmlPlayer);
    
    // Добавляем контейнер с резервным плеером на страницу
    parentContainer.appendChild(backupContainer);
    
    console.log("Резервный плеер успешно создан");
    
    // Через 2 секунды форсированно пытаемся проиграть аудио, чтобы проверить его работоспособность
    setTimeout(() => {
        try {
            backupPlayer.load();
            console.log("Выполнена принудительная перезагрузка аудио");
        } catch (e) {
            console.error("Ошибка при перезагрузке аудио:", e);
        }
    }, 2000);
}

// Функция для обновления интерфейса в зависимости от выбранных типов генерации
function updateGenerationUI() {
    const selectedTypes = Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value);
    const submitButton = document.querySelector('#diary-form button[type="submit"]');
    
    // Определяем, какие секции результатов показывать при анализе
    const showText = selectedTypes.includes('text');
    const showImage = selectedTypes.includes('image');
    const showMusic = selectedTypes.includes('music');
    
    // Находим секции результатов
    const literaryResults = document.getElementById('literary-results');
    const imageResults = document.getElementById('image-results');
    const musicResults = document.getElementById('music-results');
    
    // Настраиваем видимость секций (только если результаты отображаются)
    if (document.getElementById('results').style.display !== 'none') {
        // Показываем/скрываем секции в зависимости от выбранных типов
        if (literaryResults) {
            const literaryCard = literaryResults.closest('.card');
            if (literaryCard) literaryCard.style.display = showText ? 'block' : 'none';
        }
        
        if (imageResults) {
            const imageCard = imageResults.closest('.card');
            if (imageCard) imageCard.style.display = showImage ? 'block' : 'none';
        }
        
        if (musicResults) {
            const musicCard = musicResults.closest('.card');
            if (musicCard) musicCard.style.display = showMusic ? 'block' : 'none';
        }
    }
    
    // Настраиваем текст кнопки
    if (submitButton) {
        if (selectedTypes.length === 0) {
            submitButton.textContent = 'Выберите тип генерации';
            submitButton.disabled = true;
        } else if (selectedTypes.length === 3) {
            submitButton.textContent = 'Анализировать и создать всё';
            submitButton.disabled = false;
        } else {
            const types = [];
            if (showText) types.push('текст');
            if (showImage) types.push('иллюстрацию');
            if (showMusic) types.push('музыку');
            submitButton.textContent = `Анализировать и создать ${types.join(' и ')}`;
            submitButton.disabled = false;
        }
    }
}

// Функция для отдельной генерации изображения
function generateImageOnly(text, emotions) {
    // Находим или создаем контейнер для изображения
    let imageSection = document.querySelector('.image-section');
    if (!imageSection) {
        imageSection = document.createElement('div');
        imageSection.className = 'image-section mt-4 p-3 border rounded bg-light';
        
        // Заголовок
        const header = document.createElement('h3');
        header.textContent = 'Сгенерированное изображение';
        imageSection.appendChild(header);
        
        // Контейнер для результатов
        const imageResults = document.createElement('div');
        imageResults.id = 'image-results';
        imageSection.appendChild(imageResults);
        
        // Индикатор загрузки
        const loading = document.createElement('div');
        loading.id = 'image-loading';
        loading.className = 'progress my-3';
        loading.innerHTML = `
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 100%"></div>
        `;
        imageResults.appendChild(loading);
        
        // Контейнер для изображения
        const imageContainer = document.createElement('div');
        imageContainer.id = 'generated-image-container';
        imageContainer.className = 'text-center mb-3';
        imageContainer.style.display = 'none';
        
        const imageElement = document.createElement('img');
        imageElement.id = 'generated-image';
        imageElement.className = 'img-fluid rounded shadow';
        imageElement.alt = 'Сгенерированная иллюстрация';
        
        imageContainer.appendChild(imageElement);
        imageResults.appendChild(imageContainer);
        
        // Добавляем на страницу
        const resultsSection = document.getElementById('results');
        if (resultsSection) {
            resultsSection.appendChild(imageSection);
        } else {
            document.body.appendChild(imageSection);
        }
    }
    
    // Показываем секцию
    imageSection.style.display = 'block';
    imageSection.classList.add('fadeIn');
    
    // Показываем индикатор загрузки
    const loadingElement = document.getElementById('image-loading');
    if (loadingElement) {
        loadingElement.style.display = 'block';
        loadingElement.innerHTML = `
            <p class="text-muted">Генерация изображения...</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>`;
    }
    
    // Отправляем запрос на генерацию изображения
    fetch('/generate_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            emotion_analysis: emotions
        })
    })
    .then(response => {
        // Проверяем, что ответ - JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Сервер вернул не JSON ответ');
        }
        return response.json();
    })
    .then(data => {
        console.log('Ответ от сервера /generate_image:', data);
        
        // Обрабатываем успешный ответ
        if (data.success) {
            // Сохраняем внешний URL, если он есть
            if (data.external_url) {
                window.lastGeneratedImageExternalUrl = data.external_url;
            }
            
            // Показываем изображение
            displayGeneratedImage(data.image_url);
        }
        // Обрабатываем ошибку
        else {
            if (loadingElement) {
                // Проверяем, является ли ошибка связанной с запрещенным контентом
                // Примечание: API может вернуть поля на верхнем уровне, а не внутри генерированного изображения
                if (data.type === 'content_policy_violation' && data.can_regenerate_safe) {
                    // Показываем специальное сообщение с возможностью перегенерации
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning shadow-lg fade show p-4 mb-3" style="border-left: 6px solid #ffc107; animation: fadeIn 0.5s;">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                <div>
                                    <h5 class="mb-1 fw-bold">Нарушение политики контента</h5>
                                    <div class="text-muted small">Некоторые описания в тексте дневника не могут быть визуализированы согласно политике OpenAI.</div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <strong>${data.generated_image.error}</strong>
                            </div>
                            <div class="mb-3">
                                <ul class="mb-2 ps-4">
                                    <li>Выберите другой отрывок дневника без описаний насилия</li>
                                    <li>Или попробуйте создать <b>символическую иллюстрацию</b> (качество и точность могут отличаться)</li>
                                </ul>
                                <div class="alert alert-info py-2 px-3 small mb-2">
                                    <i class="bi bi-info-circle"></i> Символическая иллюстрация будет создана без сцен насилия, но с сохранением атмосферы и эпохи.
                                </div>
                            </div>
                            <button id="generate-safe-image" class="btn btn-lg btn-outline-warning w-100 fw-bold">
                                <i class="bi bi-shield-check"></i> Создать символическую иллюстрацию
                            </button>
                        </div>`;
                    loadingElement.classList.remove('progress');
                    
                    // Добавляем обработчик для кнопки перегенерации
                    document.getElementById('generate-safe-image').addEventListener('click', function() {
                        // Показываем индикатор загрузки
                        loadingElement.innerHTML = `
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>Внимание!</strong> Изображение будет сгенерировано на основе безопасного альтернативного промпта из-за нарушения политики содержания OpenAI. 
                                Качество и точность изображения могут отличаться от исходной задумки.
                            </div>
                            <p class="text-muted">Генерация символического изображения...</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>`;
                        
                        // Отправляем запрос на генерацию безопасного изображения
                        fetch('/generate_safe_image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                diary_text: document.getElementById('diary_text').value
                            })
                        })
                        .then(response => {
                            // Проверяем, что ответ - JSON
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('Сервер вернул не JSON ответ');
                            }
                            return response.text();
                        })
                        .then(responseText => {
                            // Безопасный парсинг JSON-ответа с проверкой
                            let data;
                            try {
                                data = JSON.parse(responseText);
                                console.log("Получен ответ для безопасного изображения:", data);
                            } catch (e) {
                                console.error("Ошибка парсинга JSON:", e, "Текст ответа:", responseText);
                                throw new Error("Ошибка парсинга JSON-ответа");
                            }
                            
                            if (data.success && data.image_url) {
                                // Сохраняем внешний URL, если он есть
                                if (data.external_url) {
                                    window.lastGeneratedImageExternalUrl = data.external_url;
                                }
                                
                                // Показываем сгенерированное безопасное изображение
                                displayGeneratedImage(data.image_url);
                                
                                // Добавляем уведомление о символической альтернативе
                                const noticeElement = document.createElement('div');
                                noticeElement.className = 'alert alert-info mt-3';
                                noticeElement.innerHTML = `
                                    <i class="fas fa-info-circle"></i>
                                    Было создано символическое изображение вместо прямой иллюстрации содержимого дневника.
                                `;
                                document.getElementById('image-results').appendChild(noticeElement);
                            } else {
                                // Показываем ошибку
                                loadingElement.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Не удалось сгенерировать даже символическое изображение: ${data.error || 'Неизвестная ошибка'}
                                    </div>`;
                            }
                        })
                        .catch(error => {
                            console.error('Ошибка при запросе безопасного изображения:', error);
                            loadingElement.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Ошибка при запросе: ${error.message || 'Неизвестная ошибка'}
                                </div>`;
                        });
                    });
                } else {
                    // Обычная ошибка
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Не удалось сгенерировать изображение: ${data.error || 'Неизвестная ошибка'}
                        </div>`;
                    loadingElement.classList.remove('progress');
                }
            }
        }
    })
    .catch(error => {
        console.error('Ошибка при запросе изображения:', error);
        if (loadingElement) {
            loadingElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ошибка при запросе: ${error.message || 'Неизвестная ошибка'}
                </div>`;
        }
    });
    
    // Прокручиваем страницу к результатам
    const resultsSection = document.getElementById('results');
    if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// Добавим кнопку для тестирования функционала отдельной генерации изображения
document.addEventListener('DOMContentLoaded', function() {
    // Создаем кнопку тестирования
    const testButton = document.createElement('button');
    testButton.id = 'test-policy-violation';
    testButton.className = 'btn btn-sm btn-outline-danger mt-2';
    testButton.textContent = 'Тест обработки запрещенного контента';
    
    // Находим подходящее место для кнопки
    const formControls = document.querySelector('.form-controls');
    if (formControls) {
        formControls.appendChild(testButton);
    } else {
        // Если нет подходящего места, добавляем после формы
        const analysisForm = document.getElementById('analysis-form');
        if (analysisForm) {
            analysisForm.insertAdjacentElement('afterend', testButton);
        }
    }
    
    // Добавляем обработчик события
    testButton.addEventListener('click', function() {
        // Используем специальный тестовый текст с описаниями насилия
        const testText = `
12 августа 1943 года. Под Курском.

Сегодня был страшный бой. Наш батальон попал под массированный огонь немецких пулеметов. Я видел, как пули прошивали тела моих товарищей. Кровь была везде.

Вчера нам удалось захватить немецкий танк. Мы расстреляли экипаж, когда они пытались выбраться. Их командир умолял сохранить ему жизнь, но после того, что они сделали с нашей деревней, пощады не было.

Ночью помогал санитарам собирать раненых. Многие были изуродованы до неузнаваемости. У Петровича оторвало обе ноги, но он еще был жив, когда мы его нашли. Умер по дороге в медсанбат.

Мы нашли тела мирных жителей со следами пыток. Женщины и дети... Не могу описать, что с ними сделали. После этого мы поклялись не брать пленных.

Завтра снова в бой. Запас патронов пополнили, гранаты получили. Командир сказал, будем прорываться к железнодорожной станции. Немцы хорошо укрепились, но мы должны выбить их оттуда любой ценой.`;
        
        // Эмоциональный анализ (упрощенный)
        const emotions = {
            "primary_emotions": [
                {"emotion": "ужас", "intensity": 9},
                {"emotion": "гнев", "intensity": 8},
                {"emotion": "отчаяние", "intensity": 7}
            ],
            "emotional_tone": "мрачный"
        };
        
        // Вызываем функцию генерации изображения
        generateImageOnly(testText, emotions);
    });
});

// Добавляем функцию для тестирования обработки запрещенного контента
function testContentPolicyViolation() {
    console.log("Тестирование обработки запрещенного контента...");
    
    // Используем специальный тестовый текст с явными описаниями насилия и крови
    const testText = `
12 августа 1943 года. Под Курском.

Сегодня был страшный бой. Наш батальон попал под массированный огонь немецких пулеметов. Я видел, как пули прошивали тела моих товарищей. Кровь была везде.

Вчера нам удалось захватить немецкий танк. Мы расстреляли экипаж, когда они пытались выбраться. Их командир умолял сохранить ему жизнь, но после того, что они сделали с нашей деревней, пощады не было.

Ночью помогал санитарам собирать раненых. Многие были изуродованы до неузнаваемости. У Петровича оторвало обе ноги, но он еще был жив, когда мы его нашли. Умер по дороге в медсанбат.

Мы нашли тела мирных жителей со следами пыток. Женщины и дети... Не могу описать, что с ними сделали. После этого мы поклялись не брать пленных.`;

    // Показываем текст теста в специальном блоке
    const testInfoBlock = document.createElement('div');
    testInfoBlock.className = 'alert alert-info';
    testInfoBlock.innerHTML = `
        <strong>Тестирование политики контента OpenAI:</strong>
        <p>Запускаем тестовый запрос с текстом, содержащим явное насилие.</p>
        <p>Должно появиться предупреждение о нарушении политики контента.</p>
    `;
    
    // Создаем или находим секцию изображения
    let imageSection = document.querySelector('.image-section');
    if (!imageSection) {
        imageSection = document.createElement('div');
        imageSection.className = 'image-section mt-4 p-3 border rounded bg-light';
        
        // Заголовок
        const header = document.createElement('h3');
        header.textContent = 'Тест политики содержания';
        imageSection.appendChild(header);
        
        // Контейнер для результатов
        const imageResults = document.createElement('div');
        imageResults.id = 'image-results';
        imageSection.appendChild(imageResults);
        
        // Добавляем секцию в интерфейс
        const generatedContent = document.getElementById('generated-content');
        if (generatedContent) {
            generatedContent.appendChild(imageSection);
        } else {
            document.body.appendChild(imageSection);
        }
    }
    
    // Находим или создаем контейнер для загрузки
    let loadingElement = document.getElementById('image-loading');
    if (!loadingElement) {
        loadingElement = document.createElement('div');
        loadingElement.id = 'image-loading';
        loadingElement.className = 'loading-indicator mb-3';
        
        const imageResults = document.getElementById('image-results');
        if (imageResults) {
            imageResults.appendChild(loadingElement);
        } else {
            imageSection.appendChild(loadingElement);
        }
    }
    
    // Показываем информационный блок и индикатор загрузки
    document.getElementById('image-results').innerHTML = '';
    document.getElementById('image-results').appendChild(testInfoBlock);
    
    // Показываем индикатор загрузки
    loadingElement.className = 'loading-indicator mb-3 progress';
    loadingElement.innerHTML = `
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" style="width: 100%"></div>
    `;
    
    document.getElementById('image-results').appendChild(loadingElement);
    
    // Прокручиваем страницу к результатам
    imageSection.scrollIntoView({ behavior: 'smooth' });
    
    // Отправляем запрос на генерацию изображения
    fetch('/generate_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: testText,
            emotion_analysis: {
                "primary_emotions": [
                    {"emotion": "ужас", "intensity": 9},
                    {"emotion": "гнев", "intensity": 8},
                    {"emotion": "скорбь", "intensity": 7}
                ],
                "emotional_tone": "тяжелый и напряженный",
                "hidden_motives": ["жажда мести", "стремление выжить"],
                "attitude": "ненависть к врагу"
            }
        })
    })
    .then(response => {
        // Проверяем, что ответ - JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Сервер вернул не JSON ответ');
        }
        return response.json();
    })
    .then(data => {
        console.log('Ответ от сервера /generate_image (тест):', data);
        
        // Обрабатываем успешный ответ
        if (data.success) {
            // Это неожиданно - текст должен был вызвать ошибку политики содержания
            loadingElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Неожиданный результат:</strong> Запрос не вызвал ошибку политики содержания, хотя должен был.
                </div>`;
            
            // Показываем изображение, которое было сгенерировано
            displayGeneratedImage(data.image_url);
        }
        // Обрабатываем ошибку
        else {
            // Проверяем, является ли ошибка связанной с политикой содержания
            if (data.type === 'content_policy_violation' && data.can_regenerate_safe) {
                // Это ожидаемый результат - показываем сообщение об успешном тесте
                loadingElement.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Тест успешен!</strong> Система правильно определила нарушение политики содержания.
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>${data.error}</strong>
                        <p class="mt-2">Вы можете:</p>
                        <ul>
                            <li>Выбрать другой отрывок дневника без описаний насилия</li>
                            <li>Сгенерировать символическую иллюстрацию (качество может быть ниже и содержание менее точным)</li>
                        </ul>
                        <button id="generate-safe-image-test" class="btn btn-sm btn-outline-primary mt-2">
                            Создать символическую иллюстрацию
                        </button>
                    </div>`;
                
                // Добавляем обработчик для кнопки перегенерации
                document.getElementById('generate-safe-image-test').addEventListener('click', function() {
                    // Показываем индикатор загрузки и предупреждение
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Внимание!</strong> Изображение будет сгенерировано на основе безопасного альтернативного промпта из-за нарушения политики содержания OpenAI. 
                            Качество и точность изображения могут отличаться от исходной задумки.
                        </div>
                        <p class="text-muted">Генерация символического изображения...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>`;
                    
                    // Отправляем запрос на генерацию безопасного изображения
                    fetch('/generate_safe_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            diary_text: testText
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Получен ответ для безопасного изображения (тест):", data);
                        
                        if (data.success && data.image_url) {
                            // Показываем сгенерированное безопасное изображение
                            displayGeneratedImage(data.image_url);
                            
                            // Добавляем уведомление о символической альтернативе
                            const noticeElement = document.createElement('div');
                            noticeElement.className = 'alert alert-info mt-3';
                            noticeElement.innerHTML = `
                                <i class="fas fa-info-circle"></i>
                                Было создано символическое изображение вместо прямой иллюстрации содержимого дневника.
                            `;
                            document.getElementById('image-results').appendChild(noticeElement);
                        } else {
                            // Показываем ошибку
                            loadingElement.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Не удалось сгенерировать символическое изображение: ${data.error || 'Неизвестная ошибка'}
                                </div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при запросе безопасного изображения (тест):', error);
                        loadingElement.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                Ошибка при запросе: ${error.message || 'Неизвестная ошибка'}
                            </div>`;
                    });
                });
            } else {
                // Обычная ошибка
                loadingElement.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Не удалось сгенерировать изображение: ${data.error || 'Неизвестная ошибка'}
                    </div>`;
            }
        }
    })
    .catch(error => {
        console.error('Ошибка при тестировании политики содержания:', error);
        loadingElement.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Ошибка при запросе: ${error.message || 'Неизвестная ошибка'}
            </div>`;
    });
}

// Добавляем обработчик для кнопки тестирования
document.addEventListener('DOMContentLoaded', function() {
    // Создаем кнопку тестирования
    const testButton = document.createElement('button');
    testButton.id = 'test-policy-violation';
    testButton.className = 'btn btn-sm btn-outline-danger mt-2';
    testButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Тест обработки жестокого контента';
    testButton.style.marginLeft = '10px';
    
    // Находим подходящее место для кнопки
    const formControls = document.querySelector('.form-controls');
    if (formControls) {
        formControls.appendChild(testButton);
    } else {
        // Если нет подходящего места, добавляем после формы
        const analysisForm = document.getElementById('analysis-form');
        if (analysisForm) {
            analysisForm.insertAdjacentElement('afterend', testButton);
        }
    }
    
    // Добавляем обработчик события для нашей улучшенной функции тестирования
    testButton.addEventListener('click', function(e) {
        e.preventDefault();
        testContentPolicyViolation();
    });
});

// Функция для гарантированного отображения музыкального плеера
document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем таймер для проверки состояния музыкального плеера
    setTimeout(function() {
        // Находим музыкальную секцию и делаем ее видимой
        const musicSection = document.querySelector('.music-section');
        if (musicSection) {
            console.log('Принудительное отображение музыкальной секции');
            musicSection.style.display = 'block';
            musicSection.style.opacity = '1';
            musicSection.style.visibility = 'visible';
        }
        
        // Находим контейнер музыки и делаем его видимым
        const musicContainer = document.getElementById('generated-music-container');
        if (musicContainer) {
            console.log('Принудительное отображение контейнера музыки');
            musicContainer.style.display = 'block';
            musicContainer.style.opacity = '1';
            musicContainer.style.visibility = 'visible';
        }
        
        // Проверяем наличие аудио элементов и делаем их видимыми
        const audioElements = document.querySelectorAll('audio');
        if (audioElements.length > 0) {
            console.log(`Обнаружено ${audioElements.length} аудио элементов`);
            audioElements.forEach((audio, index) => {
                console.log(`Принудительное отображение аудио элемента ${index + 1}`);
                audio.style.display = 'block';
                audio.style.opacity = '1';
                audio.style.visibility = 'visible';
                audio.style.width = '100%';
                
                // Добавляем обработчик ошибок для отладки
                audio.onerror = function(e) {
                    console.error(`Ошибка в аудио элементе ${index + 1}:`, e);
                };
                
                // Перезагружаем аудио для принудительной инициализации
                try {
                    audio.load();
                } catch (e) {
                    console.warn(`Не удалось перезагрузить аудио ${index + 1}:`, e);
                }
            });
        } else {
            console.log('Аудио элементы не найдены');
        }
        
        // Создаем альтернативный плеер, если не обнаружено работающих плееров
        const parentContainer = document.getElementById('music-results');
        if (parentContainer && audioElements.length === 0) {
            console.log('Создание альтернативного аудио плеера');
            
            // Ищем потенциальные источники аудио в метаданных
            const metadataElements = document.querySelectorAll('pre');
            let audioUrls = [];
            
            metadataElements.forEach(el => {
                try {
                    const text = el.textContent;
                    if (text && text.includes('audio_url') || text.includes('local_audio_url')) {
                        // Ищем URL-ы аудио с помощью регулярных выражений
                        const urlMatches = text.match(/"(local_audio_url|audio_url|stream_url)"\s*:\s*"([^"]+)"/g);
                        if (urlMatches) {
                            urlMatches.forEach(match => {
                                const url = match.split(':')[1].trim().replace(/"/g, '');
                                if (url.startsWith('http') || url.startsWith('/')) {
                                    audioUrls.push(url);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error('Ошибка при поиске URL-ов аудио:', e);
                }
            });
            
            // Создаем альтернативный плеер
            const alternativePlayer = document.createElement('div');
            alternativePlayer.className = 'card p-3 mt-3 alternative-player';
            alternativePlayer.innerHTML = `
                <h5>Альтернативный аудио плеер</h5>
                <p class="text-muted small">Используйте этот плеер, если основной не отображается</p>
                <audio controls style="width: 100%; display: block;">
                    ${audioUrls.map(url => `<source src="${url}" type="audio/mpeg">`).join('')}
                    Ваш браузер не поддерживает аудио элемент.
                </audio>
            `;
            parentContainer.appendChild(alternativePlayer);
        }
    }, 2000); // Проверяем через 2 секунды после загрузки страницы
});

// Функция, которая запускается после загрузки страницы
document.addEventListener('DOMContentLoaded', function() {
    // Через 3 секунды запускаем проверку и восстановление всех аудиоплееров
    setTimeout(ensureAudioPlayersVisible, 3000);
});

// Функция для принудительного отображения всех аудиоплееров
function ensureAudioPlayersVisible() {
    console.log("Запуск функции проверки видимости аудиоплееров");
    
    // Показываем секцию с музыкой, если она есть
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        console.log("Делаем секцию музыки видимой");
        musicSection.style.display = 'block';
        musicSection.style.visibility = 'visible';
        musicSection.style.opacity = '1';
    }
    
    // Делаем видимыми все контейнеры
    const containers = [
        '#generated-music-container',
        '#music-results',
        '.audio-player-container',
        '.audio-player-wrapper'
    ];
    
    containers.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        if (elements.length) {
            console.log(`Найдено ${elements.length} элементов для селектора ${selector}`);
            elements.forEach(el => {
                el.style.display = 'block';
                el.style.visibility = 'visible';
                el.style.opacity = '1';
                console.log(`Элемент с селектором ${selector} сделан видимым`);
            });
        } else {
            console.log(`Не найдено элементов для селектора ${selector}`);
        }
    });
    
    // Делаем видимыми все аудиоплееры
    const audioPlayers = document.querySelectorAll('audio');
    if (audioPlayers.length) {
        console.log(`Найдено ${audioPlayers.length} аудиоплееров`);
        
        audioPlayers.forEach(player => {
            // Применяем стили напрямую к элементу
            player.style.display = 'block';
            player.style.visibility = 'visible';
            player.style.opacity = '1';
            player.style.width = '100%';
            player.style.minHeight = '50px';
            player.style.border = '3px solid #ff6600';
            player.style.backgroundColor = '#f0f0f0';
            player.style.margin = '15px 0';
            player.style.zIndex = '9999';
            
            // Принудительно загружаем аудио
            try {
                player.load();
                console.log("Перезагружен аудиоплеер");
            } catch (e) {
                console.error("Ошибка при перезагрузке аудиоплеера:", e);
            }
        });
    } else {
        console.log("Не найдено аудиоплееров на странице");
        
        // Проверяем, есть ли URL аудио в скрытых элементах
        checkForHiddenAudioUrls();
    }
}

// Проверяем наличие URL аудио в скрытых элементах и создаем дополнительный плеер
function checkForHiddenAudioUrls() {
    console.log("Поиск скрытых URL аудио");
    
    // Ищем все элементы с атрибутами, содержащими URL-адреса
    const allElements = document.querySelectorAll('*');
    let foundUrls = [];
    
    allElements.forEach(el => {
        // Проверяем все атрибуты элемента
        Array.from(el.attributes).forEach(attr => {
            const value = attr.value || '';
            
            // Ищем строки, похожие на URL аудиофайлов
            if ((value.includes('.mp3') || value.includes('/proxy_audio') || 
                 value.includes('/audio/') || value.includes('music_file')) && 
                !foundUrls.includes(value)) {
                console.log("Найден возможный URL аудио в атрибуте:", value);
                foundUrls.push(value);
            }
        });
        
        // Проверяем текстовое содержимое
        const textContent = el.textContent || '';
        if ((textContent.includes('.mp3') || textContent.includes('/proxy_audio')) && 
            textContent.length < 300) { // Ограничиваем длину для исключения больших текстов
            
            // Извлекаем возможные URL из текста
            const urlRegex = /(https?:\/\/[^\s"'<>]+\.mp3|\/proxy_audio\?[^\s"'<>]+)/g;
            const matches = textContent.match(urlRegex);
            
            if (matches) {
                matches.forEach(url => {
                    if (!foundUrls.includes(url)) {
                        console.log("Найден возможный URL аудио в тексте:", url);
                        foundUrls.push(url);
                    }
                });
            }
        }
    });
    
    // Если найдены URL, создаем плеер для каждого
    if (foundUrls.length > 0) {
        console.log(`Найдено ${foundUrls.length} скрытых URL аудио`);
        
        // Создаем контейнер для плееров
        const container = document.createElement('div');
        container.className = 'emergency-audio-players';
        container.style.cssText = 'background:#ffe0e0 !important; border:5px solid #ff0000 !important; padding:20px !important; margin:20px 0 !important; border-radius:10px !important;';
        
        const title = document.createElement('h3');
        title.textContent = 'Обнаружены скрытые аудио файлы';
        title.style.cssText = 'color:#ff0000 !important; margin-bottom:20px !important; text-align:center !important; font-weight:bold !important;';
        container.appendChild(title);
        
        const description = document.createElement('p');
        description.textContent = 'Найдены ссылки на аудиофайлы, которые могут не отображаться в стандартном плеере. Попробуйте воспользоваться одним из этих плееров:';
        description.style.cssText = 'margin-bottom:20px !important; font-style:italic !important;';
        container.appendChild(description);
        
        // Создаем плееры для каждого URL
        foundUrls.forEach((url, index) => {
            const playerWrapper = document.createElement('div');
            playerWrapper.className = 'emergency-player-item';
            playerWrapper.style.cssText = 'background:#fff !important; border:2px solid #ff0000 !important; padding:15px !important; margin-bottom:15px !important; border-radius:5px !important;';
            
            const playerTitle = document.createElement('h4');
            playerTitle.textContent = `Резервный плеер #${index + 1}`;
            playerTitle.style.cssText = 'color:#d32f2f !important; margin-bottom:10px !important;';
            playerWrapper.appendChild(playerTitle);
            
            const urlDisplay = document.createElement('p');
            urlDisplay.textContent = `Источник аудио: ${url}`;
            urlDisplay.style.cssText = 'font-size:12px !important; color:#666 !important; margin-bottom:10px !important; word-break:break-all !important;';
            playerWrapper.appendChild(urlDisplay);
            
            // Создаем аудиоплеер
            const player = document.createElement('audio');
            player.controls = true;
            player.preload = 'auto';
            player.style.cssText = 'display:block !important; width:100% !important; min-height:50px !important; border:3px solid #ff0000 !important;';
            
            const source = document.createElement('source');
            source.src = url;
            source.type = 'audio/mpeg';
            player.appendChild(source);
            
            playerWrapper.appendChild(player);
            
            // Добавляем кнопки для скачивания и открытия в новом окне
            const buttons = document.createElement('div');
            buttons.style.cssText = 'display:flex !important; justify-content:center !important; gap:10px !important; margin-top:10px !important;';
            
            const downloadBtn = document.createElement('a');
            downloadBtn.href = url;
            downloadBtn.download = `audio_file_${index + 1}.mp3`;
            downloadBtn.className = 'btn btn-success btn-sm';
            downloadBtn.innerHTML = '<i class="bi bi-download"></i> Скачать';
            buttons.appendChild(downloadBtn);
            
            const openBtn = document.createElement('a');
            openBtn.href = url;
            openBtn.target = '_blank';
            openBtn.className = 'btn btn-primary btn-sm';
            openBtn.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> Открыть в новом окне';
            buttons.appendChild(openBtn);
            
            playerWrapper.appendChild(buttons);
            container.appendChild(playerWrapper);
        });
        
        // Добавляем контейнер на страницу
        const targetContainer = document.getElementById('music-results') || document.querySelector('.music-section') || document.body;
        targetContainer.appendChild(container);
        
        console.log("Создан контейнер с резервными плеерами для скрытых URL");
    } else {
        console.log("Не найдено скрытых URL аудио");
    }
}
</script>
{% endblock %}