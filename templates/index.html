<style>
/* –ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª –≤—Å–µ —Å—Ç–∏–ª–∏ –≤ static/css/styles.css –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
</style>

{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–æ–µ–Ω–Ω—ã—Ö –¥–Ω–µ–≤–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<div class="row">
    <!-- –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–Ω–µ–≤–Ω–∏–∫–æ–≤ -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h2>–ê–Ω–∞–ª–∏–∑ –≤–æ–µ–Ω–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞</h2>
            </div>
            <div class="card-body">
                <form id="diary-form">
                    <div class="mb-3">
                        <label for="diary_text" class="form-label">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–Ω–µ–≤–Ω–∏–∫–∞:</label>
                        <textarea class="form-control" id="diary_text" name="diary_text" rows="10" required></textarea>
                    </div>
                    
                    <!-- –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <div class="mb-3">
                        <label class="form-label">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å?</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_text" value="text" checked>
                                <label class="form-check-label" for="generation_text">
                                    <i class="bi bi-file-text"></i> –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_image" value="image">
                                <label class="form-check-label" for="generation_image">
                                    <i class="bi bi-image"></i> –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input generation-type" type="checkbox" name="generation_types[]" id="generation_music" value="music">
                                <label class="form-check-label" for="generation_music">
                                    <i class="bi bi-music-note-beamed"></i> –ú—É–∑—ã–∫–∞
                                </label>
                            </div>
                            <div class="ms-3">
                                <button type="button" id="select-all-btn" class="btn btn-sm btn-outline-secondary">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è -->
                    <div class="mb-3" id="literary-type-section" style="display: none;">
                        <label class="form-label">–¢–∏–ø –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:</label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="literary_type" id="literary_poem" value="poem" checked>
                                <label class="form-check-label" for="literary_poem">
                                    <i class="bi bi-file-earmark-text"></i> –°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="literary_type" id="literary_story" value="story">
                                <label class="form-check-label" for="literary_story">
                                    <i class="bi bi-book"></i> –ü–æ–≤–µ—Å—Ç—å
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="literary_type" id="literary_drama" value="drama">
                                <label class="form-check-label" for="literary_drama">
                                    <i class="bi bi-film"></i> –î—Ä–∞–º–∞
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="literary_type" id="literary_random" value="random">
                                <label class="form-check-label" for="literary_random">
                                    <i class="bi bi-dice-3"></i> –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä
                                </label>
                            </div>
                        </div>
                        <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞</small>
                    </div>
                    
                    <!-- –°–æ–≥–ª–∞—Å–∏–µ —Å —ç—Ç–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏ -->
                    <div class="card mb-3 ethics-agreement" id="ethics-agreement-card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-check"></i> –≠—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h6>
                        </div>
                        <div class="card-body">
                            <div class="small text-muted mb-3">
                                <p><strong>–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞:</strong></p>
                                <ul class="mb-0">
                                    <li>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º –∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏</li>
                                    <li>–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–∫–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –æ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω–µ</li>
                                    <li>–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, —Ä–∞–∑–∂–∏–≥–∞—é—â–µ–≥–æ –Ω–µ–Ω–∞–≤–∏—Å—Ç—å –∏–ª–∏ –≤—Ä–∞–∂–¥—É</li>
                                    <li>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç –º–æ–¥–µ—Ä–∞—Ü–∏—é –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∏—á–µ—Å–∫–∏–º –Ω–æ—Ä–º–∞–º</li>
                                    <li>–í—ã –æ–±—è–∑—É–µ—Ç–µ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö</li>
                                </ul>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ethicsAgreement" required>
                                <label class="form-check-label fw-bold" for="ethicsAgreement">
                                    –Ø —Å–æ–≥–ª–∞—Å–µ–Ω(-–Ω–∞) —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –æ–±—è–∑—É—é—Å—å —Å–æ–±–ª—é–¥–∞—Ç—å —ç—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
                </form>

                <div id="results" class="mt-4" style="display: none;">
                    <h3 class="mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                    
                    <!-- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º -->
                    <div class="card mb-4 border-0 shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="m-0"><i class="bi bi-graph-up"></i> –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h4>
                        </div>
                        <div class="card-body" id="emotion-results">
                            <div class="emotion-analysis-container">
                                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
                            </div>
                        </div>
                        <div class="card-footer bg-light" id="emotion-feedback" style="display: none;">
                            <div class="feedback-section" data-type="emotion">
                                <span class="text-muted me-3">–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞:</span>
                                <button class="btn btn-primary btn-sm feedback-modal-btn" data-content-type="emotion_analysis" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                    <i class="bi bi-star"></i> –û—Ü–µ–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                    <div id="generated-content" style="display: none;">
                        <div class="card mb-4 border-0 shadow literary-section" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h4 class="m-0"><i class="bi bi-file-text"></i> –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h4>
                            </div>
                            <div class="card-body" id="literary-results"></div>
                            <div class="card-footer bg-light">
                                <div class="feedback-section d-flex justify-content-between align-items-center" data-type="text">
                                    <div>
                                    <span class="text-muted me-3">–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞:</span>
                                    <button class="btn btn-primary btn-sm feedback-modal-btn" data-content-type="literary_work" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                        <i class="bi bi-star"></i> –û—Ü–µ–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                                        </button>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm" id="download-text-btn" style="display: none;">
                                        <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç (.txt)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4 border-0 shadow image-section" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h4 class="m-0"><i class="bi bi-image"></i> –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è</h4>
                            </div>
                            <div class="card-body" id="image-results">
                                <div id="generated-image-container" class="text-center mb-3" style="display: none;">
                                    <img id="generated-image" class="img-fluid rounded shadow" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è" />
                                </div>
                                <div id="image-loading" style="display: none;">
                                    <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                                <div id="image-error" class="alert alert-danger" style="display: none;"></div>
                            </div>
                            <div class="card-footer bg-light" id="image-feedback" style="display: none;">
                                <div class="feedback-section" data-type="image">
                                    <span class="text-muted me-3">–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</span>
                                    <button class="btn btn-primary btn-sm feedback-modal-btn" data-content-type="generated_image" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                        <i class="bi bi-star"></i> –û—Ü–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4 border-0 shadow music-section">
                            <div class="card-header" style="background-color: #6f42c1; color: white;">
                                <h4 class="m-0"><i class="bi bi-music-note-beamed"></i> –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</h4>
                            </div>
                            <div class="card-body" id="music-results">
                                <div id="generated-music-container" class="text-center mb-3">
                                    <div class="ratio ratio-16x9 mb-3">
                                        <iframe id="music-iframe" src="" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º—É–∑—ã–∫–∞" allowfullscreen></iframe>
                                    </div>
                                    <div class="mb-3">
                                        <h5>–û–ø–∏—Å–∞–Ω–∏–µ –º—É–∑—ã–∫–∏:</h5>
                                        <p id="music-description" class="text-muted font-italic"></p>
                                    </div>
                                </div>
                                <div id="music-loading" style="display: none;">
                                    <div class="music-loading-container">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="spinner-border text-primary me-3" role="status">
                                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                            </div>
                                            <div>
                                                <h5 class="mb-1">üéµ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏</h5>
                                                <p class="text-muted mb-0" id="music-loading-status">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...</p>
                                            </div>
                                        </div>
                                        
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                 role="progressbar" style="width: 10%" id="music-progress-bar">
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-info" id="music-task-badge">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                                                <span class="badge bg-secondary" id="music-attempt-badge">–ü–æ–ø—ã—Ç–∫–∞ 1/30</span>
                                            </div>
                                            <small class="text-muted" id="music-timer">0:00</small>
                                        </div>
                                        
                                        <div class="mt-3 text-center">
                                            <small class="text-muted">
                                                ‚è±Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 6-7 –º–∏–Ω—É—Ç<br>
                                                üéº –°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div id="music-error" class="alert alert-danger" style="display: none;">
                                    <span id="music-error-text"></span>
                                </div>
                            </div>
                            <div class="card-footer bg-light" id="music-feedback" style="display: none;">
                                <div class="feedback-section" data-type="music">
                                    <span class="text-muted me-3">–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –º—É–∑—ã–∫–∏:</span>
                                    <button class="btn btn-primary btn-sm feedback-modal-btn" data-content-type="generated_music" data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                        <i class="bi bi-star"></i> –û—Ü–µ–Ω–∏—Ç—å –º—É–∑—ã–∫—É
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if current_user.is_authenticated %}
                    <button id="share-results" class="btn btn-primary mt-3" style="display: none;">
                        <i class="bi bi-share-fill"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–∞ —Ñ–æ—Ä—É–º–µ
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä—É–º -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="mb-0">–§–æ—Ä—É–º</h3>
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('new_topic') }}" class="btn btn-primary btn-sm">–ù–æ–≤–∞—è —Ç–µ–º–∞</a>
                    {% endif %}
                </div>
                <div class="btn-group btn-group-sm w-100">
                    <a href="{{ url_for('index', sort='date') }}" 
                       class="btn btn-outline-secondary {% if current_sort == 'date' %}active{% endif %}">
                        –ü–æ –¥–∞—Ç–µ
                    </a>
                    <a href="{{ url_for('index', sort='likes') }}" 
                       class="btn btn-outline-secondary {% if current_sort == 'likes' %}active{% endif %}">
                        –ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if topics %}
                    <div class="list-group">
                    {% for topic in topics %}
                        <a href="{{ url_for('view_topic', topic_id=topic.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ topic.title }}</h5>
                                <small>{{ topic.created_at.strftime('%d.%m.%Y') }}</small>
                            </div>
                            <small>–ê–≤—Ç–æ—Ä: {{ topic.author.username }}</small>
                        </a>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–µ–º –Ω–∞ —Ñ–æ—Ä—É–º–µ.</p>
                {% endif %}

                {% if not current_user.is_authenticated %}
                    <div class="alert alert-info mt-3">
                        <a href="{{ url_for('login') }}">–í–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ 
                        <a href="{{ url_for('register') }}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a> 
                        —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Ç–µ–º—É
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">
                    <i class="bi bi-star-fill text-warning"></i> –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="detailedFeedbackForm">
                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
                    <div class="mb-4">
                        <h6 class="fw-bold" id="contentTypeName">–û—Ü–µ–Ω–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h6>
                        <p class="text-muted small" id="contentTypeDescription">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
                    </div>
                    
                    <!-- –ó–≤—ë–∑–¥–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:</label>
                        <div class="star-rating d-flex align-items-center">
                            <div class="stars me-3">
                                <i class="bi bi-star star" data-rating="1"></i>
                                <i class="bi bi-star star" data-rating="2"></i>
                                <i class="bi bi-star star" data-rating="3"></i>
                                <i class="bi bi-star star" data-rating="4"></i>
                                <i class="bi bi-star star" data-rating="5"></i>
                            </div>
                            <span class="rating-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</span>
                        </div>
                        <input type="hidden" id="starRating" name="rating" value="0">
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ -->
                    <div class="mb-4" id="detailedCriteria">
                        <label class="form-label fw-bold">–î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:</label>
                        
                        <!-- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
                        <div id="criteriaContainer"></div>
                    </div>
                    
                    <!-- –¢–µ–∫—Å—Ç–æ–≤–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
                    <div class="mb-4">
                        <label for="feedbackText" class="form-label fw-bold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                        <textarea class="form-control" id="feedbackText" name="feedback_text" rows="4" 
                                  placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏..."></textarea>
                        <div class="form-text">–í–∞—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ, –∞ —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å</div>
                    </div>
                    
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è -->
                    <input type="hidden" id="contentType" name="content_type" value="">
                    <input type="hidden" id="sessionId" name="session_id" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="submitFeedback">
                    <i class="bi bi-check-circle"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let lastAnalysisResults = null;

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (–ª–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏)
document.addEventListener('DOMContentLoaded', function() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('feedback-btn') || e.target.closest('.feedback-btn')) {
            const button = e.target.classList.contains('feedback-btn') ? e.target : e.target.closest('.feedback-btn');
            const feedbackType = button.getAttribute('data-feedback'); // 'like' –∏–ª–∏ 'dislike'
            const contentType = button.getAttribute('data-content-type'); // 'literary_work', 'generated_image', 'generated_music'
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–µ–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏—è
            const feedbackSection = button.closest('.feedback-section');
            if (feedbackSection) {
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏
                const allButtons = feedbackSection.querySelectorAll('.feedback-btn');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —Å–µ–∫—Ü–∏–∏
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('active', 'btn-success', 'btn-danger');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–ª–∞—Å—Å—ã
                    if (btn.getAttribute('data-feedback') === 'like') {
                        btn.className = 'btn btn-outline-success btn-sm feedback-btn';
                    } else {
                        btn.className = 'btn btn-outline-danger btn-sm ms-2 feedback-btn';
                    }
                });
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
                button.classList.add('active');
                if (feedbackType === 'like') {
                    button.classList.remove('btn-outline-success');
                    button.classList.add('btn-success');
                } else {
                    button.classList.remove('btn-outline-danger');
                    button.classList.add('btn-danger');
                }
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            submitFeedback(contentType, feedbackType, button);
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è —Å —ç—Ç–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏
    const ethicsAgreement = document.getElementById('ethicsAgreement');
    const ethicsCard = document.getElementById('ethics-agreement-card');
    const submitButton = document.querySelector('#diary-form button[type="submit"]');
    
    if (ethicsAgreement && submitButton) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Ä–∞–Ω–µ–µ –¥–∞–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage)
        const previousAgreement = localStorage.getItem('ethicsAgreementAccepted');
        
        if (previousAgreement === 'true') {
            // –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ —É–∂–µ –±—ã–ª–æ –¥–∞–Ω–æ, —Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            if (ethicsCard) {
                ethicsCard.style.display = 'none';
            }
            ethicsAgreement.checked = true;
            updateSubmitButton();
        } else {
            // –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–µ –±—ã–ª–æ –¥–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            if (ethicsAgreement.checked) {
                submitButton.disabled = false;
                submitButton.classList.remove('btn-secondary');
                submitButton.classList.add('btn-primary');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('btn-secondary');
                submitButton.classList.remove('btn-primary');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
        ethicsAgreement.addEventListener('change', function() {
            updateSubmitButton();
            
            if (this.checked) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –≤ localStorage
                localStorage.setItem('ethicsAgreementAccepted', 'true');
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—à–∫–∏
                if (ethicsCard) {
                    ethicsCard.classList.add('fade-out');
                    
                    // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É —á–µ—Ä–µ–∑ 300ms
                    setTimeout(() => {
                        ethicsCard.style.display = 'none';
                        ethicsCard.classList.remove('fade-out');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏
                        showNotification('–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —ç—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–æ—Ä–º! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–Ω–µ–≤–Ω–∏–∫–∏.', 'success');
                    }, 300);
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω—è–ª –≥–∞–ª–æ—á–∫—É, —É–¥–∞–ª—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                localStorage.removeItem('ethicsAgreementAccepted');
                if (ethicsCard && ethicsCard.style.display === 'none') {
                    ethicsCard.style.display = 'block';
                    ethicsCard.classList.add('fadeIn');
                }
            }
        });
    }
});

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
async function submitFeedback(contentType, feedbackType, buttonElement) {
    try {
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        const originalText = buttonElement.innerHTML;
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="bi bi-check-circle"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
        
        const response = await fetch('/submit_feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content_type: contentType,
                feedback_type: feedbackType,
                timestamp: new Date().toISOString()
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
            buttonElement.innerHTML = feedbackType === 'like' ? 
                '<i class="bi bi-hand-thumbs-up-fill"></i> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 
                '<i class="bi bi-hand-thumbs-down-fill"></i> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ
            if (data.total_count !== undefined) {
                const countElement = buttonElement.querySelector('.feedback-count');
                if (countElement) {
                    countElement.textContent = data.total_count;
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å
            showFeedbackNotification('–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.', 'success');
            
        } else {
            // –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            buttonElement.innerHTML = originalText;
            buttonElement.disabled = false;
            showFeedbackNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:', error);
        buttonElement.innerHTML = originalText;
        buttonElement.disabled = false;
        showFeedbackNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
function showFeedbackNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info', duration = 3000) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1055; max-width: 350px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const icon = type === 'success' ? 'bi bi-check-circle' : 
                 type === 'error' ? 'bi bi-exclamation-triangle' : 
                 type === 'warning' ? 'bi bi-exclamation-triangle' : 'bi bi-info-circle';
    
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="${icon} me-2"></i>
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            notification.classList.add('fade');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 150);
        }
    }, duration);
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    const diaryForm = document.getElementById('diary-form');
    
    if (diaryForm) {
        diaryForm.addEventListener('submit', async function(e) {
            // –Ø–≤–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
            e.preventDefault();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            const selectedTypes = Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value);
            if (selectedTypes.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                return;
            }
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (this.classList.contains('processing')) {
                console.log('–§–æ—Ä–º–∞ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è');
                return;
            }
            
            this.classList.add('processing');
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
            }
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            let statusElement = null;
            try {
                statusElement = document.createElement('div');
                statusElement.className = 'alert alert-info mt-3';
                statusElement.innerHTML = '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30-60 —Å–µ–∫—É–Ω–¥)...';
                this.appendChild(statusElement);
            } catch (err) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞:', err);
            }
            
            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /analyze...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è fetch —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AbortController
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã —Ç–∞–π–º–∞—É—Ç
                
                const diaryText = document.getElementById('diary_text').value;
                const generationTypes = Array.from(document.querySelectorAll('.generation-type:checked')).map(el => el.value);

                // --- DEBUGGING START ---
                console.log("–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...");
                console.log("–í—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã:", document.querySelectorAll('.generation-type:checked'));
                console.log("–ó–Ω–∞—á–µ–Ω–∏—è generationTypes:", generationTypes);
                // --- DEBUGGING END ---

                const formData = new FormData();
                formData.append('diary_text', diaryText);
                generationTypes.forEach(type => {
                    formData.append('generation_types[]', type);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                const literaryType = document.querySelector('input[name="literary_type"]:checked')?.value || 'random';
                formData.append('literary_type', literaryType);

                // --- DEBUGGING START ---
                console.log("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ formData –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:");
                for (let pair of formData.entries()) {
                    console.log(pair[0]+ ': ' + pair[1]); 
                }
                // --- DEBUGGING END ---
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ URLSearchParams
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId); // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–∞—É—Ç, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω
                
                console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (statusElement && statusElement.parentNode) {
                    statusElement.className = 'alert alert-success mt-3';
                    statusElement.textContent = '–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –º–æ–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ JSON
                const contentTypeHeader = response.headers.get('content-type'); // Renamed to avoid conflict
                if (!contentTypeHeader || !contentTypeHeader.includes('application/json')) {
                    console.error('–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON:', contentTypeHeader);
                    throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
                }
                
                const text = await response.text();
                // --- NEW DEBUGGING START ---
                console.log('–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤):', text.substring(0, 2000) + (text.length > 2000 ? '...' : ''));
                // --- NEW DEBUGGING END ---
                
                let data;
                try {
                    data = JSON.parse(text);
                    // --- NEW DEBUGGING START ---
                    console.log('–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (data):', data);
                    if (data && typeof data.generated_literary_work !== 'undefined') {
                        console.log('data.generated_literary_work:', data.generated_literary_work);
                        console.log('–¢–∏–ø data.generated_literary_work:', typeof data.generated_literary_work);
                        if (data.generated_literary_work) {
                             console.log('–î–ª–∏–Ω–∞ data.generated_literary_work:', data.generated_literary_work.length);
                        }
                    } else {
                        console.log('data.generated_literary_work –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ undefined –≤ –æ–±—ä–µ–∫—Ç–µ data.');
                    }
                    // --- NEW DEBUGGING END ---
                } catch (jsonError) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', jsonError, "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –±—ã–ª:", text);
                    throw new Error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON');
                }
                
                if (response.ok) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º
                    try {
                        if (statusElement && statusElement.parentNode === this) {
                            this.removeChild(statusElement);
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç:', e);
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                    const diaryText = document.getElementById('diary_text');
                    lastAnalysisResults = {
                        diary_text: diaryText ? diaryText.value : '',
                        emotion_analysis: data.emotion_analysis || {},
                        generated_literary_work: data.generated_literary_work || '',
                        generation_types: Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value)
                    };
                    
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º DOM
                    const resultsElement = document.getElementById('results');
                    if (resultsElement) {
                        resultsElement.style.display = 'block';
                    }
                    
                    const shareElement = document.getElementById('share-results');
                    if (shareElement) {
                        shareElement.style.display = 'block';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    updateGenerationUI();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                    const generatedContentElement = document.getElementById('generated-content');
                    if (generatedContentElement) {
                        generatedContentElement.style.display = 'block';
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    const emotionResults = document.getElementById('emotion-results');
                    if (emotionResults) {
                        const emotions = data.emotion_analysis || {};
                        let emotionHtml = '<div class="emotion-analysis">';
                        
                        if (emotions.primary_emotions && Array.isArray(emotions.primary_emotions)) {
                            emotionHtml += '<div class="mb-3"><h5>–û—Å–Ω–æ–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏:</h5><ul class="list-unstyled">';
                            emotions.primary_emotions.forEach(emotion => {
                                if (emotion && emotion.emotion) {
                                    const intensity = emotion.intensity || 0;
                                    const barWidth = (intensity / 10) * 100;
                                    emotionHtml += `
                                        <li class="mb-2">
                                            <strong>${emotion.emotion}</strong>: ${intensity}/10
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-primary" style="width: ${barWidth}%"></div>
                                            </div>
                                        </li>`;
                                }
                            });
                            emotionHtml += '</ul></div>';
                        }
                        
                        if (emotions.emotional_tone) {
                            emotionHtml += `<div class="mb-3"><h5>–û–±—â–∏–π —Ç–æ–Ω:</h5><p class="text-muted">${emotions.emotional_tone}</p></div>`;
                        }
                        
                        if (emotions.hidden_motives && emotions.hidden_motives.length > 0) {
                            emotionHtml += `<div class="mb-3"><h5>–°–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã:</h5><p class="text-muted">${emotions.hidden_motives.join(', ')}</p></div>`;
                        }
                        
                        if (emotions.attitude) {
                            emotionHtml += `<div class="mb-3"><h5>–û—Ç–Ω–æ—à–µ–Ω–∏–µ:</h5><p class="text-muted">${emotions.attitude}</p></div>`;
                        }
                        
                        // –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª: –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
                        if (emotions.thematic_analysis) {
                            const thematic = emotions.thematic_analysis;
                            emotionHtml += '<div class="mb-3"><h5>–¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–æ–µ–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π:</h5>';
                            
                            if (thematic.military_characters && thematic.military_characters.length > 0) {
                                emotionHtml += `
                                    <div class="mb-2">
                                        <strong><i class="bi bi-person-badge"></i> –í–æ–µ–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:</strong> 
                                        <span class="text-muted">${thematic.military_characters.join(', ')}</span>
                                    </div>`;
                            }
                            
                            if (thematic.battle_locations && thematic.battle_locations.length > 0) {
                                emotionHtml += `
                                    <div class="mb-2">
                                        <strong><i class="bi bi-geo-alt"></i> –ú–µ—Å—Ç–∞ —Å—Ä–∞–∂–µ–Ω–∏–π:</strong> 
                                        <span class="text-muted">${thematic.battle_locations.join(', ')}</span>
                                    </div>`;
                            }
                            
                            if (thematic.war_equipment && thematic.war_equipment.length > 0) {
                                emotionHtml += `
                                    <div class="mb-2">
                                        <strong><i class="bi bi-shield"></i> –í–æ–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞:</strong> 
                                        <span class="text-muted">${thematic.war_equipment.join(', ')}</span>
                                    </div>`;
                            }
                            
                            if (thematic.frontline_life && thematic.frontline_life.length > 0) {
                                emotionHtml += `
                                    <div class="mb-2">
                                        <strong><i class="bi bi-house"></i> –§—Ä–æ–Ω—Ç–æ–≤–∞—è –∂–∏–∑–Ω—å:</strong> 
                                        <span class="text-muted">${thematic.frontline_life.join(', ')}</span>
                                    </div>`;
                            }
                            
                            if (thematic.historical_events && thematic.historical_events.length > 0) {
                                emotionHtml += `
                                    <div class="mb-2">
                                        <strong><i class="bi bi-calendar-event"></i> –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è:</strong> 
                                        <span class="text-muted">${thematic.historical_events.join(', ')}</span>
                                    </div>`;
                            }
                            
                            emotionHtml += '</div>';
                        }
                        
                        emotionHtml += '</div>';
                        emotionResults.innerHTML = emotionHtml;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ü–µ–Ω–∫–∏ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                        showFeedbackButtons();
                    }
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, 
                    // –ø–æ–ª—É—á–µ–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∏—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–±–æ –∫–æ–Ω—Ç–µ–Ω—Ç, –ª–∏–±–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    selectedTypes.forEach((contentType, index) => {
                        const delay = index * 200; // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                        
                        if (contentType === 'text') {
                            const literarySection = document.querySelector('.literary-section');
                            if (literarySection) {
                                literarySection.style.display = 'block';
                                setTimeout(() => literarySection.classList.add('fadeIn'), delay);
                                
                                // --- NEW DEBUGGING START ---
                                console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –ü—Ä–æ–≤–µ—Ä–∫–∞ data.generated_literary_work. –ó–Ω–∞—á–µ–Ω–∏–µ:", data.generated_literary_work);
                                // --- NEW DEBUGGING END ---
                                
                                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                if (data.generated_literary_work) {
                                    // --- NEW DEBUGGING START ---
                                    console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –£—Å–ª–æ–≤–∏–µ if (data.generated_literary_work) –ò–°–¢–ò–ù–ù–û. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç.");
                                    // --- NEW DEBUGGING END ---
                                    const literaryResultsElement = document.getElementById('literary-results');
                                    const literarySectionElement = document.querySelector('.literary-section');

                                    if (literaryResultsElement && literarySectionElement) {
                                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                        const literaryTypeDisplay = {
                                            'poem': '–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ',
                                            'story': '–ü–æ–≤–µ—Å—Ç—å', 
                                            'drama': '–î—Ä–∞–º–∞',
                                            'random': '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ'
                                        };
                                        
                                        const selectedLiteraryType = document.querySelector('input[name="literary_type"]:checked')?.value || 'random';
                                        const typeDisplayName = literaryTypeDisplay[selectedLiteraryType] || '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
                                        
                                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏
                                        const literaryHeader = literarySectionElement.querySelector('.card-header h4');
                                        if (literaryHeader) {
                                            literaryHeader.innerHTML = `<i class="bi bi-file-text"></i> ${typeDisplayName}`;
                                        }
                                        
                                        literaryResultsElement.innerHTML = `<p class="text-muted">${data.generated_literary_work}</p>`;
                                        
                                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å !important
                                        literarySectionElement.style.setProperty('display', 'block', 'important');
                                        literarySectionElement.style.setProperty('visibility', 'visible', 'important');
                                        literarySectionElement.style.setProperty('opacity', '1', 'important');
                                        literarySectionElement.style.setProperty('height', 'auto', 'important'); // –ß—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—ã—Å–æ—Ç–∞ –Ω–µ 0
                                        literarySectionElement.style.setProperty('overflow', 'visible', 'important');


                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                                        const literaryFeedbackSection = literarySectionElement.querySelector('.card-footer');
                                        if (literaryFeedbackSection) {
                                            literaryFeedbackSection.style.setProperty('display', 'block', 'important');
                                    }
                                        
                                    const generatedContentElement = document.getElementById('generated-content');
                                    if (generatedContentElement) {
                                            generatedContentElement.style.setProperty('display', 'block', 'important');
                                        }

                                        // --- NEW DEBUGGING START ---
                                        setTimeout(() => { // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Å—Ç–∏–ª–∏ —É—Å–ø–µ–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å—Å—è
                                            const rect = literarySectionElement.getBoundingClientRect();
                                            console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã. –†–∞–∑–º–µ—Ä—ã .literary-section:", rect);
                                            if (rect.height === 0 || rect.width === 0) {
                                                console.warn("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –í–Ω–∏–º–∞–Ω–∏–µ! –°–µ–∫—Ü–∏—è .literary-section –≤—Å–µ –µ—â–µ –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π!");
                                            }
                                             console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] Computed display:", window.getComputedStyle(literarySectionElement).display);
                                             console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] Computed visibility:", window.getComputedStyle(literarySectionElement).visibility);
                                             console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] Computed opacity:", window.getComputedStyle(literarySectionElement).opacity);
                                             console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] literaryResultsElement.innerHTML:", literaryResultsElement.innerHTML);
                                        }, 100);
                                        // --- NEW DEBUGGING END ---

                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                                        const downloadTextBtn = document.getElementById('download-text-btn');
                                        if (downloadTextBtn) {
                                            downloadTextBtn.style.display = 'inline-block';
                                            downloadTextBtn.onclick = function() {
                                                const textToSave = data.generated_literary_work;
                                                const filename = `literary_work_${new Date().toISOString().slice(0,10)}.txt`;
                                                const blob = new Blob([textToSave], {type: "text/plain;charset=utf-8"});
                                                const link = document.createElement('a');
                                                link.href = URL.createObjectURL(blob);
                                                link.download = filename;
                                                document.body.appendChild(link); // Required for Firefox
                                                link.click();
                                                document.body.removeChild(link);
                                            };
                                        }

                                    } else {
                                         console.error("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç #literary-results –∏–ª–∏ .literary-section –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.");
                                    }
                                }
                                // --- NEW DEBUGGING START ---
                                else {
                                    console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –£—Å–ª–æ–≤–∏–µ if (data.generated_literary_work) –õ–û–ñ–ù–û. –¢–µ–∫—Å—Ç –ù–ï –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω.");
                                    const literaryResultsContent = document.getElementById('literary-results') ? document.getElementById('literary-results').innerHTML : "–≠–ª–µ–º–µ–Ω—Ç #literary-results –Ω–µ –Ω–∞–π–¥–µ–Ω";
                                    console.log("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –¢–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ #literary-results:", literaryResultsContent);
                                }
                                // --- NEW DEBUGGING END ---
                            }
                            // --- NEW DEBUGGING START ---
                            else {
                                console.error("[–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç] –°–µ–∫—Ü–∏—è .literary-section –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                            }
                            // --- NEW DEBUGGING END ---
                        }
                        
                        if (contentType === 'image') {
                            const imageSection = document.querySelector('.image-section');
                            if (imageSection) {
                                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                imageSection.style.setProperty('display', 'block', 'important');
                                imageSection.style.setProperty('visibility', 'visible', 'important');
                                imageSection.style.setProperty('opacity', '1', 'important');
                                imageSection.style.setProperty('height', 'auto', 'important');
                                imageSection.style.setProperty('overflow', 'visible', 'important');

                                setTimeout(() => imageSection.classList.add('fadeIn'), delay);
                                
                                const generatedContentElement = document.getElementById('generated-content');
                                if (generatedContentElement) {
                                    generatedContentElement.style.setProperty('display', 'block', 'important');
                                }
                                
                                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
                                if (data.generated_image && data.generated_image.success && data.generated_image.image_url) {
                                    console.log("[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ API...");
                                    if (data.generated_image.external_url) {
                                        window.lastGeneratedImageExternalUrl = data.generated_image.external_url;
                                    }
                                    displayGeneratedImage(data.generated_image.image_url);
                                } else {
                                    // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ
                                    const loadingElement = document.getElementById('image-loading');
                                    if (loadingElement) {
                                        loadingElement.style.setProperty('display', 'block', 'important'); // –Ø–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
                                        if (data.generated_image && data.generated_image.error) {
                                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
                                            if (data.generated_image.type === 'content_policy_violation' && data.generated_image.can_regenerate_safe) {
                                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                                                loadingElement.innerHTML = `
                                                    <div class="alert alert-warning shadow-lg fade show p-4 mb-3" style="border-left: 6px solid #ffc107; animation: fadeIn 0.5s;">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                                            <div>
                                                                <h5 class="mb-1 fw-bold">–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h5>
                                                                <div class="text-muted small">–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ —Ç–µ–∫—Å—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–µ OpenAI.</div>
                                                            </div>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>${data.generated_image.error}</strong>
                                                        </div>
                                                        <div class="mb-3">
                                                            <ul class="mb-2 ps-4">
                                                                <li>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –æ—Ç—Ä—ã–≤–æ–∫ –¥–Ω–µ–≤–Ω–∏–∫–∞ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–π –Ω–∞—Å–∏–ª–∏—è</li>
                                                                <li>–ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å <b>—Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é</b> (–∫–∞—á–µ—Å—Ç–≤–æ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)</li>
                                                            </ul>
                                                            <div class="alert alert-info py-2 px-3 small mb-2">
                                                                <i class="bi bi-info-circle"></i> –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ —Å—Ü–µ–Ω –Ω–∞—Å–∏–ª–∏—è, –Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –∏ —ç–ø–æ—Ö–∏.
                                                            </div>
                                                        </div>
                                                        <button id="generate-safe-image" class="btn btn-lg btn-outline-warning w-100 fw-bold">
                                                            <i class="bi bi-shield-check"></i> –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é
                                                        </button>
                                                    </div>`;
                                                loadingElement.classList.remove('progress');
                                                
                                                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                                                document.getElementById('generate-safe-image').addEventListener('click', function() {
                                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                                                    loadingElement.innerHTML = `
                                                        <div class="alert alert-warning mb-3">
                                                            <i class="fas fa-exclamation-triangle"></i> 
                                                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è OpenAI. 
                                                            –ö–∞—á–µ—Å—Ç–≤–æ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–¥—É–º–∫–∏.
                                                        </div>
                                                        <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                                                        <div class="progress">
                                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                                 role="progressbar" style="width: 100%"></div>
                                                        </div>`;
                                                    
                                                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                                    fetch('/generate_safe_image', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/x-www-form-urlencoded',
                                                        },
                                                        body: new URLSearchParams({
                                                            diary_text: document.getElementById('diary_text').value
                                                        })
                                                    })
                                                    .then(response => {
                                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç - JSON
                                                        const contentType = response.headers.get('content-type');
                                                        if (!contentType || !contentType.includes('application/json')) {
                                                            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
                                                        }
                                                        return response.text();
                                                    })
                                                    .then(responseText => {
                                                        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                                                        let data;
                                                        try {
                                                            data = JSON.parse(responseText);
                                                            console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", data);
                                                        } catch (e) {
                                                            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e, "–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:", responseText);
                                                            throw new Error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON-–æ—Ç–≤–µ—Ç–∞");
                                                        }
                                                        
                                                        if (data.success && data.image_url) {
                                                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                                            if (data.external_url) {
                                                                window.lastGeneratedImageExternalUrl = data.external_url;
                                                            }
                                                            
                                                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                                            displayGeneratedImage(data.image_url);
                                                            
                                                            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–µ
                                                            const noticeElement = document.createElement('div');
                                                            noticeElement.className = 'alert alert-info mt-3';
                                                            noticeElement.innerHTML = `
                                                                <i class="fas fa-info-circle"></i>
                                                                –ë—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞.
                                                            `;
                                                            document.getElementById('image-results').appendChild(noticeElement);
                                                        } else {
                                                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                                                            loadingElement.innerHTML = `
                                                                <div class="alert alert-danger">
                                                                    <i class="fas fa-exclamation-triangle"></i>
                                                                    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–∂–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                                                </div>`;
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                                                        loadingElement.innerHTML = `
                                                            <div class="alert alert-danger">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                                            </div>`;
                                                    });
                                                });
                                            } else {
                                                // –û–±—ã—á–Ω–∞—è –æ—à–∏–±–∫–∞
                                                loadingElement.innerHTML = `
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle"></i> 
                                                        –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.generated_image.error}
                                                    </div>`;
                                                loadingElement.classList.remove('progress');
                                            }
                                        } else {
                                            // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                            loadingElement.innerHTML = `
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.
                                                </div>`;
                                            loadingElement.classList.remove('progress');
                                        }
                                    }
                                }
                            } else {
                                console.error("[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ] –°–µ–∫—Ü–∏—è .image-section –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                            }
                        }
                        
                        if (contentType === 'music') {
                            const musicSection = document.querySelector('.music-section');
                            if (musicSection) {
                                musicSection.style.display = 'block';
                                setTimeout(() => musicSection.classList.add('fadeIn'), delay);
                                
                                // –ï—Å–ª–∏ –º—É–∑—ã–∫–∞ –≥–æ—Ç–æ–≤–∞ –∏–ª–∏ –µ—Å—Ç—å task_id –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
                                if (data.generated_music) {
                                    console.log("–î–∞–Ω–Ω—ã–µ –æ –º—É–∑—ã–∫–µ –ø–æ–ª—É—á–µ–Ω—ã:", data.generated_music);
                                    displayGeneratedMusic(data.generated_music);
                                }
                            }
                        }
                    });
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                } else {
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ HTTP
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                if (statusElement) {
                    statusElement.className = 'alert alert-danger mt-3';
                    statusElement.innerHTML = `
                        <strong>–û—à–∏–±–∫–∞:</strong> ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞'}
                        <br><small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</small>
                    `;
                }
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
                this.classList.remove('processing');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
                }
            }
        });
    }
});

document.getElementById('share-results')?.addEventListener('click', async function() {
    if (!lastAnalysisResults) {
        alert('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
        return;
    }
    
    try {
        const response = await fetch('/share_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(lastAnalysisResults)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            window.location.href = data.redirect_url;
        } else {
            alert(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
        }
    } catch (error) {
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const generationOptions = document.querySelectorAll('.generation-type');
    generationOptions.forEach(option => {
        option.addEventListener('change', updateGenerationUI);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–í—ã–±—Ä–∞—Ç—å –≤—Å—ë"
    const selectAllBtn = document.getElementById('select-all-btn');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.generation-type');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateGenerationUI();
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            this.textContent = allChecked ? '–í—ã–±—Ä–∞—Ç—å –≤—Å—ë' : '–°–Ω—è—Ç—å –≤—ã–±–æ—Ä';
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    updateGenerationUI();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function displayGeneratedImage(imageUrl) {
    console.log("–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", imageUrl);
    const imageContainer = document.getElementById('generated-image-container');
    const imageElement = document.getElementById('generated-image');
    const loadingElement = document.getElementById('image-loading');
    const errorElement = document.getElementById('image-error');
    
    // --- –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ---
    let downloadButtonContainer = document.getElementById('image-download-button-container');
    if (!downloadButtonContainer) {
        downloadButtonContainer = document.createElement('div');
        downloadButtonContainer.id = 'image-download-button-container';
        downloadButtonContainer.className = 'mt-2 text-center';
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ imageContainer, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–ª–∏ –≤ image-results
        const imageContainerParent = imageContainer ? imageContainer.parentNode : document.getElementById('image-results');
        if (imageContainerParent) {
            imageContainerParent.appendChild(downloadButtonContainer);
        }
    }
    downloadButtonContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–Ω–æ–ø–∫–∏
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---
    
    if (!imageContainer || !imageElement) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –Ω–µ –ø—É—Å—Ç–æ–π
    if (!imageUrl || imageUrl === 'undefined') {
        console.error("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
        if (errorElement) {
            errorElement.textContent = "–ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
            errorElement.style.display = 'block';
        }
        if (loadingElement) loadingElement.style.display = 'none';
        return;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let normalizedUrl = imageUrl;
    
    // –ï—Å–ª–∏ URL —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –≤–µ—Ä–æ—è—Ç–Ω–æ, –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫—É
    if (normalizedUrl.length > 1000) {
        console.warn("–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –¥–ª–∏–Ω–Ω—ã–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", normalizedUrl.length, "—Å–∏–º–≤–æ–ª–æ–≤");
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–≤–æ–π–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏
        if (normalizedUrl.includes('%25')) {
            normalizedUrl = decodeURIComponent(normalizedUrl);
            console.log("–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω URL —Å –¥–≤–æ–π–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π");
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±—É–¥—É—â–µ–º
    if (normalizedUrl && normalizedUrl.startsWith('http')) {
        window.lastGeneratedImageExternalUrl = normalizedUrl;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏ –æ—à–∏–±–∫–∏
    if (loadingElement) loadingElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    if (loadingElement) loadingElement.style.display = 'block';
    
    // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
    let retryCount = 0;
    const maxRetries = 3;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function tryLoadImage(url) {
        console.log(`–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${retryCount+1}/${maxRetries+1}:`, url);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        imageElement.onerror = function() {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount+1}/${maxRetries+1}):`, url);
            
            // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏
            retryCount++;
            
            if (retryCount <= maxRetries) {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã URL
                if (retryCount === 1 && url.startsWith('/')) {
                    // –ï—Å–ª–∏ URL –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /, –ø—Ä–æ–±—É–µ–º –±–µ–∑ /
                    setTimeout(() => tryLoadImage(url.substring(1)), 500);
                } else if (retryCount === 2 && url.includes('//')) {
                    // –ï—Å–ª–∏ URL —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–≤–æ–π–Ω–æ–π —Å–ª–µ—à, –ø—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å
                    const fixedUrl = url.replace(/([^:])\/\/+/g, '$1/');
                    setTimeout(() => tryLoadImage(fixedUrl), 500);
                } else if (window.lastGeneratedImageExternalUrl && window.lastGeneratedImageExternalUrl !== url) {
                    // –ü—Ä–æ–±—É–µ–º –≤–Ω–µ—à–Ω–∏–π URL
                    setTimeout(() => tryLoadImage(window.lastGeneratedImageExternalUrl), 500);
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                    showImageLoadError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
                }
            } else {
                // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                showImageLoadError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫");
            }
        };
        
        imageElement.onload = function() {
            console.log("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:", url);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–∫–∏
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorElement) errorElement.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            imageContainer.style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imageFeedback = document.getElementById('image-feedback');
            if (imageFeedback) {
                imageFeedback.style.display = 'block';
            }

            // --- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ---
            const downloadBtn = document.createElement('a');
            downloadBtn.href = url; 
            downloadBtn.download = `generated_image_${new Date().toISOString().slice(0,10)}.png`; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º png, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —É–º–Ω–µ–µ
            downloadBtn.className = 'btn btn-outline-secondary btn-sm';
            downloadBtn.innerHTML = '<i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            downloadButtonContainer.appendChild(downloadBtn);
            // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ ---
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
        const cacheBuster = `?t=${new Date().getTime()}`;
        imageElement.src = url + cacheBuster;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    function showImageLoadError(message) {
        if (loadingElement) loadingElement.style.display = 'none';
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        console.error(message);
    }
    
    // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    tryLoadImage(normalizedUrl);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏
function checkMusicGenerationStatus(taskId) {
    if (!taskId) {
        console.error("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID –∑–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞");
        return;
    }
    
    console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏ –¥–ª—è –∑–∞–¥–∞—á–∏: ${taskId}`);
    
    // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
    let attempts = 0;
    const maxAttempts = 80; // 80 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥ = ~6.7 –º–∏–Ω—É—Ç
    let startTime = new Date();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingElement = document.getElementById('music-loading');
    const errorElement = document.getElementById('music-error');
    const musicContainer = document.getElementById('generated-music-container');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const statusElement = document.getElementById('music-loading-status');
    const progressBar = document.getElementById('music-progress-bar');
    const taskBadge = document.getElementById('music-task-badge');
    const attemptBadge = document.getElementById('music-attempt-badge');
    const timerElement = document.getElementById('music-timer');
    
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–µ–∫—Ü–∏—è –º—É–∑—ã–∫–∏ –≤–∏–¥–∏–º–∞
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        musicSection.style.display = 'block';
    }
    
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    if (errorElement) errorElement.style.display = 'none';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É
    if (taskBadge) {
        taskBadge.textContent = `ID: ${taskId.substring(0, 8)}...`;
        taskBadge.className = 'badge bg-info';
    }
    
    // –¢–∞–π–º–µ—Ä
    function updateTimer() {
        if (timerElement) {
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    const timerInterval = setInterval(updateTimer, 1000);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
    function checkStatus() {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
        attempts++;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        if (attemptBadge) {
            attemptBadge.textContent = `–ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}`;
        }
        
        if (statusElement) {
            const statuses = [
                '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Suno AI...',
                '–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞...',
                '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏...',
                '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...',
                '–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–∞...'
            ];
            const statusIndex = Math.min(Math.floor(attempts / 16), statuses.length - 1);
            statusElement.textContent = statuses[statusIndex];
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        if (progressBar) {
            const progress = Math.min(95, Math.round((attempts / maxAttempts) * 100));
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }
        
        fetch(`/check_music_status?task_id=${taskId}&t=${new Date().getTime()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è –∑–∞–¥–∞—á–∏ ${taskId} (–ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}):`, data);
                
                // –ï—Å–ª–∏ –º—É–∑—ã–∫–∞ –≥–æ—Ç–æ–≤–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–µ
                if (data.status === 'complete' || data.is_music_ready === true || 
                    data.audio_url || data.stream_url || data.local_audio_url || 
                    data.proxy_url) {
                    
                    console.log("–ú—É–∑—ã–∫–∞ –≥–æ—Ç–æ–≤–∞! –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–ª–µ–µ—Ä:", data);
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                    clearInterval(timerInterval);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ 100%
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.className = 'progress-bar bg-success';
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = '‚úÖ –ú—É–∑—ã–∫–∞ –≥–æ—Ç–æ–≤–∞!';
                    }
                    
                    if (taskBadge) {
                        taskBadge.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
                        taskBadge.className = 'badge bg-success';
                    }
                    
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è –≤–∏–¥–Ω–∞
                    const musicSection = document.querySelector('.music-section');
                    if (musicSection && musicSection.style.display === 'none') {
                        musicSection.style.display = 'block';
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥–æ—Ç–æ–≤—É—é –º—É–∑—ã–∫—É –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞
                    setTimeout(() => {
                        displayGeneratedMusic(data);
                    }, 1000);
                    
                    return;
                }
                
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "timeout" –∏–ª–∏ –æ—à–∏–±–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                if (data.status === 'timeout' || data.status === 'error' || 
                    (data.success === false && attempts > 5)) {
                    
                    clearInterval(timerInterval);
                    
                    if (taskBadge) {
                        taskBadge.textContent = '–û—à–∏–±–∫–∞';
                        taskBadge.className = 'badge bg-danger';
                    }
                    
                    if (progressBar) {
                        progressBar.className = 'progress-bar bg-danger';
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                    }
                    
                    if (errorElement) {
                        let errorMessage = data.message || "API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏";
                        
                        errorElement.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏</h5>
                                <p>${errorMessage}</p>
                                <div class="mt-3">
                                    <p><strong>–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?</strong></p>
                                    <ul>
                                        <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É</li>
                                        <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</li>
                                        <li>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º</li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                                    –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                </button>
                            </div>
                        `;
                        errorElement.style.display = 'block';
                    }
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                    return;
                }
                
                // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
                if (attempts >= maxAttempts) {
                    clearInterval(timerInterval);
                    
                    if (taskBadge) {
                        taskBadge.textContent = '–¢–∞–π–º–∞—É—Ç';
                        taskBadge.className = 'badge bg-warning';
                    }
                    
                    if (progressBar) {
                        progressBar.className = 'progress-bar bg-warning';
                    }
                    
                    if (statusElement) {
                        statusElement.textContent = '‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
                    }
                    
                    if (errorElement) {
                        errorElement.innerHTML = `
                            <div class="alert alert-warning">
                                <h5>–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</h5>
                                <p>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏ –∑–∞–Ω—è–ª–∞ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å (–±–æ–ª–µ–µ 6-7 –º–∏–Ω—É—Ç).</p>
                                <p>–í–æ–∑–º–æ–∂–Ω–æ, –º—É–∑—ã–∫–∞ –≤—Å–µ –µ—â–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è. –í—ã –º–æ–∂–µ—Ç–µ:</p>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary mt-2" onclick="checkMusicGenerationStatus('${taskId}')">
                                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –µ—â–µ —Ä–∞–∑
                                    </button>
                                    <button class="btn btn-outline-secondary mt-2 ms-2" onclick="location.reload()">
                                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                    </button>
                                </div>
                            </div>
                        `;
                        errorElement.style.display = 'block';
                    }
                    
                    if (loadingElement) loadingElement.style.display = 'none';
                } else {
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
                    setTimeout(checkStatus, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:", error);
                
                clearInterval(timerInterval);
                
                if (taskBadge) {
                    taskBadge.textContent = '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏';
                    taskBadge.className = 'badge bg-danger';
                }
                
                if (progressBar) {
                    progressBar.className = 'progress-bar bg-danger';
                }
                
                if (statusElement) {
                    statusElement.textContent = 'üîå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                }
                
                if (errorElement) {
                    errorElement.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞</h5>
                            <p>${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏'}</p>
                            <button class="btn btn-outline-primary mt-2" onclick="checkMusicGenerationStatus('${taskId}')">
                                –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                            </button>
                        </div>
                    `;
                    errorElement.style.display = 'block';
                }
                
                if (loadingElement) loadingElement.style.display = 'none';
                
                // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 10000);
                }
            });
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    checkStatus();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏
function showMusicError(errorText, errorDetails = null, taskId = null) {
    const errorElement = document.getElementById('music-error');
    const errorTextElement = document.getElementById('music-error-text');
    
    if (errorElement) {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
        errorElement.innerHTML = '';
        errorElement.className = 'alert alert-danger';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—à–∏–±–∫–∏
        const errorHeader = document.createElement('h5');
        errorHeader.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏';
        errorElement.appendChild(errorHeader);
        
        // –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        const errorMsg = document.createElement('div');
        errorMsg.className = 'mb-2';
        errorMsg.textContent = errorText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        errorElement.appendChild(errorMsg);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
        if (errorDetails) {
            const detailsContainer = document.createElement('div');
            detailsContainer.className = 'alert alert-secondary small p-2 mb-2';
            
            // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –≤—ã–≤–æ–¥–∏–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            if (typeof errorDetails === 'object' && errorDetails !== null) {
                try {
                    detailsContainer.textContent = JSON.stringify(errorDetails, null, 2);
                } catch (e) {
                    detailsContainer.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏";
                }
            } else {
                detailsContainer.textContent = errorDetails;
            }
            
            errorElement.appendChild(detailsContainer);
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å task_id, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        if (taskId) {
            const taskInfo = document.createElement('div');
            taskInfo.className = 'small text-muted mb-2';
            taskInfo.textContent = `ID –∑–∞–¥–∞—á–∏: ${taskId}`;
            errorElement.appendChild(taskInfo);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ—à–µ–Ω–∏—é
        const solutionsTitle = document.createElement('h6');
        solutionsTitle.className = 'mt-3 mb-2';
        solutionsTitle.textContent = '–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:';
        errorElement.appendChild(solutionsTitle);
        
        const solutionsList = document.createElement('ul');
        solutionsList.className = 'small';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø–∏—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
        const solutions = [
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API –∫–ª—é—á SUNO –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ",
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω)",
            "–î–ª—è –æ—à–∏–±–æ–∫ 404: –≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–¥–∞—á–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ –ø—É—Ç—å –∫ API –Ω–µ–≤–µ—Ä–µ–Ω",
            "–î–ª—è –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è API –∫–ª—é—á–∞",
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ –∞–∫–∫–∞—É–Ω—Ç–µ SUNO"
        ];
        
        // –ï—Å–ª–∏ –≤ –æ—à–∏–±–∫–µ –µ—Å—Ç—å 404, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if (errorText && errorText.includes('404')) {
            solutions.unshift(
                "–≠—Ç–æ –æ—à–∏–±–∫–∞ '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ'. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–¥–∞—á–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞",
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
            );
        }
        
        // –ï—Å–ª–∏ –≤ –æ—à–∏–±–∫–µ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ status, –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
        if (errorText && errorText.includes('status')) {
            solutions.unshift(
                "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞. –í–æ–∑–º–æ–∂–Ω–æ, URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å—Ç–∞—Ä–µ–ª"
            );
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ä–µ—à–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫
        solutions.forEach(solution => {
            const solutionItem = document.createElement('li');
            solutionItem.textContent = solution;
            solutionsList.appendChild(solutionItem);
        });
        
        errorElement.appendChild(solutionsList);
        
        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        if (taskId) {
            const recheckButton = document.createElement('button');
            recheckButton.className = 'btn btn-sm btn-outline-primary mt-3';
            recheckButton.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –µ—â–µ —Ä–∞–∑';
            recheckButton.onclick = () => checkMusicGenerationStatus(taskId);
            errorElement.appendChild(recheckButton);
        }
        
        errorElement.style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º—É–∑—ã–∫–∏
function displayGeneratedMusic(musicData) {
    console.log("–ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ displayGeneratedMusic —Å –¥–∞–Ω–Ω—ã–º–∏:", musicData);
    
    // –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º —Å–µ–∫—Ü–∏—é –º—É–∑—ã–∫–∏ –≤–∏–¥–∏–º–æ–π
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        musicSection.style.display = 'block';
        musicSection.style.visibility = 'visible';
        musicSection.style.opacity = '1';
    }
    
    const musicContainer = document.getElementById('generated-music-container');
    const loadingElement = document.getElementById('music-loading');
    const errorElement = document.getElementById('music-error');
    
    if (!musicContainer) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º—É–∑—ã–∫–∏");
        return;
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫
    if (loadingElement) loadingElement.style.display = 'none';
    if (errorElement) errorElement.style.display = 'none';
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å musicData
    if (!musicData) {
        console.error("–û—à–∏–±–∫–∞: musicData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ null");
        if (errorElement) {
            errorElement.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏: –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ";
            errorElement.style.display = 'block';
        }
        return;
    }
    
    console.log("–î–∞–Ω–Ω—ã–µ –º—É–∑—ã–∫–∏:", musicData);
    
    // –ü–æ–ª—É—á–∞–µ–º URL –∞—É–¥–∏–æ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    const localAudioUrl = musicData.local_audio_url || '';
    const proxyUrl = musicData.proxy_url || '';
    const audioUrl = musicData.audio_url || '';
    const streamUrl = musicData.stream_url || '';
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π URL
    const finalAudioUrl = localAudioUrl || proxyUrl || audioUrl || streamUrl;
    console.log("–ò—Ç–æ–≥–æ–≤—ã–π URL –¥–ª—è –∞—É–¥–∏–æ:", finalAudioUrl);
    
    if (finalAudioUrl) {
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        musicContainer.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä
        const playerHTML = `
            <div class="music-player">
                <div class="music-player-content">
                    <!-- –û–±–ª–æ–∂–∫–∞ -->
                    <div class="music-cover ${musicData.cover_url ? '' : 'no-cover'}">
                        ${musicData.cover_url ? 
                            `<img src="${musicData.cover_url}" alt="–û–±–ª–æ–∂–∫–∞ —Ç—Ä–µ–∫–∞">` : 
                            `<div class="music-cover-placeholder">
                                <i class="bi bi-music-note-beamed" style="font-size: 60px;"></i>
                            </div>`
                        }
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ -->
                    <div class="music-info">
                        <h4 class="music-title">${musicData.music_title || '–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ'}</h4>
                        <p class="music-description">${musicData.music_description || '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–Ω–µ–≤–Ω–∏–∫–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞'}</p>
                        ${musicData.style ? `<span class="badge bg-light text-dark"><i class="bi bi-music-note"></i> ${musicData.style}</span>` : ''}
                        ${musicData.mood ? `<span class="badge bg-light text-dark ms-2"><i class="bi bi-emoji-smile"></i> ${musicData.mood}</span>` : ''}
                    </div>
                    
                    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –∞—É–¥–∏–æ –ø–ª–µ–µ—Ä -->
                    <div class="audio-player-custom">
                        <!-- –°–∫—Ä—ã—Ç—ã–π –Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–µ–µ—Ä -->
                        <audio id="custom-audio-player" preload="auto">
                            <source src="${finalAudioUrl}" type="audio/mpeg">
                        </audio>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                        <div class="audio-controls">
                            <button class="audio-btn" id="prev-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">
                                <i class="bi bi-skip-start-fill"></i>
                            </button>
                            <button class="audio-btn play-pause" id="play-pause-btn" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button class="audio-btn" id="next-btn" title="–°–ª–µ–¥—É—é—â–∏–π">
                                <i class="bi bi-skip-end-fill"></i>
                            </button>
                        </div>
                        
                        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                        <div class="progress-container" id="progress-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        
                        <!-- –í—Ä–µ–º—è -->
                        <div class="time-display">
                            <span id="current-time">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                        
                        <!-- –ì—Ä–æ–º–∫–æ—Å—Ç—å -->
                        <div class="volume-control">
                            <i class="bi bi-volume-up-fill"></i>
                            <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
                        </div>
                    </div>
                    
                    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                    <div class="text-center mt-3">
                        <a href="${finalAudioUrl}" download="music_${Date.now()}.mp3" class="download-btn">
                            <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å —Ç—Ä–µ–∫
                        </a>
                    </div>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º HTML –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        musicContainer.innerHTML = playerHTML;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä
        initCustomAudioPlayer();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        musicContainer.style.display = 'block';
        musicContainer.style.visibility = 'visible';
        musicContainer.style.opacity = '1';
        
        console.log("–°–æ–∑–¥–∞–Ω –∫—Ä–∞—Å–∏–≤—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä –¥–ª—è URL:", finalAudioUrl);
        
    } else if (musicData.task_id) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å task_id, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
        if (loadingElement) {
            loadingElement.style.display = 'block';
            loadingElement.innerHTML = `
                <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—É–∑—ã–∫–∏...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 50%"></div>
                </div>
                <span class="badge bg-info">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞—á–∏: ${musicData.task_id}</span>
            `;
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
        checkMusicGenerationStatus(musicData.task_id);
    } else {
        // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º—É–∑—ã–∫–∏
        if (errorElement) {
            errorElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏</strong>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –∞—É–¥–∏–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.</p>
                </div>
            `;
            errorElement.style.display = 'block';
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –º—É–∑—ã–∫–∏
    const musicFeedback = document.getElementById('music-feedback');
    if (musicFeedback) {
        musicFeedback.style.display = 'block';
    }
    
    console.log("–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞");
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∞—É–¥–∏–æ –ø–ª–µ–µ—Ä–∞
function initCustomAudioPlayer() {
    const audio = document.getElementById('custom-audio-player');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const currentTimeElem = document.getElementById('current-time');
    const durationElem = document.getElementById('duration');
    const volumeSlider = document.getElementById('volume-slider');
    const musicCover = document.querySelector('.music-cover');
    
    if (!audio || !playPauseBtn) return;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    audio.volume = volumeSlider.value / 100;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ play/pause
    playPauseBtn.addEventListener('click', function() {
        if (audio.paused) {
            audio.play();
            this.innerHTML = '<i class="bi bi-pause-fill"></i>';
            musicCover.classList.add('playing');
        } else {
            audio.pause();
            this.innerHTML = '<i class="bi bi-play-fill"></i>';
            musicCover.classList.remove('playing');
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    audio.addEventListener('timeupdate', function() {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = progress + '%';
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        currentTimeElem.textContent = formatTime(audio.currentTime);
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    audio.addEventListener('loadedmetadata', function() {
        durationElem.textContent = formatTime(audio.duration);
    });
    
    // –ö–ª–∏–∫ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—É
    progressContainer.addEventListener('click', function(e) {
        const clickX = e.offsetX;
        const width = this.offsetWidth;
        const duration = audio.duration;
        
        audio.currentTime = (clickX / width) * duration;
    });
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    volumeSlider.addEventListener('input', function() {
        audio.volume = this.value / 100;
    });
    
    // –û–∫–æ–Ω—á–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞
    audio.addEventListener('ended', function() {
        playPauseBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
        musicCover.classList.remove('playing');
        progressBar.style.width = '0%';
    });
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
function createBackupPlayer(audioUrl) {
    console.log("–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –ø–ª–µ–µ—Ä–æ–≤ –¥–ª—è URL:", audioUrl);
    
    if (!audioUrl) {
        console.error("–û—à–∏–±–∫–∞: –ø—É—Å—Ç–æ–π URL –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞");
        return;
    }
    
    const parentContainer = document.getElementById('music-results');
    if (!parentContainer) {
        console.error("–ù–µ –Ω–∞–π–¥–µ–Ω —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #music-results");
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–ª–µ–µ—Ä
    if (document.querySelector('.backup-player')) {
        console.log("–†–µ–∑–µ—Ä–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã, –¥–µ–ª–∞–µ–º –∏—Ö –≤–∏–¥–∏–º—ã–º–∏");
        document.querySelectorAll('.backup-player').forEach(player => {
            player.style.display = 'block';
        });
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –ø–ª–µ–µ—Ä–æ–≤
    const backupContainer = document.createElement('div');
    backupContainer.className = 'backup-player';
    backupContainer.style.cssText = 'border:2px solid #4a76a8 !important; border-radius:8px !important; padding:15px !important; margin:20px 0 !important; display:block !important;';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.createElement('h4');
    title.style.cssText = 'margin-bottom:15px !important; font-weight:bold !important;';
    title.textContent = '–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä—ã';
    backupContainer.appendChild(title);
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const info = document.createElement('p');
    info.style.cssText = 'margin-bottom:10px !important;';
    info.textContent = '–ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã:';
    backupContainer.appendChild(info);
    
    // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–ª–µ–µ—Ä
    const backupPlayerContainer = document.createElement('div');
    backupPlayerContainer.className = 'backup-player-item';
    backupPlayerContainer.style.cssText = 'border:1px solid #dddddd !important; padding:15px !important; margin-bottom:15px !important; border-radius:5px !important;';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–ª–µ–µ—Ä–∞
    const playerTitle = document.createElement('h5');
    playerTitle.textContent = '–í–∞—Ä–∏–∞–Ω—Ç 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTML5 –ø–ª–µ–µ—Ä';
    playerTitle.style.cssText = 'margin-bottom:10px !important; font-size:16px !important;';
    backupPlayerContainer.appendChild(playerTitle);
    
    // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
    const backupPlayer = document.createElement('audio');
    backupPlayer.controls = true;
    backupPlayer.preload = 'auto';
    backupPlayer.className = 'backup-audio-player';
    backupPlayer.style.cssText = 'display:block !important; width:100% !important; min-height:50px !important; visibility:visible !important; opacity:1 !important; border:2px solid #4a76a8 !important; margin:10px 0 !important;';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
    const source = document.createElement('source');
    source.src = audioUrl;
    source.type = 'audio/mpeg';
    backupPlayer.appendChild(source);
    
    // –¢–µ–∫—Å—Ç –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö –∞—É–¥–∏–æ
    backupPlayer.appendChild(document.createTextNode('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML5 –∞—É–¥–∏–æ.'));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–µ–µ—Ä –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    backupPlayerContainer.appendChild(backupPlayer);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å –∞—É–¥–∏–æ
    const actionsDiv = document.createElement('div');
    actionsDiv.style.cssText = 'display:flex !important; justify-content:center !important; gap:10px !important; margin-top:15px !important;';
    
    // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const downloadLink = document.createElement('a');
    downloadLink.href = audioUrl;
    downloadLink.download = 'music_download.mp3';
    downloadLink.className = 'btn btn-primary btn-sm';
    downloadLink.style.cssText = 'font-weight:bold !important;';
    downloadLink.innerHTML = '<i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ';
    actionsDiv.appendChild(downloadLink);
    
    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    const openLink = document.createElement('a');
    openLink.href = audioUrl;
    openLink.target = '_blank';
    openLink.className = 'btn btn-outline-primary btn-sm';
    openLink.style.cssText = 'font-weight:bold !important;';
    openLink.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ';
    actionsDiv.appendChild(openLink);
    
    backupPlayerContainer.appendChild(actionsDiv);
    backupContainer.appendChild(backupPlayerContainer);
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ç–æ—Ä–æ–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –ø—Ä–æ—Å—Ç—ã–º –∞—É–¥–∏–æ –±–µ–∑ —Å—Ç–∏–ª–µ–π
    const rawPlayerContainer = document.createElement('div');
    rawPlayerContainer.className = 'backup-player-item';
    rawPlayerContainer.style.cssText = 'border:1px solid #dddddd !important; padding:15px !important; margin-bottom:15px !important; border-radius:5px !important;';
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const rawPlayerTitle = document.createElement('h5');
    rawPlayerTitle.textContent = '–í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ—Å—Ç–æ–π –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä';
    rawPlayerTitle.style.cssText = 'margin-bottom:10px !important; font-size:16px !important;';
    rawPlayerContainer.appendChild(rawPlayerTitle);
    
    // –û–ø–∏—Å–∞–Ω–∏–µ
    const rawPlayerDesc = document.createElement('p');
    rawPlayerDesc.className = 'small text-muted';
    rawPlayerDesc.textContent = '–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–ª–µ–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö:';
    rawPlayerContainer.appendChild(rawPlayerDesc);
    
    // –°–æ–∑–¥–∞–µ–º HTML5 –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç
    const rawHtmlAudio = document.createElement('audio');
    rawHtmlAudio.controls = true;
    rawHtmlAudio.preload = 'auto';
    rawHtmlAudio.style.cssText = 'display:block !important; width:100% !important;';
    
    const rawSource = document.createElement('source');
    rawSource.src = audioUrl;
    rawSource.type = 'audio/mpeg';
    rawHtmlAudio.appendChild(rawSource);
    rawHtmlAudio.appendChild(document.createTextNode('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML5 –∞—É–¥–∏–æ.'));
    
    rawPlayerContainer.appendChild(rawHtmlAudio);
    
    // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª
    const directLinkContainer = document.createElement('div');
    directLinkContainer.className = 'mt-3';
    directLinkContainer.innerHTML = `
        <p class="small text-muted mb-1">–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª:</p>
        <a href="${audioUrl}" target="_blank" class="small d-block text-break">${audioUrl}</a>
    `;
    rawPlayerContainer.appendChild(directLinkContainer);
    
    backupContainer.appendChild(rawPlayerContainer);
    
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –ø–ª–µ–µ—Ä–æ–≤
    const closeButton = document.createElement('button');
    closeButton.className = 'btn btn-outline-secondary btn-sm mt-3';
    closeButton.innerHTML = '<i class="bi bi-x-circle"></i> –°–∫—Ä—ã—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã';
    closeButton.onclick = function() {
        backupContainer.style.display = 'none';
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É "–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?" –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –µ–µ —Å–Ω–æ–≤–∞
        const musicResults = document.getElementById('music-results');
        if (musicResults) {
            const troubleshootBtns = musicResults.querySelectorAll('button');
            troubleshootBtns.forEach(btn => {
                if (btn.innerHTML.includes('–†–µ–∑–µ—Ä–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã') || btn.innerHTML.includes('–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç')) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-question-circle"></i> –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?';
                }
            });
        }
    };
    backupContainer.appendChild(closeButton);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –ø–ª–µ–µ—Ä–∞–º–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    parentContainer.appendChild(backupContainer);
    
    console.log("–†–µ–∑–µ—Ä–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã");
    
    // –ß–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–∏–≥—Ä–∞—Ç—å –∞—É–¥–∏–æ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
    setTimeout(() => {
        try {
            backupPlayer.load();
            console.log("–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ");
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ:", e);
        }
    }, 1000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
function updateGenerationUI() {
    const selectedTypes = Array.from(document.querySelectorAll('input[name="generation_types[]"]:checked')).map(input => input.value);
    const submitButton = document.querySelector('#diary-form button[type="submit"]');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ
    const showText = selectedTypes.includes('text');
    const showImage = selectedTypes.includes('image');
    const showMusic = selectedTypes.includes('music');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    const literaryTypeSection = document.getElementById('literary-type-section');
    if (literaryTypeSection) {
        literaryTypeSection.style.display = showText ? 'block' : 'none';
    }
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const literaryResults = document.getElementById('literary-results');
    const imageResults = document.getElementById('image-results');
    const musicResults = document.getElementById('music-results');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è)
    if (document.getElementById('results').style.display !== 'none') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
        if (literaryResults) {
            const literaryCard = literaryResults.closest('.card');
            if (literaryCard) literaryCard.style.display = showText ? 'block' : 'none';
        }
        
        if (imageResults) {
            const imageCard = imageResults.closest('.card');
            if (imageCard) imageCard.style.display = showImage ? 'block' : 'none';
        }
        
        if (musicResults) {
            const musicCard = musicResults.closest('.card');
            if (musicCard) musicCard.style.display = showMusic ? 'block' : 'none';
        }
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    if (submitButton) {
        if (selectedTypes.length === 0) {
            submitButton.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
            submitButton.disabled = true;
        } else if (selectedTypes.length === 3) {
            submitButton.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –≤—Å—ë';
            submitButton.disabled = false;
        } else {
            const types = [];
            if (showText) types.push('—Ç–µ–∫—Å—Ç');
            if (showImage) types.push('–∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é');
            if (showMusic) types.push('–º—É–∑—ã–∫—É');
            submitButton.textContent = `–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å ${types.join(' –∏ ')}`;
            submitButton.disabled = false;
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function generateImageOnly(text, emotions) {
    // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let imageSection = document.querySelector('.image-section');
    if (!imageSection) {
        imageSection = document.createElement('div');
        imageSection.className = 'image-section mt-4 p-3 border rounded bg-light';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('h3');
        header.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        imageSection.appendChild(header);
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const imageResults = document.createElement('div');
        imageResults.id = 'image-results';
        imageSection.appendChild(imageResults);
        
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loading = document.createElement('div');
        loading.id = 'image-loading';
        loading.className = 'progress my-3';
        loading.innerHTML = `
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 100%"></div>
        `;
        imageResults.appendChild(loading);
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const imageContainer = document.createElement('div');
        imageContainer.id = 'generated-image-container';
        imageContainer.className = 'text-center mb-3';
        imageContainer.style.display = 'none';
        
        const imageElement = document.createElement('img');
        imageElement.id = 'generated-image';
        imageElement.className = 'img-fluid rounded shadow';
        imageElement.alt = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è';
        
        imageContainer.appendChild(imageElement);
        imageResults.appendChild(imageContainer);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const resultsSection = document.getElementById('results');
        if (resultsSection) {
            resultsSection.appendChild(imageSection);
        } else {
            document.body.appendChild(imageSection);
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
    imageSection.style.display = 'block';
    imageSection.classList.add('fadeIn');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingElement = document.getElementById('image-loading');
    if (loadingElement) {
        loadingElement.style.display = 'block';
        loadingElement.innerHTML = `
            <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>`;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    fetch('/generate_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: text,
            emotion_analysis: emotions
        })
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç - JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
        }
        return response.json();
    })
    .then(data => {
        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ /generate_image:', data);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        if (data.success) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (data.external_url) {
                window.lastGeneratedImageExternalUrl = data.external_url;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayGeneratedImage(data.image_url);
        }
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        else {
            if (loadingElement) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
                // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª—è –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                if (data.type === 'content_policy_violation' && data.can_regenerate_safe) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning shadow-lg fade show p-4 mb-3" style="border-left: 6px solid #ffc107; animation: fadeIn 0.5s;">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                <div>
                                    <h5 class="mb-1 fw-bold">–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h5>
                                    <div class="text-muted small">–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ —Ç–µ–∫—Å—Ç–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–µ OpenAI.</div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <strong>${data.generated_image.error}</strong>
                            </div>
                            <div class="mb-3">
                                <ul class="mb-2 ps-4">
                                    <li>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –æ—Ç—Ä—ã–≤–æ–∫ –¥–Ω–µ–≤–Ω–∏–∫–∞ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–π –Ω–∞—Å–∏–ª–∏—è</li>
                                    <li>–ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å <b>—Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é</b> (–∫–∞—á–µ—Å—Ç–≤–æ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)</li>
                                </ul>
                                <div class="alert alert-info py-2 px-3 small mb-2">
                                    <i class="bi bi-info-circle"></i> –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ —Å—Ü–µ–Ω –Ω–∞—Å–∏–ª–∏—è, –Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –∏ —ç–ø–æ—Ö–∏.
                                </div>
                            </div>
                            <button id="generate-safe-image" class="btn btn-lg btn-outline-warning w-100 fw-bold">
                                <i class="bi bi-shield-check"></i> –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é
                            </button>
                        </div>`;
                    loadingElement.classList.remove('progress');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                    document.getElementById('generate-safe-image').addEventListener('click', function() {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                        loadingElement.innerHTML = `
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è OpenAI. 
                                –ö–∞—á–µ—Å—Ç–≤–æ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–¥—É–º–∫–∏.
                            </div>
                            <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 100%"></div>
                            </div>`;
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        fetch('/generate_safe_image', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                diary_text: document.getElementById('diary_text').value
                            })
                        })
                        .then(response => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç - JSON
                            const contentType = response.headers.get('content-type');
                            if (!contentType || !contentType.includes('application/json')) {
                                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
                            }
                            return response.text();
                        })
                        .then(responseText => {
                            // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                            let data;
                            try {
                                data = JSON.parse(responseText);
                                console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", data);
                            } catch (e) {
                                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e, "–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:", responseText);
                                throw new Error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON-–æ—Ç–≤–µ—Ç–∞");
                            }
                            
                            if (data.success && data.image_url) {
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                                if (data.external_url) {
                                    window.lastGeneratedImageExternalUrl = data.external_url;
                                }
                                
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                displayGeneratedImage(data.image_url);
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–µ
                                const noticeElement = document.createElement('div');
                                noticeElement.className = 'alert alert-info mt-3';
                                noticeElement.innerHTML = `
                                    <i class="fas fa-info-circle"></i>
                                    –ë—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞.
                                `;
                                document.getElementById('image-results').appendChild(noticeElement);
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                                loadingElement.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–∂–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                    </div>`;
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                            loadingElement.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                </div>`;
                        });
                    });
                } else {
                    // –û–±—ã—á–Ω–∞—è –æ—à–∏–±–∫–∞
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        </div>`;
                    loadingElement.classList.remove('progress');
                }
            }
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
        if (loadingElement) {
            loadingElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                </div>`;
        }
    });
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    const resultsSection = document.getElementById('results');
    if (resultsSection) {
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// –î–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const testButton = document.createElement('button');
    testButton.id = 'test-policy-violation';
    testButton.className = 'btn btn-sm btn-outline-danger mt-2';
    testButton.textContent = '–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞';
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏
    const formControls = document.querySelector('.form-controls');
    if (formControls) {
        formControls.appendChild(testButton);
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–µ—Å—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã
        const analysisForm = document.getElementById('analysis-form');
        if (analysisForm) {
            analysisForm.insertAdjacentElement('afterend', testButton);
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è
    testButton.addEventListener('click', function() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –Ω–∞—Å–∏–ª–∏—è
        const testText = `
12 –∞–≤–≥—É—Å—Ç–∞ 1943 –≥–æ–¥–∞. –ü–æ–¥ –ö—É—Ä—Å–∫–æ–º.

–°–µ–≥–æ–¥–Ω—è –±—ã–ª —Å—Ç—Ä–∞—à–Ω—ã–π –±–æ–π. –ù–∞—à –±–∞—Ç–∞–ª—å–æ–Ω –ø–æ–ø–∞–ª –ø–æ–¥ –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–≥–æ–Ω—å –Ω–µ–º–µ—Ü–∫–∏—Ö –ø—É–ª–µ–º–µ—Ç–æ–≤. –Ø –≤–∏–¥–µ–ª, –∫–∞–∫ –ø—É–ª–∏ –ø—Ä–æ—à–∏–≤–∞–ª–∏ —Ç–µ–ª–∞ –º–æ–∏—Ö —Ç–æ–≤–∞—Ä–∏—â–µ–π. –ö—Ä–æ–≤—å –±—ã–ª–∞ –≤–µ–∑–¥–µ.

–í—á–µ—Ä–∞ –Ω–∞–º —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –Ω–µ–º–µ—Ü–∫–∏–π —Ç–∞–Ω–∫. –ú—ã —Ä–∞—Å—Å—Ç—Ä–µ–ª—è–ª–∏ —ç–∫–∏–ø–∞–∂, –∫–æ–≥–¥–∞ –æ–Ω–∏ –ø—ã—Ç–∞–ª–∏—Å—å –≤—ã–±—Ä–∞—Ç—å—Å—è. –ò—Ö –∫–æ–º–∞–Ω–¥–∏—Ä —É–º–æ–ª—è–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–º—É –∂–∏–∑–Ω—å, –Ω–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω–∏ —Å–¥–µ–ª–∞–ª–∏ —Å –Ω–∞—à–µ–π –¥–µ—Ä–µ–≤–Ω–µ–π, –ø–æ—â–∞–¥—ã –Ω–µ –±—ã–ª–æ.

–ù–æ—á—å—é –ø–æ–º–æ–≥–∞–ª —Å–∞–Ω–∏—Ç–∞—Ä–∞–º —Å–æ–±–∏—Ä–∞—Ç—å —Ä–∞–Ω–µ–Ω—ã—Ö. –ú–Ω–æ–≥–∏–µ –±—ã–ª–∏ –∏–∑—É—Ä–æ–¥–æ–≤–∞–Ω—ã –¥–æ –Ω–µ—É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏. –£ –ü–µ—Ç—Ä–æ–≤–∏—á–∞ –æ—Ç–æ—Ä–≤–∞–ª–æ –æ–±–µ –Ω–æ–≥–∏, –Ω–æ –æ–Ω –µ—â–µ –±—ã–ª –∂–∏–≤, –∫–æ–≥–¥–∞ –º—ã –µ–≥–æ –Ω–∞—à–ª–∏. –£–º–µ—Ä –ø–æ –¥–æ—Ä–æ–≥–µ –≤ –º–µ–¥—Å–∞–Ω–±–∞—Ç.

–ú—ã –Ω–∞—à–ª–∏ —Ç–µ–ª–∞ –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π —Å–æ —Å–ª–µ–¥–∞–º–∏ –ø—ã—Ç–æ–∫. –ñ–µ–Ω—â–∏–Ω—ã –∏ –¥–µ—Ç–∏... –ù–µ –º–æ–≥—É –æ–ø–∏—Å–∞—Ç—å, —á—Ç–æ —Å –Ω–∏–º–∏ —Å–¥–µ–ª–∞–ª–∏. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –ø–æ–∫–ª—è–ª–∏—Å—å –Ω–µ –±—Ä–∞—Ç—å –ø–ª–µ–Ω–Ω—ã—Ö.

–ó–∞–≤—Ç—Ä–∞ —Å–Ω–æ–≤–∞ –≤ –±–æ–π. –ó–∞–ø–∞—Å –ø–∞—Ç—Ä–æ–Ω–æ–≤ –ø–æ–ø–æ–ª–Ω–∏–ª–∏, –≥—Ä–∞–Ω–∞—Ç—ã –ø–æ–ª—É—á–∏–ª–∏. –ö–æ–º–∞–Ω–¥–∏—Ä —Å–∫–∞–∑–∞–ª, –±—É–¥–µ–º –ø—Ä–æ—Ä—ã–≤–∞—Ç—å—Å—è –∫ –∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω–æ–π —Å—Ç–∞–Ω—Ü–∏–∏. –ù–µ–º—Ü—ã —Ö–æ—Ä–æ—à–æ —É–∫—Ä–µ–ø–∏–ª–∏—Å—å, –Ω–æ –º—ã –¥–æ–ª–∂–Ω—ã –≤—ã–±–∏—Ç—å –∏—Ö –æ—Ç—Ç—É–¥–∞ –ª—é–±–æ–π —Ü–µ–Ω–æ–π.`;
        
        // –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
        const emotions = {
            "primary_emotions": [
                {"emotion": "—É–∂–∞—Å", "intensity": 9},
                {"emotion": "–≥–Ω–µ–≤", "intensity": 8},
                {"emotion": "–æ—Ç—á–∞—è–Ω–∏–µ", "intensity": 7}
            ],
            "emotional_tone": "–º—Ä–∞—á–Ω—ã–π"
        };
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        generateImageOnly(testText, emotions);
    });
});

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function testContentPolicyViolation() {
    console.log("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...");
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —è–≤–Ω—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –Ω–∞—Å–∏–ª–∏—è –∏ –∫—Ä–æ–≤–∏
    const testText = `
12 –∞–≤–≥—É—Å—Ç–∞ 1943 –≥–æ–¥–∞. –ü–æ–¥ –ö—É—Ä—Å–∫–æ–º.

–°–µ–≥–æ–¥–Ω—è –±—ã–ª —Å—Ç—Ä–∞—à–Ω—ã–π –±–æ–π. –ù–∞—à –±–∞—Ç–∞–ª—å–æ–Ω –ø–æ–ø–∞–ª –ø–æ–¥ –º–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–≥–æ–Ω—å –Ω–µ–º–µ—Ü–∫–∏—Ö –ø—É–ª–µ–º–µ—Ç–æ–≤. –Ø –≤–∏–¥–µ–ª, –∫–∞–∫ –ø—É–ª–∏ –ø—Ä–æ—à–∏–≤–∞–ª–∏ —Ç–µ–ª–∞ –º–æ–∏—Ö —Ç–æ–≤–∞—Ä–∏—â–µ–π. –ö—Ä–æ–≤—å –±—ã–ª–∞ –≤–µ–∑–¥–µ.

–í—á–µ—Ä–∞ –Ω–∞–º —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –Ω–µ–º–µ—Ü–∫–∏–π —Ç–∞–Ω–∫. –ú—ã —Ä–∞—Å—Å—Ç—Ä–µ–ª—è–ª–∏ —ç–∫–∏–ø–∞–∂, –∫–æ–≥–¥–∞ –æ–Ω–∏ –ø—ã—Ç–∞–ª–∏—Å—å –≤—ã–±—Ä–∞—Ç—å—Å—è. –ò—Ö –∫–æ–º–∞–Ω–¥–∏—Ä —É–º–æ–ª—è–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ–º—É –∂–∏–∑–Ω—å, –Ω–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω–∏ —Å–¥–µ–ª–∞–ª–∏ —Å –Ω–∞—à–µ–π –¥–µ—Ä–µ–≤–Ω–µ–π, –ø–æ—â–∞–¥—ã –Ω–µ –±—ã–ª–æ.

–ù–æ—á—å—é –ø–æ–º–æ–≥–∞–ª —Å–∞–Ω–∏—Ç–∞—Ä–∞–º —Å–æ–±–∏—Ä–∞—Ç—å —Ä–∞–Ω–µ–Ω—ã—Ö. –ú–Ω–æ–≥–∏–µ –±—ã–ª–∏ –∏–∑—É—Ä–æ–¥–æ–≤–∞–Ω—ã –¥–æ –Ω–µ—É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏. –£ –ü–µ—Ç—Ä–æ–≤–∏—á–∞ –æ—Ç–æ—Ä–≤–∞–ª–æ –æ–±–µ –Ω–æ–≥–∏, –Ω–æ –æ–Ω –µ—â–µ –±—ã–ª –∂–∏–≤, –∫–æ–≥–¥–∞ –º—ã –µ–≥–æ –Ω–∞—à–ª–∏. –£–º–µ—Ä –ø–æ –¥–æ—Ä–æ–≥–µ –≤ –º–µ–¥—Å–∞–Ω–±–∞—Ç.

–ú—ã –Ω–∞—à–ª–∏ —Ç–µ–ª–∞ –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π —Å–æ —Å–ª–µ–¥–∞–º–∏ –ø—ã—Ç–æ–∫. –ñ–µ–Ω—â–∏–Ω—ã –∏ –¥–µ—Ç–∏... –ù–µ –º–æ–≥—É –æ–ø–∏—Å–∞—Ç—å, —á—Ç–æ —Å –Ω–∏–º–∏ —Å–¥–µ–ª–∞–ª–∏. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –ø–æ–∫–ª—è–ª–∏—Å—å –Ω–µ –±—Ä–∞—Ç—å –ø–ª–µ–Ω–Ω—ã—Ö.`;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Ç–µ—Å—Ç–∞ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –±–ª–æ–∫–µ
    const testInfoBlock = document.createElement('div');
    testInfoBlock.className = 'alert alert-info';
    testInfoBlock.innerHTML = `
        <strong>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ OpenAI:</strong>
        <p>–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–∫—Å—Ç–æ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º —è–≤–Ω–æ–µ –Ω–∞—Å–∏–ª–∏–µ.</p>
        <p>–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.</p>
    `;
    
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let imageSection = document.querySelector('.image-section');
    if (!imageSection) {
        imageSection = document.createElement('div');
        imageSection.className = 'image-section mt-4 p-3 border rounded bg-light';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const header = document.createElement('h3');
        header.textContent = '–¢–µ—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è';
        imageSection.appendChild(header);
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const imageResults = document.createElement('div');
        imageResults.id = 'image-results';
        imageSection.appendChild(imageResults);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        const generatedContent = document.getElementById('generated-content');
        if (generatedContent) {
            generatedContent.appendChild(imageSection);
        } else {
            document.body.appendChild(imageSection);
        }
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    let loadingElement = document.getElementById('image-loading');
    if (!loadingElement) {
        loadingElement = document.createElement('div');
        loadingElement.id = 'image-loading';
        loadingElement.className = 'loading-indicator mb-3';
        
        const imageResults = document.getElementById('image-results');
        if (imageResults) {
            imageResults.appendChild(loadingElement);
        } else {
            imageSection.appendChild(loadingElement);
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('image-results').innerHTML = '';
    document.getElementById('image-results').appendChild(testInfoBlock);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    loadingElement.className = 'loading-indicator mb-3 progress';
    loadingElement.innerHTML = `
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" style="width: 100%"></div>
    `;
    
    document.getElementById('image-results').appendChild(loadingElement);
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    imageSection.scrollIntoView({ behavior: 'smooth' });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    fetch('/generate_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            text: testText,
            emotion_analysis: {
                "primary_emotions": [
                    {"emotion": "—É–∂–∞—Å", "intensity": 9},
                    {"emotion": "–≥–Ω–µ–≤", "intensity": 8},
                    {"emotion": "—Å–∫–æ—Ä–±—å", "intensity": 7}
                ],
                "emotional_tone": "—Ç—è–∂–µ–ª—ã–π –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω—ã–π",
                "hidden_motives": ["–∂–∞–∂–¥–∞ –º–µ—Å—Ç–∏", "—Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –≤—ã–∂–∏—Ç—å"],
                "attitude": "–Ω–µ–Ω–∞–≤–∏—Å—Ç—å –∫ –≤—Ä–∞–≥—É"
            }
        })
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç - JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –æ—Ç–≤–µ—Ç');
        }
        return response.json();
    })
    .then(data => {
        console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ /generate_image (—Ç–µ—Å—Ç):', data);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
        if (data.success) {
            // –≠—Ç–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ - —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã–ª –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            loadingElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> –ó–∞–ø—Ä–æ—Å –Ω–µ –≤—ã–∑–≤–∞–ª –æ—à–∏–±–∫—É –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è, —Ö–æ—Ç—è –¥–æ–ª–∂–µ–Ω –±—ã–ª.
                </div>`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ
            displayGeneratedImage(data.image_url);
        }
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            if (data.type === 'content_policy_violation' && data.can_regenerate_safe) {
                // –≠—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Ç–µ—Å—Ç–µ
                loadingElement.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        <strong>–¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω!</strong> –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è.
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>${data.error}</strong>
                        <p class="mt-2">–í—ã –º–æ–∂–µ—Ç–µ:</p>
                        <ul>
                            <li>–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –æ—Ç—Ä—ã–≤–æ–∫ –¥–Ω–µ–≤–Ω–∏–∫–∞ –±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–π –Ω–∞—Å–∏–ª–∏—è</li>
                            <li>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é (–∫–∞—á–µ—Å—Ç–≤–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∂–µ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º)</li>
                        </ul>
                        <button id="generate-safe-image-test" class="btn btn-sm btn-outline-primary mt-2">
                            –°–æ–∑–¥–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é
                        </button>
                    </div>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                document.getElementById('generate-safe-image-test').addEventListener('click', function() {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    loadingElement.innerHTML = `
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è OpenAI. 
                            –ö–∞—á–µ—Å—Ç–≤–æ –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –∑–∞–¥—É–º–∫–∏.
                        </div>
                        <p class="text-muted">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>`;
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    fetch('/generate_safe_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            diary_text: testText
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–µ—Å—Ç):", data);
                        
                        if (data.success && data.image_url) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            displayGeneratedImage(data.image_url);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–µ
                            const noticeElement = document.createElement('div');
                            noticeElement.className = 'alert alert-info mt-3';
                            noticeElement.innerHTML = `
                                <i class="fas fa-info-circle"></i>
                                –ë—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞.
                            `;
                            document.getElementById('image-results').appendChild(noticeElement);
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                            loadingElement.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                </div>`;
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Ç–µ—Å—Ç):', error);
                        loadingElement.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                            </div>`;
                    });
                });
            } else {
                // –û–±—ã—á–Ω–∞—è –æ—à–∏–±–∫–∞
                loadingElement.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                    </div>`;
            }
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è:', error);
        loadingElement.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
            </div>`;
    });
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const testButton = document.createElement('button');
    testButton.id = 'test-policy-violation';
    testButton.className = 'btn btn-sm btn-outline-danger mt-2';
    testButton.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–µ—Å—Ç–æ–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞';
    testButton.style.marginLeft = '10px';
    
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏
    const formControls = document.querySelector('.form-controls');
    if (formControls) {
        formControls.appendChild(testButton);
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–µ—Å—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã
        const analysisForm = document.getElementById('analysis-form');
        if (analysisForm) {
            analysisForm.insertAdjacentElement('afterend', testButton);
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –Ω–∞—à–µ–π —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    testButton.addEventListener('click', function(e) {
        e.preventDefault();
        testContentPolicyViolation();
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
    setTimeout(function() {
        // –ù–∞—Ö–æ–¥–∏–º –º—É–∑—ã–∫–∞–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –∏ –¥–µ–ª–∞–µ–º –µ–µ –≤–∏–¥–∏–º–æ–π
        const musicSection = document.querySelector('.music-section');
        if (musicSection) {
            musicSection.style.display = 'block';
            musicSection.style.opacity = '1';
            musicSection.style.visibility = 'visible';
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º—É–∑—ã–∫–∏ –∏ –¥–µ–ª–∞–µ–º –µ–≥–æ –≤–∏–¥–∏–º—ã–º
        const musicContainer = document.getElementById('generated-music-container');
        if (musicContainer) {
            musicContainer.style.display = 'block';
            musicContainer.style.opacity = '1';
            musicContainer.style.visibility = 'visible';
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –¥–µ–ª–∞–µ–º –∏—Ö –≤–∏–¥–∏–º—ã–º–∏
        const audioElements = document.querySelectorAll('audio');
        if (audioElements.length > 0) {
            audioElements.forEach((audio, index) => {
                audio.style.display = 'block';
                audio.style.opacity = '1';
                audio.style.visibility = 'visible';
                audio.style.width = '100%';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                audio.onerror = function(e) {
                    console.error(`–û—à–∏–±–∫–∞ –≤ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–µ ${index + 1}:`, e);
                };
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                try {
                    audio.load();
                } catch (e) {
                    console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ ${index + 1}:`, e);
                }
            });
        }
    }, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
});

// –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤
    setTimeout(ensureAudioPlayersVisible, 3000);
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤
function ensureAudioPlayersVisible() {
    console.log("–ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤");
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –º—É–∑—ã–∫–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const musicSection = document.querySelector('.music-section');
    if (musicSection) {
        console.log("–î–µ–ª–∞–µ–º —Å–µ–∫—Ü–∏—é –º—É–∑—ã–∫–∏ –≤–∏–¥–∏–º–æ–π");
        musicSection.style.display = 'block';
        musicSection.style.visibility = 'visible';
        musicSection.style.opacity = '1';
    }
    
    // –î–µ–ª–∞–µ–º –≤–∏–¥–∏–º—ã–º–∏ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    const containers = [
        '#generated-music-container',
        '#music-results',
        '.audio-player-container',
        '.audio-player-wrapper'
    ];
    
    containers.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        if (elements.length) {
            console.log(`–ù–∞–π–¥–µ–Ω–æ ${elements.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ${selector}`);
            elements.forEach(el => {
                el.style.display = 'block';
                el.style.visibility = 'visible';
                el.style.opacity = '1';
                console.log(`–≠–ª–µ–º–µ–Ω—Ç —Å —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–º ${selector} —Å–¥–µ–ª–∞–Ω –≤–∏–¥–∏–º—ã–º`);
            });
        } else {
            console.log(`–ù–µ –Ω–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ${selector}`);
        }
    });
    
    // –î–µ–ª–∞–µ–º –≤–∏–¥–∏–º—ã–º–∏ –≤—Å–µ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä—ã
    const audioPlayers = document.querySelectorAll('audio');
    if (audioPlayers.length) {
        console.log(`–ù–∞–π–¥–µ–Ω–æ ${audioPlayers.length} –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤`);
        
        audioPlayers.forEach(player => {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –∫ —ç–ª–µ–º–µ–Ω—Ç—É
            player.style.display = 'block';
            player.style.visibility = 'visible';
            player.style.opacity = '1';
            player.style.width = '100%';
            player.style.minHeight = '50px';
            player.style.border = '2px solid #4a76a8';
            player.style.backgroundColor = '#f5f5f5';
            player.style.margin = '15px 0';
            player.style.zIndex = '9999';
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
            try {
                player.load();
                console.log("–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä");
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞:", e);
            }
        });
    } else {
        console.log("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ URL –∞—É–¥–∏–æ –≤ —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
        checkForHiddenAudioUrls();
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ URL –∞—É–¥–∏–æ –≤ —Å–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –∏ —Å–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä
function checkForHiddenAudioUrls() {
    console.log("–ü–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö URL –∞—É–¥–∏–æ");
    
    // –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ URL-–∞–¥—Ä–µ—Å–∞
    const allElements = document.querySelectorAll('*');
    let foundUrls = [];
    
    allElements.forEach(el => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
        Array.from(el.attributes).forEach(attr => {
            const value = attr.value || '';
            
            // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
            if ((value.includes('.mp3') || value.includes('/proxy_audio') || 
                 value.includes('/audio/') || value.includes('music_file')) && 
                !foundUrls.includes(value)) {
                console.log("–ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π URL –∞—É–¥–∏–æ –≤ –∞—Ç—Ä–∏–±—É—Ç–µ:", value);
                foundUrls.push(value);
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const textContent = el.textContent || '';
        if ((textContent.includes('.mp3') || textContent.includes('/proxy_audio')) && 
            textContent.length < 300) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ URL –∏–∑ —Ç–µ–∫—Å—Ç–∞
            const urlRegex = /(https?:\/\/[^\s"'<>]+\.mp3|\/proxy_audio\?[^\s"'<>]+)/g;
            const matches = textContent.match(urlRegex);
            
            if (matches) {
                matches.forEach(url => {
                    if (!foundUrls.includes(url)) {
                        console.log("–ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π URL –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç–µ:", url);
                        foundUrls.push(url);
                    }
                });
            }
        }
    });
    
    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã URL, —Å–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–ª–µ–µ—Ä–æ–≤
    if (foundUrls.length > 0) {
        console.log(`–ù–∞–π–¥–µ–Ω–æ ${foundUrls.length} —Å–∫—Ä—ã—Ç—ã—Ö URL –∞—É–¥–∏–æ`);
        
        const targetContainer = document.getElementById('music-results') || document.querySelector('.music-section') || document.body;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–ª–µ–µ—Ä—ã
        if (document.querySelector('.emergency-audio-players')) {
            console.log("–°–∫—Ä—ã—Ç—ã–µ –ø–ª–µ–µ—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è");
            
            // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã, –Ω–æ –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É
            if (!document.querySelector('.show-hidden-players-btn')) {
                const showHiddenBtn = document.createElement('button');
                showHiddenBtn.className = 'btn btn-outline-secondary btn-sm mt-3 show-hidden-players-btn';
                showHiddenBtn.innerHTML = '<i class="bi bi-music-note-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã (–Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ)';
                showHiddenBtn.onclick = function() {
                    const emergencyPlayers = document.querySelector('.emergency-audio-players');
                    if (emergencyPlayers) {
                        emergencyPlayers.style.display = 'block';
                        this.style.display = 'none';
                    }
                };
                targetContainer.appendChild(showHiddenBtn);
            }
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –ø–ª–µ–µ—Ä–æ–≤
        const showHiddenBtn = document.createElement('button');
        showHiddenBtn.className = 'btn btn-outline-secondary btn-sm mt-3 show-hidden-players-btn';
        showHiddenBtn.innerHTML = '<i class="bi bi-music-note-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã (–Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ)';
        targetContainer.appendChild(showHiddenBtn);
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–ª–µ–µ—Ä–æ–≤
        const container = document.createElement('div');
        container.className = 'emergency-audio-players';
        container.style.cssText = 'background:#f0f5fa !important; border:2px solid #4a76a8 !important; padding:20px !important; margin:20px 0 !important; border-radius:8px !important; display:none !important;';
        
        const title = document.createElement('h4');
        title.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–∫—Ä—ã—Ç—ã–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã';
        title.style.cssText = 'color:#2c5282 !important; margin-bottom:20px !important; text-align:center !important; font-weight:bold !important;';
        container.appendChild(title);
        
        const description = document.createElement('p');
        description.textContent = '–ù–∞–π–¥–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º –ø–ª–µ–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ–¥–Ω–∏–º –∏–∑ —ç—Ç–∏—Ö –ø–ª–µ–µ—Ä–æ–≤:';
        description.style.cssText = 'margin-bottom:20px !important; font-style:italic !important;';
        container.appendChild(description);
        
        // –°–æ–∑–¥–∞–µ–º –ø–ª–µ–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ URL
        foundUrls.forEach((url, index) => {
            const playerWrapper = document.createElement('div');
            playerWrapper.className = 'emergency-player-item';
            playerWrapper.style.cssText = 'background:#ffffff !important; border:1px solid #dddddd !important; padding:15px !important; margin-bottom:15px !important; border-radius:5px !important;';
            
            const playerTitle = document.createElement('h5');
            playerTitle.textContent = `–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–µ–µ—Ä #${index + 1}`;
            playerTitle.style.cssText = 'color:#2c5282 !important; margin-bottom:10px !important;';
            playerWrapper.appendChild(playerTitle);
            
            const urlDisplay = document.createElement('p');
            urlDisplay.textContent = `–ò—Å—Ç–æ—á–Ω–∏–∫ –∞—É–¥–∏–æ: ${url}`;
            urlDisplay.style.cssText = 'font-size:12px !important; color:#666 !important; margin-bottom:10px !important; word-break:break-all !important;';
            playerWrapper.appendChild(urlDisplay);
            
            // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä
            const player = document.createElement('audio');
            player.controls = true;
            player.preload = 'auto';
            player.style.cssText = 'display:block !important; width:100% !important; min-height:50px !important; border:2px solid #4a76a8 !important;';
            
            const source = document.createElement('source');
            source.src = url;
            source.type = 'audio/mpeg';
            player.appendChild(source);
            
            playerWrapper.appendChild(player);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const buttons = document.createElement('div');
            buttons.style.cssText = 'display:flex !important; justify-content:center !important; gap:10px !important; margin-top:10px !important;';
            
            const downloadBtn = document.createElement('a');
            downloadBtn.href = url;
            downloadBtn.download = `audio_file_${index + 1}.mp3`;
            downloadBtn.className = 'btn btn-primary btn-sm';
            downloadBtn.innerHTML = '<i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å';
            buttons.appendChild(downloadBtn);
            
            const openBtn = document.createElement('a');
            openBtn.href = url;
            openBtn.target = '_blank';
            openBtn.className = 'btn btn-outline-primary btn-sm';
            openBtn.innerHTML = '<i class="bi bi-box-arrow-up-right"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ';
            buttons.appendChild(openBtn);
            
            playerWrapper.appendChild(buttons);
            container.appendChild(playerWrapper);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-outline-secondary btn-sm mt-3';
        closeBtn.innerHTML = '<i class="bi bi-x-circle"></i> –°–∫—Ä—ã—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–µ–µ—Ä—ã';
        closeBtn.onclick = function() {
            container.style.display = 'none';
            showHiddenBtn.style.display = 'block';
        };
        container.appendChild(closeBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        targetContainer.appendChild(container);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–ª–µ–µ—Ä–æ–≤
        showHiddenBtn.onclick = function() {
            container.style.display = 'block';
            this.style.display = 'none';
        };
        
        console.log("–°–æ–∑–¥–∞–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –ø–ª–µ–µ—Ä–∞–º–∏ –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö URL");
    } else {
        console.log("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–∫—Ä—ã—Ç—ã—Ö URL –∞—É–¥–∏–æ");
    }
}

// –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
document.addEventListener('DOMContentLoaded', function() {
    let currentContentType = '';
    let currentSessionId = '';
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ü–µ–Ω–∫–∏
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('feedback-modal-btn') || e.target.closest('.feedback-modal-btn')) {
            const button = e.target.classList.contains('feedback-modal-btn') ? e.target : e.target.closest('.feedback-modal-btn');
            currentContentType = button.getAttribute('data-content-type');
            currentSessionId = Date.now().toString();
            
            setupFeedbackModal(currentContentType);
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è —Å —ç—Ç–∏—á–µ—Å–∫–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏
    const ethicsAgreement = document.getElementById('ethicsAgreement');
    const ethicsCard = document.getElementById('ethics-agreement-card');
    const submitButton = document.querySelector('#diary-form button[type="submit"]');
    
    if (ethicsAgreement && submitButton) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Ä–∞–Ω–µ–µ –¥–∞–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage)
        const previousAgreement = localStorage.getItem('ethicsAgreementAccepted');
        
        if (previousAgreement === 'true') {
            // –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ —É–∂–µ –±—ã–ª–æ –¥–∞–Ω–æ, —Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            if (ethicsCard) {
                ethicsCard.style.display = 'none';
            }
            ethicsAgreement.checked = true;
            updateSubmitButton();
        } else {
            // –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–µ –±—ã–ª–æ –¥–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
            updateSubmitButton();
        }
        
        function updateSubmitButton() {
            if (ethicsAgreement.checked) {
                submitButton.disabled = false;
                submitButton.classList.remove('btn-secondary');
                submitButton.classList.add('btn-primary');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('btn-secondary');
                submitButton.classList.remove('btn-primary');
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
        ethicsAgreement.addEventListener('change', function() {
            updateSubmitButton();
            
            if (this.checked) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –≤ localStorage
                localStorage.setItem('ethicsAgreementAccepted', 'true');
                
                // –ê–Ω–∏–º–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—à–∫–∏
                if (ethicsCard) {
                    ethicsCard.classList.add('fade-out');
                    
                    // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É —á–µ—Ä–µ–∑ 300ms
                    setTimeout(() => {
                        ethicsCard.style.display = 'none';
                        ethicsCard.classList.remove('fade-out');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–Ω—è—Ç–∏–∏
                        showNotification('–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —ç—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–æ—Ä–º! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–Ω–µ–≤–Ω–∏–∫–∏.', 'success');
                    }, 300);
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω—è–ª –≥–∞–ª–æ—á–∫—É, —É–¥–∞–ª—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                localStorage.removeItem('ethicsAgreementAccepted');
                if (ethicsCard && ethicsCard.style.display === 'none') {
                    ethicsCard.style.display = 'block';
                    ethicsCard.classList.add('fadeIn');
                }
            }
        });
    }
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
function setupFeedbackModal(contentType) {
    const nameElement = document.getElementById('contentTypeName');
    const descriptionElement = document.getElementById('contentTypeDescription');
    const criteriaContainer = document.getElementById('criteriaContainer');
    const contentTypeInput = document.getElementById('contentType');
    const sessionIdInput = document.getElementById('sessionId');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ ID —Å–µ—Å—Å–∏–∏
    contentTypeInput.value = contentType;
    sessionIdInput.value = Date.now().toString();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–≤—ë–∑–¥—ã
    resetStars();
    
    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
    document.getElementById('feedbackText').value = '';
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    switch(contentType) {
        case 'emotion_analysis':
            nameElement.textContent = '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑';
            descriptionElement.textContent = '–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞ —ç–º–æ—Ü–∏–π –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞';
            setupEmotionCriteria(criteriaContainer);
            break;
        case 'literary_work':
            nameElement.textContent = '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ';
            descriptionElement.textContent = '–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞';
            setupLiteraryCriteria(criteriaContainer);
            break;
        case 'generated_image':
            nameElement.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            descriptionElement.textContent = '–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç—É –¥–Ω–µ–≤–Ω–∏–∫–∞';
            setupImageCriteria(criteriaContainer);
            break;
        case 'generated_music':
            nameElement.textContent = '–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ';
            descriptionElement.textContent = '–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º—É–∑—ã–∫–∏';
            setupMusicCriteria(criteriaContainer);
            break;
    }
}

// –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
function setupEmotionCriteria(container) {
    const criteria = [
        {
            name: '–¢–æ—á–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞',
            description: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —ç–º–æ—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
            id: 'emotion_accuracy'
        },
        {
            name: '–ü–æ–ª–Ω–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞',
            description: '–û—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ –∞–Ω–∞–ª–∏–∑ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–∫—Å—Ç–∞',
            id: 'emotion_completeness'
        },
        {
            name: '–ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
            description: '–ù–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∞–Ω–∞–ª–∏–∑',
            id: 'emotion_clarity'
        }
    ];
    
    renderCriteria(container, criteria);
}

// –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function setupLiteraryCriteria(container) {
    const criteria = [
        {
            name: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥—É—Ö—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞',
            description: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –≤–æ–µ–Ω–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞',
            id: 'literary_authenticity'
        },
        {
            name: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å',
            description: '–ö–∞—á–µ—Å—Ç–≤–æ —è–∑—ã–∫–∞, —Å—Ç–∏–ª—è –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤',
            id: 'literary_quality'
        },
        {
            name: '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ',
            description: '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –≤—ã–∑—ã–≤–∞—Ç—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫',
            id: 'literary_impact'
        },
        {
            name: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å',
            description: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —ç–ø–æ—Ö–µ –∏ —Ä–µ–∞–ª–∏—è–º –≤–æ–π–Ω—ã',
            id: 'literary_historical'
        }
    ];
    
    renderCriteria(container, criteria);
}

// –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function setupImageCriteria(container) {
    const criteria = [
        {
            name: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—Å—Ç—É',
            description: '–ù–∞—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞',
            id: 'image_relevance'
        },
        {
            name: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ',
            description: '–ö–æ–º–ø–æ–∑–∏—Ü–∏—è, —Ü–≤–µ—Ç–∞, –æ–±—â–∞—è —ç—Å—Ç–µ—Ç–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
            id: 'image_quality'
        },
        {
            name: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å',
            description: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —ç–ø–æ—Ö–µ',
            id: 'image_historical'
        },
        {
            name: '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞',
            description: '–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞',
            id: 'image_emotion'
        }
    ];
    
    renderCriteria(container, criteria);
}

// –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –º—É–∑—ã–∫–∏
function setupMusicCriteria(container) {
    const criteria = [
        {
            name: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é',
            description: '–ù–∞—Å–∫–æ–ª—å–∫–æ –º—É–∑—ã–∫–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç —ç–º–æ—Ü–∏–∏ –∏–∑ –¥–Ω–µ–≤–Ω–∏–∫–∞',
            id: 'music_mood'
        },
        {
            name: '–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏',
            description: '–ú–µ–ª–æ–¥–∏—è, –≥–∞—Ä–º–æ–Ω–∏—è, –∞—Ä–∞–Ω–∂–∏—Ä–æ–≤–∫–∞',
            id: 'music_quality'
        },
        {
            name: '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞',
            description: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—é —ç–ø–æ—Ö–∏',
            id: 'music_period'
        },
        {
            name: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ',
            description: '–ß–∏—Å—Ç–æ—Ç–∞ –∑–≤—É–∫–∞, –±–∞–ª–∞–Ω—Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤',
            id: 'music_technical'
        }
    ];
    
    renderCriteria(container, criteria);
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
function renderCriteria(container, criteria) {
    container.innerHTML = '';
    
    criteria.forEach(criterion => {
        const criteriaDiv = document.createElement('div');
        criteriaDiv.className = 'criteria-item';
        criteriaDiv.innerHTML = `
            <div class="criteria-name">${criterion.name}</div>
            <div class="criteria-description">${criterion.description}</div>
            <div class="mini-stars" data-criteria="${criterion.id}">
                <i class="bi bi-star star" data-rating="1"></i>
                <i class="bi bi-star star" data-rating="2"></i>
                <i class="bi bi-star star" data-rating="3"></i>
                <i class="bi bi-star star" data-rating="4"></i>
                <i class="bi bi-star star" data-rating="5"></i>
                <span class="rating-text text-muted ms-2">–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ</span>
            </div>
            <input type="hidden" name="criteria_${criterion.id}" value="0">
        `;
        container.appendChild(criteriaDiv);
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∑–≤—ë–∑–¥–∞–º
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('star')) {
        const rating = parseInt(e.target.getAttribute('data-rating'));
        const starsContainer = e.target.closest('.stars') || e.target.closest('.mini-stars');
        const isMainRating = starsContainer && starsContainer.classList.contains('stars');
        
        if (isMainRating) {
            setMainRating(rating);
        } else if (starsContainer) {
            const criteriaId = starsContainer.getAttribute('data-criteria');
            setCriteriaRating(starsContainer, criteriaId, rating);
        }
    }
});

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
function setMainRating(rating) {
    const stars = document.querySelectorAll('.stars .star');
    const ratingText = document.querySelector('.rating-text');
    const hiddenInput = document.getElementById('starRating');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('filled');
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
        } else {
            star.classList.remove('filled');
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
        }
    });
    
    const ratingTexts = ['', '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ', '–ü–ª–æ—Ö–æ', '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ', '–•–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ'];
    if (ratingText) ratingText.textContent = ratingTexts[rating];
    if (hiddenInput) hiddenInput.value = rating;
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è
function setCriteriaRating(container, criteriaId, rating) {
    const stars = container.querySelectorAll('.star');
    const ratingText = container.querySelector('.rating-text');
    const hiddenInput = container.parentElement.querySelector(`input[name="criteria_${criteriaId}"]`);
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('filled');
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
        } else {
            star.classList.remove('filled');
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
        }
    });
    
    const ratingTexts = ['', '–û—á–µ–Ω—å –ø–ª–æ—Ö–æ', '–ü–ª–æ—Ö–æ', '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ', '–•–æ—Ä–æ—à–æ', '–û—Ç–ª–∏—á–Ω–æ'];
    if (ratingText) ratingText.textContent = ratingTexts[rating];
    if (hiddenInput) hiddenInput.value = rating;
}

// –°–±—Ä–æ—Å –≤—Å–µ—Ö –∑–≤—ë–∑–¥
function resetStars() {
    const allStars = document.querySelectorAll('#feedbackModal .star');
    const allRatingTexts = document.querySelectorAll('#feedbackModal .rating-text');
    const allHiddenInputs = document.querySelectorAll('#feedbackModal input[type="hidden"]');
    
    allStars.forEach(star => {
        star.classList.remove('filled');
        star.classList.remove('bi-star-fill');
        star.classList.add('bi-star');
    });
    
    allRatingTexts.forEach(text => {
        text.textContent = text.closest('.stars') ? '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É' : '–ù–µ –æ—Ü–µ–Ω–µ–Ω–æ';
    });
    
    allHiddenInputs.forEach(input => {
        if (input.name && (input.name.startsWith('criteria_') || input.id === 'starRating')) {
            input.value = '0';
        }
    });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const submitBtn = document.getElementById('submitFeedback');
    if (submitBtn) {
        submitBtn.addEventListener('click', async function() {
            const mainRating = document.getElementById('starRating').value;
            const feedbackText = document.getElementById('feedbackText').value;
            const contentType = document.getElementById('contentType').value;
            const sessionId = document.getElementById('sessionId').value;
            
            if (mainRating === '0') {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É', 'warning');
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –æ—Ü–µ–Ω–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
            const criteriaRatings = {};
            const criteriaInputs = document.querySelectorAll('#feedbackModal input[name^="criteria_"]');
            criteriaInputs.forEach(input => {
                const criteriaName = input.name.replace('criteria_', '');
                criteriaRatings[criteriaName] = parseInt(input.value);
            });
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const feedbackData = {
                content_type: contentType,
                main_rating: parseInt(mainRating),
                criteria_ratings: criteriaRatings,
                feedback_text: feedbackText,
                session_id: sessionId,
                timestamp: new Date().toISOString()
            };
            
            try {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                const originalText = this.innerHTML;
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
                
                const response = await fetch('/submit_detailed_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(feedbackData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification('–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É! –û–Ω–∞ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.', 'success', 4000);
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏
                    this.classList.add('feedback-submitted');
                    this.innerHTML = '<i class="bi bi-check-circle-fill"></i> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        this.disabled = false;
                        this.innerHTML = originalText;
                        this.classList.remove('feedback-submitted');
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                this.disabled = false;
                this.innerHTML = originalText;
            }
        });
    }
});

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
function showFeedbackButtons() {
    const emotionFeedback = document.getElementById('emotion-feedback');
    if (emotionFeedback) {
        emotionFeedback.style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–æ—Ç–æ–≤–æ–π –º—É–∑—ã–∫–∏
function checkAvailableMusic() {
    console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–æ—Ç–æ–≤–æ–π –º—É–∑—ã–∫–∏...");
    
    fetch('/available_music')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tasks && data.tasks.length > 0) {
                console.log(`–ù–∞–π–¥–µ–Ω–æ ${data.tasks.length} –≥–æ—Ç–æ–≤—ã—Ö –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤`);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –º—É–∑—ã–∫–∏
                const musicSection = document.querySelector('.music-section');
                if (musicSection) {
                    musicSection.style.display = 'block';
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç—Ä–µ–∫
                const latestTrack = data.tasks[0];
                displayGeneratedMusic(latestTrack);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω–∞ –≥–æ—Ç–æ–≤–∞—è –º—É–∑—ã–∫–∞
                const musicContainer = document.getElementById('generated-music-container');
                if (musicContainer) {
                    const notice = document.createElement('div');
                    notice.className = 'alert alert-success mt-2';
                    notice.innerHTML = `
                        <i class="bi bi-music-note"></i>
                        <strong>–ù–∞–π–¥–µ–Ω–∞ –≥–æ—Ç–æ–≤–∞—è –º—É–∑—ã–∫–∞!</strong>
                        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫: "${latestTrack.title}"
                    `;
                    musicContainer.insertBefore(notice, musicContainer.firstChild);
                }
            } else {
                console.log("–ì–æ—Ç–æ–≤–æ–π –º—É–∑—ã–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –≥–æ—Ç–æ–≤–æ–π –º—É–∑—ã–∫–∏:', error);
        });
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–æ–π –º—É–∑—ã–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤—É—é –º—É–∑—ã–∫—É...");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—É—é –≥–æ—Ç–æ–≤—É—é –º—É–∑—ã–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // checkAvailableMusic(); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º—É–∑—ã–∫—É —Å—Ä–∞–∑—É
});

</script>
{% endblock %}